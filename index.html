<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Meus Investimentos</title>

    <!-- Configurações PWA e Mobile -->
    <meta name="theme-color" content="#004aad">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Investimentos">

    <!-- Ícone da Aba e PWA -->
    <link rel="icon" id="app-icon" href="logo.png" type="image/png">
    <link rel="apple-touch-icon" href="logo.png">
    <link rel="manifest" href="manifest.json">

    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Biblioteca para gerar PDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        primary: '#004aad',
                        'primary-dark': '#003882',
                        'primary-light': '#e6f0fa',
                    }
                }
            }
        }
    </script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap');

        body {
            font-family: 'Poppins', sans-serif;
            background-color: #f8fafc;
            -webkit-tap-highlight-color: transparent;
        }

        .card-shadow {
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.03);
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .card-shadow:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(0, 74, 173, 0.05);
        }

        .sidebar-link {
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .sidebar-link.active {
            background-color: #004aad;
            color: white;
            box-shadow: 0 4px 12px rgba(0, 74, 173, 0.3);
        }

        .sidebar-link.active i {
            color: white;
        }

        .sidebar-link:not(.active):hover {
            background-color: #e6f0fa;
            color: #004aad;
        }

        .fade-in {
            animation: fadeIn 0.3s ease-in-out;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(5px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .scale-up-center {
            animation: scale-up-center 0.4s cubic-bezier(0.390, 0.575, 0.565, 1.000) both;
        }

        @keyframes scale-up-center {
            0% {
                transform: scale(0.5);
                opacity: 0;
            }

            100% {
                transform: scale(1);
                opacity: 1;
            }
        }

        .child-row {
            background-color: #f8fafc;
        }

        .child-row td:first-child {
            padding-left: 2rem;
            position: relative;
        }

        .child-row td:first-child::before {
            content: '';
            position: absolute;
            left: 20px;
            top: 50%;
            width: 10px;
            height: 1px;
            background-color: #cbd5e1;
        }

        .child-row td:first-child::after {
            content: '';
            position: absolute;
            left: 20px;
            bottom: 50%;
            width: 1px;
            height: 100%;
            background-color: #cbd5e1;
            top: -50%;
        }

        tr[id^="group-"]:last-child td:first-child::after {
            height: 50%;
            top: 0;
        }

        .rec-tooltip {
            @apply absolute bottom-full mb-2 left-1/2 -translate-x-1/2 bg-slate-800 text-white text-xs py-1 px-2 rounded opacity-0 group-hover:opacity-100 transition-opacity whitespace-nowrap z-50 pointer-events-none;
        }
    </style>
</head>

<body class="text-slate-800 dark:text-slate-100 h-screen flex overflow-hidden bg-slate-50 dark:bg-slate-900">

    <!-- SIDEBAR -->
    <div id="sidebar-overlay" onclick="toggleSidebar()"
        class="fixed inset-0 bg-slate-900/20 backdrop-blur-sm z-40 hidden md:hidden transition-opacity"></div>
    <aside id="main-sidebar"
        class="w-72 bg-white dark:bg-slate-900 flex-col hidden md:flex border-r border-slate-200 dark:border-slate-800 z-50 fixed md:static inset-y-0 left-0 shadow-2xl md:shadow-none transition-transform duration-300">
        <div class="p-8 flex items-center gap-3">
            <div
                class="w-12 h-12 bg-white dark:bg-slate-800 rounded-xl flex items-center justify-center shadow-lg shadow-blue-900/20 overflow-hidden">
                <img src="logo.png" alt="Logo" class="w-full h-full object-cover">
            </div>
            <div>
                <h1 class="font-bold tracking-tight text-slate-800 dark:text-slate-100 flex flex-col leading-none">
                    <span class="text-[10px] text-slate-400 font-bold uppercase tracking-wider">Meus</span>
                    <span class="text-lg text-primary -mt-1">Investimentos</span>
                </h1>
                <p class="text-[10px] text-slate-400 font-medium leading-none">Gerenciador de Ativos</p>
            </div>
        </div>
        <nav class="flex-1 px-6 space-y-2 py-4">
            <p class="text-xs font-bold text-slate-400 uppercase tracking-wider mb-4 px-4">Menu Principal</p>
            <a onclick="navigateTo('dashboard')" id="nav-dashboard"
                class="sidebar-link active flex items-center gap-4 px-4 py-3.5 rounded-xl text-sm font-medium"><i
                    class="fa-solid fa-house text-white/90 w-5 text-center"></i><span>Início</span></a>
            <a onclick="navigateTo('rebalanceamento')" id="nav-rebalanceamento"
                class="sidebar-link text-slate-500 flex items-center gap-4 px-4 py-3.5 rounded-xl text-sm font-medium group"><i
                    class="fa-solid fa-scale-balanced text-slate-400 group-hover:text-primary w-5 text-center transition-colors"></i><span>Rebalanceamento</span></a>
            <a onclick="navigateTo('reserva')" id="nav-reserva"
                class="sidebar-link text-slate-500 flex items-center gap-4 px-4 py-3.5 rounded-xl text-sm font-medium group"><i
                    class="fa-solid fa-shield-halved text-slate-400 group-hover:text-primary w-5 text-center transition-colors"></i><span>Reserva</span></a>
            <a onclick="navigateTo('renda-fixa')" id="nav-renda-fixa"
                class="sidebar-link text-slate-500 flex items-center gap-4 px-4 py-3.5 rounded-xl text-sm font-medium group"><i
                    class="fa-solid fa-percent text-slate-400 group-hover:text-primary w-5 text-center transition-colors"></i><span>Renda
                    Fixa</span></a>
            <a onclick="navigateTo('renda-variavel')" id="nav-renda-variavel"
                class="sidebar-link text-slate-500 flex items-center gap-4 px-4 py-3.5 rounded-xl text-sm font-medium group"><i
                    class="fa-solid fa-arrow-trend-up text-slate-400 group-hover:text-primary w-5 text-center transition-colors"></i><span>Renda
                    Variável</span></a>
            <a onclick="navigateTo('tesouro')" id="nav-tesouro"
                class="sidebar-link text-slate-500 flex items-center gap-4 px-4 py-3.5 rounded-xl text-sm font-medium group"><i
                    class="fa-solid fa-landmark text-slate-400 group-hover:text-primary w-5 text-center transition-colors"></i><span>Tesouro
                    Direto</span></a>
        </nav>
        <div class="p-6 border-t border-slate-100">
            <!-- Settings Button -->
            <button onclick="openSettingsModal()"
                class="w-full mb-3 bg-white hover:bg-slate-50 text-slate-600 border border-slate-200 px-4 py-2.5 rounded-xl text-sm font-semibold transition-all shadow-sm flex items-center justify-center gap-2 transform active:scale-95 group">
                <i class="fa-solid fa-gear text-slate-400 group-hover:text-primary"></i> <span>Configurações</span>
            </button>
            <!-- Export Button -->
            <button onclick="exportToPDF()"
                class="w-full mb-4 bg-white hover:bg-slate-50 text-slate-600 border border-slate-200 px-4 py-2.5 rounded-xl text-sm font-semibold transition-all shadow-sm flex items-center justify-center gap-2 transform active:scale-95 group">
                <i class="fa-solid fa-file-pdf text-red-500 group-hover:text-red-600"></i> <span>Exportar
                    Relatório</span>
            </button>

            <div class="flex items-center gap-3 p-3 rounded-xl bg-slate-50 border border-slate-100">
                <div
                    class="w-10 h-10 rounded-full bg-primary text-white flex items-center justify-center font-bold shadow-md">
                    HS</div>
                <div class="flex-1 overflow-hidden">
                    <p class="text-sm font-bold text-slate-700 truncate">Henrique</p>
                    <p class="text-xs text-slate-500 truncate">hrqsousa@outlook.com</p>
                </div>
            </div>
            <p id="app-version" onclick="handleVersionClick()"
                class="text-[10px] text-slate-300 text-center mt-3 font-medium cursor-pointer select-none transition-colors hover:text-primary">
                Versão 1.5.0</p>
        </div>
    </aside>

    <!-- MAIN CONTENT -->
    <main class="flex-1 flex flex-col h-full relative overflow-y-auto w-full">
        <header class="bg-white/80 backdrop-blur-md sticky top-0 z-40 border-b border-slate-200">
            <div class="flex items-center justify-between px-8 py-5">
                <div class="flex items-center gap-4 md:hidden">
                    <button class="text-slate-500 hover:text-primary" onclick="toggleSidebar()"><i
                            class="fa-solid fa-bars text-xl"></i></button>
                    <span class="font-bold text-lg text-primary">Meus Investimentos</span>
                </div>
                <div class="hidden md:block">
                    <h2 class="text-2xl font-bold text-slate-800" id="page-title">Visão Geral</h2>
                    <p class="text-sm text-slate-500" id="page-subtitle">Bem-vindo de volta.</p>
                </div>
                <div class="flex items-center gap-4">
                    <button onclick="openModal()"
                        class="bg-primary hover:bg-primary-dark text-white px-5 py-2.5 rounded-xl text-sm font-semibold transition-all shadow-lg shadow-blue-500/30 flex items-center gap-2 transform active:scale-95"><i
                            class="fa-solid fa-plus"></i><span class="hidden sm:inline">Novo Aporte</span></button>
                </div>
            </div>
        </header>

        <div class="p-4 md:p-8 max-w-7xl mx-auto w-full relative">

            <!-- DASHBOARD -->
            <div id="view-dashboard" class="space-y-8 fade-in">
                <div class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-4 gap-6">
                    <div class="bg-white p-6 rounded-2xl card-shadow border border-slate-100 relative group">
                        <div
                            class="absolute right-0 top-0 w-32 h-32 bg-primary/5 rounded-full -mr-10 -mt-10 transition-transform group-hover:scale-110">
                        </div>
                        <div class="relative z-10">
                            <p class="text-sm font-medium text-slate-500 mb-1">Patrimônio Total</p>
                            <h3 class="text-3xl font-bold text-slate-800" id="dash-total-balance">Carregando...</h3>
                        </div>
                    </div>
                    <div class="bg-white p-6 rounded-2xl card-shadow border border-slate-100 relative group">
                        <div
                            class="absolute right-0 top-0 w-32 h-32 bg-emerald-50 rounded-full -mr-10 -mt-10 transition-transform group-hover:scale-110">
                        </div>
                        <div class="relative z-10">
                            <p class="text-sm font-medium text-slate-500 mb-1">Lucro Acumulado</p>
                            <div class="flex flex-col items-start gap-1">
                                <h3 class="text-3xl font-bold text-slate-800" id="dash-total-profit">R$ 0,00</h3><span
                                    class="text-sm font-bold px-2 py-0.5 rounded-lg bg-emerald-100 text-emerald-700"
                                    id="dash-total-profit-perc">+0,00%</span>
                            </div>
                        </div>
                    </div>
                    <!-- Meta Anual -->
                    <div class="bg-primary text-white p-6 rounded-2xl card-shadow relative overflow-hidden group">
                        <div
                            class="absolute right-0 bottom-0 w-32 h-32 bg-white/10 rounded-full translate-x-10 translate-y-10 transition-transform group-hover:scale-110">
                        </div>
                        <div class="absolute z-20 top-4 right-4 cursor-pointer hover:bg-white/20 p-2 rounded-full transition-colors"
                            onclick="openGoalModal()" title="Editar Meta"><i
                                class="fa-solid fa-pen text-xs text-white/80"></i></div>
                        <div class="relative z-10" id="goal-card-content">
                            <p class="text-primary-light text-sm font-medium mb-1">Meta Anual</p>
                            <div class="h-20 flex items-center justify-center">
                                <p class="text-lg font-medium opacity-80">Carregando...</p>
                            </div>
                        </div>
                    </div>
                    <!-- Meta Proventos -->
                    <div class="bg-primary text-white p-6 rounded-2xl card-shadow relative overflow-hidden group">
                        <div
                            class="absolute right-0 bottom-0 w-32 h-32 bg-white/10 rounded-full translate-x-10 translate-y-10 transition-transform group-hover:scale-110">
                        </div>
                        <div class="absolute z-20 top-4 right-4 cursor-pointer hover:bg-white/20 p-2 rounded-full transition-colors"
                            onclick="openProventosGoalModal()" title="Editar Meta Proventos"><i
                                class="fa-solid fa-pen text-xs text-white/80"></i></div>
                        <div class="relative z-10" id="proventos-goal-card-content">
                            <p class="text-primary-light text-sm font-medium mb-1">Meta de Proventos</p>
                            <div class="h-20 flex items-center justify-center">
                                <p class="text-lg font-medium opacity-80">Carregando...</p>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="grid grid-cols-1 xl:grid-cols-3 gap-8">
                    <div class="xl:col-span-1 bg-white p-6 rounded-2xl card-shadow border border-slate-100 h-full">
                        <h3 class="font-bold text-slate-800 mb-6">Alocação</h3>
                        <div class="relative h-64 w-full"><canvas id="allocationChart"></canvas></div>
                        <div class="mt-6" id="chart-legend"></div>
                    </div>
                    <div class="xl:col-span-2 bg-white rounded-2xl card-shadow border border-slate-100 overflow-hidden">
                        <div class="p-6 border-b border-slate-100">
                            <h3 class="font-bold text-slate-800">Top 10 - Maior Rentabilidade</h3>
                        </div>
                        <div class="overflow-x-auto">
                            <table class="w-full text-left border-collapse">
                                <thead>
                                    <tr class="bg-slate-50/50 text-slate-400 text-xs uppercase">
                                        <th class="px-6 py-4 w-10 text-center">#</th>
                                        <th class="px-6 py-4">Ativo</th>
                                        <th class="px-6 py-4">Cat.</th>
                                        <th class="px-6 py-4 text-right">Rent.</th>
                                    </tr>
                                </thead>
                                <tbody id="dash-assets-body" class="text-sm text-slate-600 divide-y divide-slate-50">
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Top 5 Dividend Payers -->
                <div class="bg-white rounded-2xl card-shadow border border-slate-100 overflow-hidden mt-8">
                    <div
                        class="p-6 border-b border-slate-100 flex flex-col md:flex-row md:items-center justify-between gap-4">
                        <h3 class="font-bold text-slate-800" id="top-dividend-card-title">Top 7 - Maiores Pagadores (12
                            Meses)</h3>
                        <div class="flex bg-slate-100 p-1 rounded-lg">
                            <button onclick="renderTopDividendPayers('all')"
                                class="flex-1 px-3 py-1.5 rounded-md text-xs font-bold transition-all bg-white text-slate-800 shadow-sm"
                                id="btn-top-div-all">Todos</button>
                            <button onclick="renderTopDividendPayers('Ação')"
                                class="flex-1 px-3 py-1.5 rounded-md text-xs font-medium transition-all text-slate-500 hover:text-slate-700"
                                id="btn-top-div-acao">Ações</button>
                            <button onclick="renderTopDividendPayers('FII')"
                                class="flex-1 px-3 py-1.5 rounded-md text-xs font-medium transition-all text-slate-500 hover:text-slate-700"
                                id="btn-top-div-fii">FIIs</button>
                            <button onclick="renderTopDividendPayers('Exterior')"
                                class="flex-1 px-3 py-1.5 rounded-md text-xs font-medium transition-all text-slate-500 hover:text-slate-700"
                                id="btn-top-div-exterior">Ext</button>
                        </div>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="w-full text-left border-collapse">
                            <thead>
                                <tr class="bg-slate-50/50 text-slate-400 text-xs uppercase">
                                    <th class="px-6 py-4 w-10 text-center">#</th>
                                    <th class="px-6 py-4">Ativo</th>
                                    <th class="px-6 py-4">Cat.</th>
                                    <th class="px-6 py-4 text-right">Total (12m)</th>
                                </tr>
                            </thead>
                            <tbody id="top-dividend-body" class="text-sm text-slate-600 divide-y divide-slate-50">
                            </tbody>
                        </table>
                    </div>
                </div>

            </div>

            <!-- RESERVA -->
            <div id="view-reserva" class="hidden space-y-8 fade-in">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                    <div class="bg-white p-6 rounded-2xl card-shadow border border-slate-100 flex justify-between">
                        <div>
                            <p class="text-sm font-medium text-slate-500 mb-1">Total</p>
                            <h3 class="text-3xl font-bold text-slate-800" id="reserva-total">R$ 0,00</h3>
                        </div>
                        <div class="text-primary text-2xl"><i class="fa-solid fa-shield-halved"></i></div>
                    </div>
                    <div class="bg-white p-6 rounded-2xl card-shadow border border-slate-100 flex justify-between">
                        <div>
                            <p class="text-sm font-medium text-slate-500 mb-1">Rentabilidade</p>
                            <h3 class="text-3xl font-bold text-emerald-600" id="reserva-profit">R$ 0,00</h3><span
                                class="text-sm font-medium text-emerald-600 bg-emerald-50 px-2 rounded"
                                id="reserva-profit-perc">+0%</span>
                        </div>
                        <div class="text-emerald-600 text-2xl"><i class="fa-solid fa-chart-line"></i></div>
                    </div>
                </div>
                <div class="bg-white rounded-2xl card-shadow border border-slate-100 overflow-hidden">
                    <div class="p-6 border-b border-slate-100 flex justify-between items-center">
                        <h3 class="font-bold text-slate-800 flex items-center gap-2"><span
                                class="w-1 h-6 bg-primary rounded-full"></span>Títulos da Reserva</h3>
                        <div class="flex gap-2"><button onclick="openUpdateBalancesModal()"
                                class="text-sm font-medium text-slate-500 hover:text-primary bg-slate-50 px-3 py-2 rounded-lg flex items-center gap-2"><i
                                    class="fa-solid fa-rotate"></i> Atualizar Saldos</button><button
                                onclick="navigateTo('historico')"
                                class="text-sm font-medium text-slate-500 hover:text-primary bg-slate-50 px-3 py-2 rounded-lg flex items-center gap-2"><i
                                    class="fa-solid fa-clock-rotate-left"></i> Histórico</button></div>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="w-full text-left border-collapse whitespace-nowrap">
                            <thead>
                                <tr class="bg-slate-50/50 text-slate-400 text-xs uppercase">
                                    <th class="px-6 py-4 pl-6">Tipo</th>
                                    <th class="px-6 py-4">Emissor</th>
                                    <th class="px-6 py-4">Vencimento</th>
                                    <th class="px-6 py-4 text-center">Dias</th>
                                    <th class="px-6 py-4 text-right">Investido</th>
                                    <th class="px-6 py-4 text-center">Taxa</th>
                                    <th class="px-6 py-4">Corretora</th>
                                    <th class="px-6 py-4 text-right">Atual</th>
                                    <th class="px-6 py-4 text-right">Rend.</th>
                                    <th class="px-6 py-4 text-center pr-6">Ações</th>
                                </tr>
                            </thead>
                            <tbody id="reserva-table-body" class="text-sm text-slate-600 divide-y divide-slate-50">
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- RENDA FIXA -->
            <div id="view-renda-fixa" class="hidden space-y-8 fade-in">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="bg-white p-6 rounded-2xl card-shadow border border-slate-100 flex justify-between">
                        <div>
                            <p class="text-sm font-medium text-slate-500 mb-1">Total</p>
                            <h3 class="text-3xl font-bold text-slate-800" id="renda-fixa-total">R$ 0,00</h3>
                        </div>
                        <div class="text-purple-600 text-2xl"><i class="fa-solid fa-percent"></i></div>
                    </div>
                    <div class="bg-white p-6 rounded-2xl card-shadow border border-slate-100 flex justify-between">
                        <div>
                            <p class="text-sm font-medium text-slate-500 mb-1">Rentabilidade</p>
                            <h3 class="text-3xl font-bold text-emerald-600" id="renda-fixa-profit">R$ 0,00</h3><span
                                class="text-sm font-medium text-emerald-600 bg-emerald-50 px-2 rounded"
                                id="renda-fixa-profit-perc">+0%</span>
                        </div>
                        <div class="text-emerald-600 text-2xl"><i class="fa-solid fa-chart-line"></i></div>
                    </div>
                </div>
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <div class="bg-white p-6 rounded-2xl card-shadow border border-slate-100">
                        <h3 class="font-bold text-slate-800 mb-4">Bond Ladder</h3>
                        <div class="relative h-40 w-full"><canvas id="bondLadderChart"></canvas></div>
                    </div>
                    <div class="bg-white p-6 rounded-2xl card-shadow border border-slate-100">
                        <h3 class="font-bold text-slate-800 mb-4">Indexadores</h3>
                        <div class="relative h-40 w-full flex justify-center"><canvas id="indexerChart"></canvas>
                        </div>
                    </div>
                </div>
                <div class="bg-white rounded-2xl card-shadow border border-slate-100 overflow-hidden">
                    <div class="p-6 border-b border-slate-100 flex justify-between items-center">
                        <h3 class="font-bold text-slate-800 flex items-center gap-2"><span
                                class="w-1 h-6 bg-primary rounded-full"></span>Títulos</h3>
                        <div class="flex gap-2"><button onclick="openUpdateBalancesModal()"
                                class="text-sm font-medium text-slate-500 hover:text-primary bg-slate-50 px-3 py-2 rounded-lg"><i
                                    class="fa-solid fa-rotate"></i> Atualizar Saldos</button><button
                                onclick="navigateTo('historico')"
                                class="text-sm font-medium text-slate-500 hover:text-primary bg-slate-50 px-3 py-2 rounded-lg"><i
                                    class="fa-solid fa-clock-rotate-left"></i> Histórico</button></div>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="w-full text-left border-collapse whitespace-nowrap">
                            <thead>
                                <tr class="bg-slate-50/50 text-slate-400 text-xs uppercase">
                                    <th class="px-6 py-4 pl-6">Tipo</th>
                                    <th class="px-6 py-4">Emissor</th>
                                    <th class="px-6 py-4">Vencimento</th>
                                    <th class="px-6 py-4 text-center">Dias</th>
                                    <th class="px-6 py-4 text-right">Investido</th>
                                    <th class="px-6 py-4 text-center">Taxa</th>
                                    <th class="px-6 py-4">Corretora</th>
                                    <th class="px-6 py-4 text-right">Atual</th>
                                    <th class="px-6 py-4 text-right">Rend.</th>
                                    <th class="px-6 py-4 text-center pr-6">Ações</th>
                                </tr>
                            </thead>
                            <tbody id="renda-fixa-table-body" class="text-sm text-slate-600 divide-y divide-slate-50">
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- RENDA VARIÁVEL -->
            <div id="view-renda-variavel" class="hidden space-y-8 fade-in">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <div class="bg-white p-6 rounded-2xl card-shadow border border-slate-100 flex justify-between">
                        <div>
                            <p class="text-sm font-medium text-slate-500 mb-1">Total</p>
                            <h3 class="text-3xl font-bold text-slate-800" id="rv-total">R$ 0,00</h3>
                        </div>
                        <div class="text-indigo-600 text-2xl"><i class="fa-solid fa-arrow-trend-up"></i></div>
                    </div>
                    <div class="bg-white p-6 rounded-2xl card-shadow border border-slate-100 flex justify-between">
                        <div>
                            <p class="text-sm font-medium text-slate-500 mb-1">Rentabilidade</p>
                            <h3 class="text-3xl font-bold text-emerald-600" id="rv-profit">R$ 0,00</h3><span
                                class="text-sm text-emerald-600" id="rv-profit-perc">+0%</span>
                        </div>
                        <div class="text-emerald-600 text-2xl"><i class="fa-solid fa-chart-line"></i></div>
                    </div>
                    <!-- New Card: Média Proventos -->
                    <div class="bg-white p-6 rounded-2xl card-shadow border border-slate-100 flex justify-between">
                        <div>
                            <p class="text-sm font-medium text-slate-500 mb-1">Média Proventos (12m)</p>
                            <h3 class="text-3xl font-bold text-amber-600" id="rv-avg-prov">R$ 0,00</h3>
                        </div>
                        <div class="text-amber-500 text-2xl"><i class="fa-solid fa-coins"></i></div>
                    </div>
                </div>
                <div class="bg-white rounded-2xl card-shadow border border-slate-100 overflow-hidden">
                    <div
                        class="p-6 border-b border-slate-100 flex flex-col md:flex-row justify-between items-center gap-4">
                        <h3 class="font-bold text-slate-800 flex items-center gap-2"><span
                                class="w-1 h-6 bg-primary rounded-full"></span>Meus Ativos</h3>
                        <div class="flex gap-2 overflow-x-auto"><button onclick="renderRendaVariavel('all')"
                                class="rv-filter-btn bg-primary text-white px-3 py-1.5 rounded-lg text-xs font-bold">Todos</button><button
                                onclick="renderRendaVariavel('Ação')"
                                class="rv-filter-btn bg-slate-100 text-slate-600 px-3 py-1.5 rounded-lg text-xs font-medium">Ações</button><button
                                onclick="renderRendaVariavel('FII')"
                                class="rv-filter-btn bg-slate-100 text-slate-600 px-3 py-1.5 rounded-lg text-xs font-medium">FIIs</button><button
                                onclick="renderRendaVariavel('Exterior')"
                                class="rv-filter-btn bg-slate-100 text-slate-600 px-3 py-1.5 rounded-lg text-xs font-medium">Exterior</button><button
                                onclick="renderRendaVariavel('Cripto')"
                                class="rv-filter-btn bg-slate-100 text-slate-600 px-3 py-1.5 rounded-lg text-xs font-medium">Cripto</button>
                        </div>
                        <div class="flex gap-2"><button onclick="navigateTo('proventos')"
                                class="text-sm font-bold text-emerald-600 hover:text-emerald-700 bg-emerald-50 hover:bg-emerald-100 px-3 py-2 rounded-lg flex items-center gap-2 transition-colors border border-emerald-200 shadow-sm"><i
                                    class="fa-solid fa-hand-holding-dollar"></i> Proventos</button><button
                                onclick="openUpdateBalancesModal()"
                                class="text-sm font-medium text-slate-500 hover:text-primary bg-slate-50 px-3 py-2 rounded-lg flex items-center gap-2"><i
                                    class="fa-solid fa-rotate"></i> Cotações</button><button
                                onclick="navigateTo('historico')"
                                class="text-sm font-medium text-slate-500 hover:text-primary bg-slate-50 px-3 py-2 rounded-lg flex items-center gap-2"><i
                                    class="fa-solid fa-clock-rotate-left"></i> Histórico</button></div>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="w-full text-left border-collapse whitespace-nowrap">
                            <thead>
                                <tr class="bg-slate-50/50 text-slate-400 text-xs uppercase">
                                    <th class="px-6 py-4 pl-6">Ativo</th>
                                    <th class="px-6 py-4 text-center">Meta %</th>
                                    <th class="px-6 py-4 text-right">Qtd</th>
                                    <th class="px-6 py-4 text-right">PM / Atual</th>
                                    <th class="px-6 py-4 text-right">Saldo</th>
                                    <th class="px-6 py-4 text-right">Rend.</th>
                                    <th class="px-6 py-4 text-center">Recomendação</th>
                                    <th class="px-6 py-4 text-center pr-6">Ações</th>
                                </tr>
                            </thead>
                            <tbody id="rv-table-body" class="text-sm text-slate-600 divide-y divide-slate-50">
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- TESOURO -->
            <div id="view-tesouro" class="hidden space-y-8 fade-in">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="bg-white p-6 rounded-2xl card-shadow border border-slate-100 flex justify-between">
                        <div>
                            <p class="text-sm font-medium text-slate-500 mb-1">Total</p>
                            <h3 class="text-3xl font-bold text-slate-800" id="tesouro-total">R$ 0,00</h3>
                        </div>
                        <div class="text-yellow-600 text-2xl"><i class="fa-solid fa-landmark"></i></div>
                    </div>
                    <div class="bg-white p-6 rounded-2xl card-shadow border border-slate-100 flex justify-between">
                        <div>
                            <p class="text-sm font-medium text-slate-500 mb-1">Rentabilidade</p>
                            <h3 class="text-3xl font-bold text-emerald-600" id="tesouro-profit">R$ 0,00</h3><span
                                class="text-sm text-emerald-600" id="tesouro-profit-perc">+0%</span>
                        </div>
                        <div class="text-emerald-600 text-2xl"><i class="fa-solid fa-chart-line"></i></div>
                    </div>
                </div>
                <div class="bg-white rounded-2xl card-shadow border border-slate-100 overflow-hidden">
                    <div
                        class="p-6 border-b border-slate-100 flex flex-col md:flex-row justify-between items-center gap-4">
                        <h3 class="font-bold text-slate-800 flex items-center gap-2"><span
                                class="w-1 h-6 bg-primary rounded-full"></span>Títulos do Tesouro</h3>
                        <div class="flex gap-2 overflow-x-auto">
                            <button onclick="renderTesouro('all')"
                                class="tesouro-filter-btn bg-primary text-white px-3 py-1.5 rounded-lg text-xs font-bold">Todos</button>
                            <button onclick="renderTesouro('Selic')"
                                class="tesouro-filter-btn bg-slate-100 text-slate-600 px-3 py-1.5 rounded-lg text-xs font-medium">Selic</button>
                            <button onclick="renderTesouro('IPCA')"
                                class="tesouro-filter-btn bg-slate-100 text-slate-600 px-3 py-1.5 rounded-lg text-xs font-medium">IPCA+</button>
                            <button onclick="renderTesouro('Renda+')"
                                class="tesouro-filter-btn bg-slate-100 text-slate-600 px-3 py-1.5 rounded-lg text-xs font-medium">Renda+</button>
                            <button onclick="renderTesouro('Prefixado')"
                                class="tesouro-filter-btn bg-slate-100 text-slate-600 px-3 py-1.5 rounded-lg text-xs font-medium">Pré-fixado</button>
                        </div>
                        <div class="flex gap-2"><button onclick="openUpdateBalancesModal()"
                                class="text-sm font-medium text-slate-500 hover:text-primary bg-slate-50 px-3 py-2 rounded-lg flex items-center gap-2"><i
                                    class="fa-solid fa-rotate"></i> Atualizar Saldos</button><button
                                onclick="navigateTo('historico')"
                                class="text-sm font-medium text-slate-500 hover:text-primary bg-slate-50 px-3 py-2 rounded-lg flex items-center gap-2"><i
                                    class="fa-solid fa-clock-rotate-left"></i> Histórico</button></div>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="w-full text-left border-collapse whitespace-nowrap">
                            <thead>
                                <tr class="bg-slate-50/50 text-slate-400 text-xs uppercase">
                                    <th class="px-6 py-4 pl-6">Título</th>
                                    <th class="px-6 py-4 text-center">Qtd</th>
                                    <th class="px-6 py-4">Vencimento</th>
                                    <th class="px-6 py-4 text-center">Dias</th>
                                    <th class="px-6 py-4 text-right">Investido</th>
                                    <th class="px-6 py-4 text-right">Atual</th>
                                    <th class="px-6 py-4 text-right">Rend.</th>
                                    <th class="px-6 py-4 text-center pr-6">Ações</th>
                                </tr>
                            </thead>
                            <tbody id="tesouro-table-body" class="text-sm text-slate-600 divide-y divide-slate-50">
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- HISTÓRICO -->
            <div id="view-historico" class="hidden space-y-8 fade-in">
                <!-- Toolbar: Busca e Filtros -->
                <div
                    class="flex flex-col md:flex-row gap-4 justify-between items-center bg-white p-4 rounded-2xl card-shadow border border-slate-100">
                    <div class="flex gap-2 w-full md:w-auto overflow-x-auto pb-1 md:pb-0">
                        <button onclick="renderHistorico('all')"
                            class="hist-filter-btn bg-primary text-white px-4 py-2 rounded-lg text-sm font-bold transition-all whitespace-nowrap">Todos</button>
                        <button onclick="renderHistorico('reserva')"
                            class="hist-filter-btn bg-slate-100 text-slate-600 hover:bg-slate-200 px-4 py-2 rounded-lg text-sm font-medium transition-all whitespace-nowrap">Reserva</button>
                        <button onclick="renderHistorico('renda-fixa')"
                            class="hist-filter-btn bg-slate-100 text-slate-600 hover:bg-slate-200 px-4 py-2 rounded-lg text-sm font-medium transition-all whitespace-nowrap">Renda
                            Fixa</button>
                        <button onclick="renderHistorico('tesouro')"
                            class="hist-filter-btn bg-slate-100 text-slate-600 hover:bg-slate-200 px-4 py-2 rounded-lg text-sm font-medium transition-all whitespace-nowrap">Tesouro</button>
                        <button onclick="renderHistorico('renda-variavel')"
                            class="hist-filter-btn bg-slate-100 text-slate-600 hover:bg-slate-200 px-4 py-2 rounded-lg text-sm font-medium transition-all whitespace-nowrap">Renda
                            Variável</button>
                    </div>
                    <div class="flex gap-3 w-full md:w-auto">
                        <div class="relative w-full md:w-64">
                            <i class="fa-solid fa-magnifying-glass absolute left-4 top-3 text-slate-400"></i>
                            <input type="text" id="hist-search"
                                oninput="renderHistorico(window.currentHistFilter, this.value)"
                                placeholder="Buscar ativo..."
                                class="w-full pl-10 pr-4 py-2 rounded-lg border border-slate-200 focus:border-primary outline-none text-sm transition-colors">
                        </div>
                        <button id="btn-voltar-historico" onclick="navigateTo('reserva')"
                            class="bg-slate-100 text-slate-600 hover:bg-slate-200 px-4 py-2 rounded-lg text-sm font-medium transition-colors flex items-center gap-2">
                            <i class="fa-solid fa-arrow-left"></i> Voltar
                        </button>
                    </div>
                </div>
                <div class="bg-white rounded-2xl card-shadow border border-slate-100 overflow-hidden">
                    <div class="overflow-x-auto">
                        <table class="w-full text-left border-collapse whitespace-nowrap">
                            <thead>
                                <tr class="bg-slate-50/50 text-slate-400 text-xs uppercase">
                                    <th class="px-6 py-4 pl-6">Data Liq.</th>
                                    <th class="px-6 py-4">Tipo</th>
                                    <th class="px-6 py-4">Emissor</th>
                                    <th class="px-6 py-4 text-right">Investido</th>
                                    <th class="px-6 py-4 text-right">Final</th>
                                    <th class="px-6 py-4 text-right">Rend.</th>
                                    <th class="px-6 py-4 text-center">Tipo Liq.</th>
                                </tr>
                            </thead>
                            <tbody id="historico-table-body" class="text-sm text-slate-600 divide-y divide-slate-50">
                            </tbody>
                        </table>
                    </div>
                </div>
                <div id="historico-empty" class="hidden text-center py-10 text-slate-400">Nenhum
                    título liquidado.</div>
            </div>

            <!-- PROVENTOS (NOVO) -->
            <div id="view-proventos" class="hidden space-y-8 fade-in">
                <!-- Cards de Resumo -->
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-5 gap-4">
                    <!-- Total -->
                    <div class="bg-white p-5 rounded-2xl card-shadow border border-slate-100 relative overflow-hidden">
                        <div class="relative z-10">
                            <p class="text-xs font-bold text-slate-500 uppercase tracking-wider mb-1">Total Recebido
                            </p>
                            <h3 class="text-2xl font-bold text-slate-800" id="prov-total">R$ 0,00</h3>
                        </div>
                        <div class="absolute right-4 top-4 text-slate-100 text-6xl -z-0 transform rotate-12"><i
                                class="fa-solid fa-landmark"></i></div>
                    </div>
                    <!-- 12 Meses -->
                    <div class="bg-white p-5 rounded-2xl card-shadow border border-slate-100 relative overflow-hidden">
                        <div class="relative z-10">
                            <p class="text-xs font-bold text-slate-500 uppercase tracking-wider mb-1">Últimos 12
                                Meses
                            </p>
                            <h3 class="text-2xl font-bold text-indigo-600" id="prov-12m">R$ 0,00</h3>
                        </div>
                        <div class="absolute right-4 top-4 text-indigo-50 text-6xl -z-0 transform rotate-12"><i
                                class="fa-regular fa-calendar-check"></i></div>
                    </div>
                    <!-- Este Ano -->
                    <div class="bg-white p-5 rounded-2xl card-shadow border border-slate-100 relative overflow-hidden">
                        <div class="relative z-10">
                            <p class="text-xs font-bold text-slate-500 uppercase tracking-wider mb-1">Este Ano (YTD)
                            </p>
                            <h3 class="text-2xl font-bold text-emerald-600" id="prov-ytd">R$ 0,00</h3>
                        </div>
                        <div class="absolute right-4 top-4 text-emerald-50 text-6xl -z-0 transform rotate-12"><i
                                class="fa-solid fa-calendar-days"></i></div>
                    </div>
                    <!-- Mês Passado -->
                    <div class="bg-white p-5 rounded-2xl card-shadow border border-slate-100 relative overflow-hidden">
                        <div class="relative z-10">
                            <p class="text-xs font-bold text-slate-500 uppercase tracking-wider mb-1">Mês Passado
                            </p>
                            <h3 class="text-2xl font-bold text-slate-600" id="prov-last-month">R$ 0,00</h3>
                        </div>
                        <div class="absolute right-4 top-4 text-slate-50 text-6xl -z-0 transform rotate-12"><i
                                class="fa-solid fa-backward"></i></div>
                    </div>
                    <!-- Este Mês -->
                    <div class="bg-white p-5 rounded-2xl card-shadow border border-slate-100 relative overflow-hidden">
                        <div class="relative z-10">
                            <p class="text-xs font-bold text-slate-500 uppercase tracking-wider mb-1">Este Mês</p>
                            <div class="flex items-end gap-2">
                                <h3 class="text-2xl font-bold text-orange-600" id="prov-this-month">R$ 0,00</h3>
                                <span id="prov-month-change"
                                    class="text-xs font-bold px-1.5 py-0.5 rounded bg-slate-100 text-slate-500 mb-1">...</span>
                            </div>
                        </div>
                        <div class="absolute right-4 top-4 text-orange-50 text-6xl -z-0 transform rotate-12"><i
                                class="fa-regular fa-calendar-plus"></i></div>
                    </div>
                </div>



                <!-- Charts Section -->
                <div class="bg-white rounded-2xl card-shadow border border-slate-100 p-6 mb-8 mt-6">
                    <div class="flex flex-col md:flex-row justify-between items-center gap-4 mb-6">
                        <h3 class="font-bold text-slate-800 flex items-center gap-2">
                            <i class="fa-solid fa-chart-simple text-blue-600"></i> Evolução e Composição
                        </h3>
                        <div class="flex flex-wrap gap-2">
                            <!-- Grouping Control -->
                            <select id="chart-grouping" onchange="window.renderProventosCharts()"
                                class="bg-slate-50 border border-slate-200 text-slate-700 text-xs font-bold rounded-lg focus:ring-blue-500 focus:border-blue-500 block p-2">
                                <option value="monthly" selected>Mensal</option>
                                <option value="quarterly">Trimestral</option>
                                <option value="semiannual">Semestral</option>
                                <option value="annual">Anual</option>
                            </select>
                            <!-- Range Control -->
                            <select id="chart-range" onchange="window.renderProventosCharts()"
                                class="bg-slate-50 border border-slate-200 text-slate-700 text-xs font-bold rounded-lg focus:ring-blue-500 focus:border-blue-500 block p-2">
                                <option value="6m">6 Meses</option>
                                <option value="1y" selected>1 Ano</option>
                                <option value="2y">2 Anos</option>
                                <option value="5y">5 Anos</option>
                                <option value="all">Tudo</option>
                            </select>
                        </div>
                    </div>

                    <!-- Main Chart -->
                    <div class="h-64 mb-8 w-full">
                        <canvas id="proventos-main-chart"></canvas>
                    </div>

                    <!-- Composition Chart Section (Horizontal Bar) -->
                    <div class="border-t border-slate-100 pt-6">
                        <h3 class="font-bold text-slate-800 mb-4 text-sm uppercase tracking-wider">Proventos por
                            Categoria
                        </h3>
                        <div class="flex flex-col gap-2">
                            <!-- Legend / Values -->
                            <div class="flex justify-between text-xs font-bold uppercase tracking-wider mb-1"
                                id="chart-comp-legend">
                                <!-- Populated by JS -->
                            </div>
                            <!-- Horizontal Chart -->
                            <div class="h-8 w-full rounded-full overflow-hidden relative bg-slate-100">
                                <canvas id="proventos-composition-chart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Tabela e Ações -->
                <div class="bg-white rounded-2xl card-shadow border border-slate-100 overflow-hidden">
                    <div
                        class="p-6 border-b border-slate-100 flex flex-col md:flex-row justify-between items-center gap-4">
                        <div class="flex flex-col gap-4 w-full md:w-auto">
                            <h3 class="font-bold text-slate-800 flex items-center gap-2"><span
                                    class="w-1 h-6 bg-emerald-500 rounded-full"></span>Histórico de Proventos</h3>
                            <!-- Filtros -->
                            <div class="flex gap-2 overflow-x-auto pb-1 md:pb-0">
                                <button onclick="renderProventos('all')"
                                    class="prov-filter-btn bg-emerald-600 text-white px-3 py-1.5 rounded-lg text-xs font-bold transition-all shadow-sm ring-2 ring-emerald-600 ring-offset-1">Todos</button>
                                <button onclick="renderProventos('Ação')"
                                    class="prov-filter-btn bg-slate-50 text-slate-500 hover:bg-slate-100 px-3 py-1.5 rounded-lg text-xs font-bold transition-all">Ações</button>
                                <button onclick="renderProventos('FII')"
                                    class="prov-filter-btn bg-slate-50 text-slate-500 hover:bg-slate-100 px-3 py-1.5 rounded-lg text-xs font-bold transition-all">FIIs</button>
                                <button onclick="renderProventos('Exterior')"
                                    class="prov-filter-btn bg-slate-50 text-slate-500 hover:bg-slate-100 px-3 py-1.5 rounded-lg text-xs font-bold transition-all">Exterior</button>
                            </div>
                        </div>
                        <div class="flex gap-2">
                            <button onclick="navigateTo('renda-variavel')"
                                class="text-sm font-medium text-slate-500 hover:text-primary bg-slate-50 px-4 py-2 rounded-lg flex items-center gap-2 transition-colors">
                                <i class="fa-solid fa-arrow-left"></i> Voltar
                            </button>
                            <button onclick="resetProventosForm(); openProventosModal()"
                                class="text-sm font-bold text-white bg-emerald-600 hover:bg-emerald-700 px-4 py-2 rounded-lg flex items-center gap-2 transition-colors shadow-sm shadow-emerald-200">
                                <i class="fa-solid fa-plus"></i> Inserir Proventos
                            </button>
                        </div>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="w-full text-left border-collapse whitespace-nowrap">
                            <thead>
                                <tr class="bg-slate-50/50 text-slate-400 text-xs uppercase">
                                    <th class="px-6 py-4 pl-6">Data</th>
                                    <th class="px-6 py-4">Ativo</th>
                                    <th class="px-6 py-4">Categoria</th>
                                    <th class="px-6 py-4">Evento</th>
                                    <th class="px-6 py-4 text-right pr-6">Valor Recebido</th>
                                    <th class="px-6 py-4 text-center pr-6">Ações</th>
                                </tr>
                            </thead>
                            <tbody id="proventos-table-body" class="text-sm text-slate-600 divide-y divide-slate-50">
                                <!-- Preenchido via JS -->
                            </tbody>
                        </table>
                        <div id="proventos-empty-state" class="hidden py-12 text-center text-slate-400">
                            <i class="fa-solid fa-piggy-bank text-4xl mb-3 opacity-20"></i>
                            <p>Nenhum provento registrado ainda.</p>
                        </div>
                    </div>
                    <!-- Pagination Controls -->
                    <div id="proventos-pagination"
                        class="hidden flex justify-center items-center gap-4 py-6 border-t border-slate-50">
                        <button id="prov-prev-page"
                            class="w-10 h-10 rounded-lg flex items-center justify-center bg-white border border-slate-200 text-slate-500 hover:bg-slate-50 disabled:opacity-50 disabled:cursor-not-allowed transition-all">
                            <i class="fa-solid fa-chevron-left"></i>
                        </button>
                        <span id="prov-page-info" class="text-sm font-bold text-slate-600">Página 1 de 1</span>
                        <button id="prov-next-page"
                            class="w-10 h-10 rounded-lg flex items-center justify-center bg-white border border-slate-200 text-slate-500 hover:bg-slate-50 disabled:opacity-50 disabled:cursor-not-allowed transition-all">
                            <i class="fa-solid fa-chevron-right"></i>
                        </button>
                    </div>
                </div>
            </div>

            <!-- REBALANCEAMENTO -->
            <div id="view-rebalanceamento" class="hidden space-y-8 fade-in">
                <div
                    class="bg-white dark:bg-slate-800 rounded-2xl card-shadow border border-slate-100 dark:border-slate-700 p-6">
                    <div class="flex flex-col md:flex-row justify-between items-end gap-6">
                        <div class="w-full md:w-1/3"><label
                                class="block text-xs font-bold text-slate-500 uppercase tracking-wider mb-2">Caixa
                                Disponível para Aporte</label>
                            <div class="relative"><span
                                    class="absolute left-4 top-3.5 text-slate-400 font-bold">R$</span><input type="text"
                                    inputmode="numeric" id="reb-caixa" value="0,00" oninput="formatCurrencyInput(this)"
                                    onchange="window.firebaseSaveCash(window.parseCurrencyValue(this.value)); renderRebalanceamento(); renderRendaVariavel();"
                                    class="w-full pl-10 pr-4 py-3 rounded-xl border border-slate-300 dark:border-slate-600 focus:border-primary focus:ring-4 focus:ring-primary/10 outline-none transition-all font-bold text-slate-800 dark:text-slate-100 text-xl bg-white dark:bg-slate-900">
                            </div>
                        </div>
                        <div class="flex gap-8 text-right">
                            <div>
                                <p class="text-xs text-slate-400">Patrimônio Atual</p>
                                <h4 class="text-lg font-bold text-slate-800 dark:text-slate-100"
                                    id="reb-total-patrimony">R$ 0,00</h4>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="space-y-4" id="rebalance-container"></div>
            </div>
        </div>
    </main>

    <!-- MODAIS -->
    <!-- MODAL PROVENTOS -->
    <div id="proventos-modal"
        class="fixed inset-0 bg-slate-900/60 z-[70] hidden flex items-center justify-center backdrop-blur-sm transition-opacity opacity-0">
        <div class="bg-white dark:bg-slate-800 rounded-2xl shadow-2xl p-6 w-full max-w-lg transform scale-95 opacity-0 transition-all"
            id="proventos-modal-content">
            <div class="flex justify-between items-center mb-6">
                <h3 class="font-bold text-lg text-slate-800 dark:text-slate-100">Inserir Proventos</h3>
                <button onclick="closeProventosModal()"
                    class="text-slate-400 hover:text-slate-600 dark:hover:text-slate-200"><i
                        class="fa-solid fa-xmark text-xl"></i></button>
            </div>

            <div class="grid grid-cols-2 gap-4 mb-4">
                <div>
                    <label
                        class="block text-xs font-bold text-slate-500 dark:text-slate-400 uppercase mb-2">Data</label>
                    <input type="date" id="prov-date"
                        class="w-full px-4 py-3 rounded-xl border border-slate-200 dark:border-slate-700 outline-none focus:border-emerald-500 transition-colors bg-white dark:bg-slate-900 text-slate-800 dark:text-slate-100">
                </div>
                <div>
                    <label
                        class="block text-xs font-bold text-slate-500 dark:text-slate-400 uppercase mb-2">Ativo</label>
                    <input type="text" id="prov-asset" list="rv-assets-list"
                        onchange="autoFillProventosCategory(this.value)"
                        class="w-full px-4 py-3 rounded-xl border border-slate-200 dark:border-slate-700 outline-none focus:border-emerald-500 transition-colors bg-white dark:bg-slate-900 text-slate-800 dark:text-slate-100"
                        placeholder="Ex: PETR4">
                    <datalist id="rv-assets-list"></datalist>
                </div>
            </div>

            <div class="grid grid-cols-2 gap-4 mb-4">
                <div>
                    <label
                        class="block text-xs font-bold text-slate-500 dark:text-slate-400 uppercase mb-2">Categoria</label>
                    <select id="prov-category" onchange="checkProventosCurrency(); checkProventosEvent();"
                        class="w-full px-4 py-3 rounded-xl border border-slate-200 dark:border-slate-700 outline-none focus:border-emerald-500 transition-colors bg-white dark:bg-slate-900 text-slate-800 dark:text-slate-100">
                        <option value="">Selecione...</option>
                        <option value="Ação">Ação</option>
                        <option value="BDR">BDR</option>
                        <option value="FII">Fundo Imobiliário</option>
                        <option value="Exterior">Exterior</option>
                    </select>
                </div>
                <div>
                    <label
                        class="block text-xs font-bold text-slate-500 dark:text-slate-400 uppercase mb-2">Evento</label>
                    <select id="prov-event"
                        class="w-full px-4 py-3 rounded-xl border border-slate-200 dark:border-slate-700 outline-none focus:border-emerald-500 transition-colors bg-white dark:bg-slate-900 text-slate-800 dark:text-slate-100">
                        <option value="Dividendo">Dividendo</option>
                        <option value="JCP">JCP</option>
                        <option value="Rendimento">Rendimento</option>
                        <option value="Outros">Outros</option>
                    </select>
                </div>
            </div>

            <div class="mb-6">
                <!-- Header: Label + Currency Toggle + Display -->
                <div class="flex justify-between items-center mb-2">
                    <div class="flex items-center gap-3">
                        <label class="block text-xs font-bold text-slate-500 dark:text-slate-400 uppercase">Valor
                            Líquido</label>
                        <!-- Currency Toggle Moved Here -->
                        <div
                            class="flex items-center gap-1 bg-slate-100 dark:bg-slate-700 rounded-lg p-1 border border-slate-200 dark:border-slate-600">
                            <button type="button" onclick="setProventosCurrency('BRL')" id="btn-curr-brl"
                                class="px-2 py-0.5 rounded text-[10px] font-bold bg-white dark:bg-slate-800 shadow-sm text-slate-800 dark:text-slate-100">R$</button>
                            <button type="button" onclick="setProventosCurrency('USD')" id="btn-curr-usd"
                                class="px-2 py-0.5 rounded text-[10px] font-bold text-slate-500 hover:bg-white hover:shadow-sm">US$</button>
                        </div>
                    </div>
                    <span id="prov-converted-display"
                        class="hidden text-xs font-bold text-emerald-600 bg-emerald-50 px-2 py-1 rounded transition-all">
                        ≈ R$ 0,00
                    </span>
                </div>

                <div class="flex gap-4 items-end">
                    <!-- 1. Valor e Moeda (Sempre Visível) -->
                    <div class="flex gap-2 flex-1 relative h-full">
                        <div class="relative w-full">
                            <input type="hidden" id="prov-edit-id"> <!-- ID para edição -->
                            <span id="prov-currency-symbol"
                                class="absolute left-4 top-3.5 text-slate-400 font-bold">R$</span>
                            <input type="text" inputmode="numeric" id="prov-value"
                                oninput="formatCurrencyInput(this); calculateProventosConversion()"
                                class="w-full pl-14 pr-4 py-3 rounded-xl border border-slate-200 dark:border-slate-700 outline-none focus:border-emerald-500 font-bold text-lg text-slate-800 dark:text-slate-100 transition-colors bg-white dark:bg-slate-900">
                        </div>
                    </div>

                    <!-- 2. Input de Impostos (Só aparece se USD/Exterior) -->
                    <div id="prov-tax-container" class="hidden flex-1 transition-all">
                        <label class="block text-xs font-bold text-slate-400 uppercase mb-1">Impostos</label>
                        <div class="relative">
                            <span class="absolute left-3 top-3.5 text-slate-400 font-bold text-xs">$</span>
                            <input type="text" inputmode="numeric" id="prov-tax"
                                oninput="formatCurrencyInput(this); calculateProventosConversion()"
                                class="w-full pl-9 pr-3 py-3 rounded-xl border border-slate-200 outline-none focus:border-emerald-500 font-bold text-red-500 transition-colors bg-red-50"
                                placeholder="0,00">
                        </div>
                    </div>

                    <!-- 3. Input de Cotação (Só aparece se USD/Exterior) -->
                    <div id="prov-rate-container" class="hidden flex-1 transition-all">
                        <label class="block text-xs font-bold text-slate-400 uppercase mb-1">Cotação USD</label>
                        <div class="relative">
                            <span class="absolute left-3 top-3.5 text-slate-400 font-bold text-xs">R$</span>
                            <input type="number" id="prov-usd-rate" step="0.001"
                                oninput="calculateProventosConversion()"
                                class="w-full pl-9 pr-3 py-3 rounded-xl border border-slate-200 outline-none focus:border-emerald-500 font-bold text-slate-700 transition-colors bg-slate-50">
                        </div>
                    </div>
                </div>
            </div>


            <div class="flex gap-3">
                <button onclick="closeProventosModal()"
                    class="flex-1 py-3 text-slate-500 dark:text-slate-400 hover:bg-slate-100 dark:hover:bg-slate-700 rounded-xl font-medium transition-colors">Cancelar</button>
                <button onclick="saveProvento()"
                    class="flex-1 py-3 bg-emerald-600 hover:bg-emerald-700 text-white rounded-xl font-bold shadow-lg shadow-emerald-200 transition-colors">Salvar</button>
            </div>
        </div>
    </div>

    <div id="delete-modal"
        class="fixed inset-0 bg-slate-900/60 z-[80] hidden flex items-center justify-center backdrop-blur-sm transition-opacity opacity-0">
        <div id="delete-modal-content"
            class="bg-white dark:bg-slate-800 rounded-3xl p-8 shadow-2xl w-full max-w-sm transform scale-95 opacity-0 transition-all duration-300 mx-4">
            <div class="text-center">
                <div
                    class="w-16 h-16 bg-red-100 dark:bg-red-900/30 rounded-full flex items-center justify-center mx-auto mb-4">
                    <i class="fa-solid fa-trash-can text-red-500 text-2xl"></i>
                </div>
                <h3 class="text-xl font-bold text-slate-800 dark:text-slate-100 mb-2">Excluir Lançamento?</h3>
                <p class="text-slate-500 text-sm mb-6">Essa ação não pode ser desfeita. Tem certeza que deseja remover
                    este provento do histórico?</p>
                <div class="flex gap-3">
                    <button onclick="closeDeleteModal()"
                        class="flex-1 py-3 text-slate-500 dark:text-slate-400 hover:bg-slate-100 dark:hover:bg-slate-700 rounded-xl font-medium transition-colors">Cancelar</button>
                    <button onclick="confirmDeleteProvento()"
                        class="flex-1 py-3 bg-red-500 hover:bg-red-600 text-white rounded-xl font-bold shadow-lg shadow-red-200 transition-colors">Excluir</button>
                </div>
            </div>
        </div>
    </div>

    <div id="proventos-goal-modal"
        class="fixed inset-0 bg-slate-900/60 z-[70] hidden flex items-center justify-center backdrop-blur-sm transition-opacity opacity-0">
        <div class="bg-white dark:bg-slate-800 rounded-2xl shadow-2xl p-6 w-full max-w-sm transform scale-95 opacity-0 transition-all"
            id="proventos-goal-modal-content">
            <h3 class="font-bold text-lg text-slate-800 dark:text-slate-100 mb-4">Definir Meta de Proventos</h3><label
                class="block text-xs font-bold text-slate-500 dark:text-slate-400 uppercase tracking-wider mb-2">Meta
                Anual (R$)</label>
            <div class="relative mb-6">
                <span class="absolute left-4 top-3.5 text-slate-400 font-bold">R$</span>
                <input type="number" id="input-proventos-goal" step="100" placeholder="0,00"
                    class="w-full pl-12 pr-4 py-3 rounded-xl border border-slate-200 dark:border-slate-700 outline-none focus:border-primary transition-colors text-lg font-bold text-slate-700 dark:text-slate-200 bg-white dark:bg-slate-900">
            </div>
            <div class="flex gap-3">
                <button onclick="closeProventosGoalModal()"
                    class="flex-1 py-3 text-slate-500 dark:text-slate-400 hover:bg-slate-100 dark:hover:bg-slate-700 rounded-xl font-medium transition-colors">Cancelar</button>
                <button onclick="saveProventosGoal()"
                    class="flex-1 py-3 bg-primary hover:bg-primary-dark text-white rounded-xl font-bold shadow-lg shadow-blue-500/30 transition-colors">Salvar</button>
            </div>
        </div>
    </div>
    <div id="goal-modal"
        class="fixed inset-0 bg-slate-900/60 z-[70] hidden flex items-center justify-center backdrop-blur-sm transition-opacity opacity-0">
        <div class="bg-white dark:bg-slate-800 rounded-2xl shadow-2xl p-6 w-full max-w-sm transform scale-95 opacity-0 transition-all"
            id="goal-modal-content">
            <h3 class="font-bold text-lg text-slate-800 dark:text-slate-100 mb-4">Definir Meta Anual</h3><label
                class="block text-xs font-bold text-slate-500 dark:text-slate-400 uppercase mb-2">Valor da Meta
                (R$)</label><input type="number" id="goal-input"
                class="w-full px-4 py-3 rounded-xl border border-slate-200 dark:border-slate-700 focus:border-primary focus:ring-4 focus:ring-primary/10 outline-none font-bold text-xl text-slate-800 dark:text-slate-100 bg-white dark:bg-slate-900 mb-6"
                placeholder="0,00">
            <div class="flex gap-3"><button onclick="closeGoalModal()"
                    class="flex-1 py-2 text-slate-500 dark:text-slate-400 hover:bg-slate-100 dark:hover:bg-slate-700 rounded-lg font-medium">Cancelar</button><button
                    onclick="saveGoal()"
                    class="flex-1 py-2 bg-primary text-white rounded-lg font-bold shadow-lg">Salvar</button></div>
        </div>
    </div>

    <!-- TRANSACTION MODAL (NOVO/EDITAR) -->
    <div id="transaction-modal"
        class="fixed inset-0 bg-slate-900/60 z-50 hidden flex items-center justify-center backdrop-blur-sm transition-opacity opacity-0">
        <div class="bg-white dark:bg-slate-800 rounded-3xl shadow-2xl w-full max-w-2xl mx-4 transform transition-all scale-95 opacity-0"
            id="modal-content">
            <div
                class="px-8 py-6 border-b border-slate-100 dark:border-slate-700 flex justify-between items-center bg-slate-50 dark:bg-slate-900 rounded-t-3xl">
                <div>
                    <h3 class="font-bold text-xl text-slate-800 dark:text-slate-100" id="modal-title">Novo Aporte</h3>
                </div><button onclick="closeModal()"
                    class="w-8 h-8 rounded-full bg-white dark:bg-slate-800 hover:bg-slate-100 dark:hover:bg-slate-700 text-slate-400 flex justify-center items-center"><i
                        class="fa-solid fa-xmark"></i></button>
            </div>
            <div class="p-8" id="modal-body-content"><input type="hidden" id="modal-context"><input type="hidden"
                    id="edit-asset-id">
                <div id="category-selector" class="hidden grid-cols-2 gap-4 mb-4"><button
                        onclick="selectCategory('reserva')"
                        class="p-4 rounded-xl border border-slate-200 dark:border-slate-700 hover:border-primary hover:bg-blue-50 dark:hover:bg-blue-900/30 transition-all flex flex-col items-center gap-2"><i
                            class="fa-solid fa-shield-halved text-2xl text-primary"></i><span
                            class="font-bold text-slate-700 dark:text-slate-200">Reserva</span></button><button
                        onclick="selectCategory('renda-fixa')"
                        class="p-4 rounded-xl border border-slate-200 dark:border-slate-700 hover:border-primary hover:bg-blue-50 dark:hover:bg-blue-900/30 transition-all flex flex-col items-center gap-2"><i
                            class="fa-solid fa-percent text-2xl text-primary"></i><span
                            class="font-bold text-slate-700 dark:text-slate-200">Renda Fixa</span></button><button
                        onclick="selectCategory('tesouro')"
                        class="p-4 rounded-xl border border-slate-200 dark:border-slate-700 hover:border-primary hover:bg-blue-50 dark:hover:bg-blue-900/30 transition-all flex flex-col items-center gap-2"><i
                            class="fa-solid fa-landmark text-2xl text-primary"></i><span
                            class="font-bold text-slate-700 dark:text-slate-200">Tesouro Direto</span></button><button
                        onclick="selectCategory('renda-variavel')"
                        class="p-4 rounded-xl border border-slate-200 dark:border-slate-700 hover:border-primary hover:bg-blue-50 dark:hover:bg-blue-900/30 transition-all flex flex-col items-center gap-2"><i
                            class="fa-solid fa-arrow-trend-up text-2xl text-primary"></i><span
                            class="font-bold text-slate-700 dark:text-slate-200">Renda Variável</span></button></div>
                <div id="modal-fields-container" class="grid grid-cols-1 md:grid-cols-2 gap-6"></div>
            </div>
            <div class="p-6 border-t border-slate-100 dark:border-slate-700 flex justify-end gap-3 bg-slate-50 dark:bg-slate-900 rounded-b-3xl"
                id="modal-actions"><button onclick="closeModal()"
                    class="px-6 py-3 text-slate-500 dark:text-slate-400 hover:bg-slate-200 dark:hover:bg-slate-700 rounded-xl font-semibold transition-colors">Cancelar</button><button
                    onclick="saveNewAsset()"
                    class="px-8 py-3 bg-primary text-white rounded-xl font-bold shadow-lg flex items-center gap-2"><i
                        class="fa-solid fa-check"></i> <span id="modal-save-btn-text">Salvar</span></button></div>
        </div>
    </div>

    <div id="update-balances-modal"
        class="fixed inset-0 bg-slate-900/60 z-50 hidden flex items-center justify-center backdrop-blur-sm transition-opacity opacity-0">
        <div class="bg-white dark:bg-slate-800 rounded-3xl shadow-2xl w-full max-w-2xl mx-4 transform transition-all scale-95 opacity-0 flex flex-col max-h-[85vh]"
            id="update-balances-content">
            <div
                class="px-8 py-6 border-b border-slate-100 dark:border-slate-700 flex justify-between items-center bg-slate-50 dark:bg-slate-900 rounded-t-3xl">
                <div>
                    <h3 class="font-bold text-xl text-slate-800 dark:text-slate-100">Atualizar</h3>
                </div><button onclick="closeUpdateBalancesModal()"
                    class="w-8 h-8 rounded-full bg-white dark:bg-slate-800 hover:bg-slate-100 dark:hover:bg-slate-700 text-slate-400 flex justify-center items-center"><i
                        class="fa-solid fa-xmark"></i></button>
            </div>
            <div id="usd-rate-container"
                class="hidden px-8 py-4 bg-yellow-50 border-b border-yellow-100 flex items-center justify-between">
                <div class="flex items-center gap-2 text-yellow-800 font-bold"><i
                        class="fa-solid fa-dollar-sign bg-yellow-200 w-8 h-8 flex items-center justify-center rounded-full"></i><span>Cotação
                        Dólar</span></div>
                <div class="flex items-center gap-2"><span class="text-sm font-bold text-slate-500">R$</span><input
                        type="number" id="usd-rate-input" step="0.001"
                        class="w-24 px-3 py-2 rounded-lg border border-yellow-300 font-bold text-right text-slate-800">
                </div>
            </div>
            <div id="update-balances-filters"
                class="hidden px-6 py-4 flex gap-2 overflow-x-auto overflow-y-hidden border-b border-slate-100 dark:border-slate-700 items-center">
                <button onclick="filterUpdateList('all')"
                    class="filter-btn bg-primary text-white px-3 py-1.5 rounded-lg text-xs font-bold">Todos</button><button
                    onclick="filterUpdateList('Selic')"
                    class="filter-btn bg-slate-100 text-slate-600 px-3 py-1.5 rounded-lg text-xs font-medium">Selic</button>
            </div>
            <div class="p-6 overflow-y-auto flex-1">
                <div class="space-y-4" id="update-balances-list"></div>
            </div>
            <div
                class="p-6 border-t border-slate-100 dark:border-slate-700 flex justify-end gap-3 bg-slate-50 dark:bg-slate-900 rounded-b-3xl">
                <button onclick="closeUpdateBalancesModal()"
                    class="px-6 py-3 text-slate-500 dark:text-slate-400 hover:bg-slate-200 dark:hover:bg-slate-700 rounded-xl font-semibold transition-colors">Cancelar</button><button
                    onclick="saveUpdatedBalances()"
                    class="px-8 py-3 bg-primary text-white rounded-xl font-bold shadow-lg"><i
                        class="fa-solid fa-floppy-disk"></i> Salvar</button>
            </div>
        </div>
    </div>

    <div id="success-modal"
        class="fixed inset-0 bg-slate-900/60 z-[60] hidden flex items-center justify-center backdrop-blur-sm transition-opacity opacity-0">
        <div class="bg-white dark:bg-slate-800 rounded-3xl shadow-2xl p-8 flex flex-col items-center justify-center transform scale-95 opacity-0"
            id="success-modal-content">
            <div
                class="w-20 h-20 bg-emerald-100 dark:bg-emerald-900/30 rounded-full flex items-center justify-center mb-4 scale-up-center">
                <i class="fa-solid fa-check text-4xl text-emerald-600"></i>
            </div>
            <h3 class="text-xl font-bold text-slate-800 dark:text-slate-100 mb-2">Sucesso!</h3>
            <p class="text-slate-500 text-center" id="success-message">Ação realizada.</p>
        </div>
    </div>

    <!-- MODAL DE CONFIRMAÇÃO DE EXCLUSÃO -->
    <div id="delete-modal"
        class="fixed inset-0 bg-slate-900/60 z-[80] hidden flex items-center justify-center backdrop-blur-sm transition-opacity opacity-0">
        <div class="bg-white dark:bg-slate-800 rounded-3xl shadow-2xl w-full max-w-sm mx-4 transform transition-all scale-95 opacity-0 p-6 text-center"
            id="delete-modal-content">
            <div
                class="w-16 h-16 bg-red-100 dark:bg-red-900/30 rounded-full flex items-center justify-center mx-auto mb-4 scale-up-center">
                <i class="fa-solid fa-triangle-exclamation text-2xl text-red-500"></i>
            </div>
            <h3 class="text-xl font-bold text-slate-800 dark:text-slate-100 mb-2">Tem certeza?</h3>
            <p class="text-sm text-slate-500 mb-6">Você está prestes a excluir este ativo permanentemente. Confirmar
                exclusão?</p>
            <div class="flex gap-3">
                <button onclick="closeDeleteModal()"
                    class="flex-1 py-2.5 text-slate-500 dark:text-slate-400 hover:bg-slate-100 dark:hover:bg-slate-700 rounded-xl font-semibold transition-colors">Cancelar</button>
                <button onclick="executeDelete()"
                    class="flex-1 py-2.5 bg-red-500 hover:bg-red-600 text-white rounded-xl font-bold shadow-lg shadow-red-500/30 transition-all">Excluir</button>
            </div>
        </div>
    </div>

    <div id="liquidation-modal"
        class="fixed inset-0 bg-slate-900/60 z-50 hidden flex items-center justify-center backdrop-blur-sm transition-opacity opacity-0">
        <div class="bg-white dark:bg-slate-800 rounded-3xl shadow-2xl w-full max-w-md mx-4 transform transition-all scale-95 opacity-0"
            id="liquidation-modal-content">
            <div
                class="px-8 py-6 border-b border-slate-100 dark:border-slate-700 flex justify-between items-center bg-yellow-50 dark:bg-yellow-900/20 rounded-t-3xl">
                <div>
                    <h3 class="font-bold text-xl text-slate-800 dark:text-slate-100">Liquidar <span id="liq-asset-name"
                            class="text-sm font-normal text-slate-500 dark:text-slate-400 block"></span></h3>
                </div><button onclick="closeLiquidationModal()"
                    class="w-8 h-8 rounded-full bg-white dark:bg-slate-800 hover:bg-slate-100 dark:hover:bg-slate-700 text-slate-400 flex justify-center items-center"><i
                        class="fa-solid fa-xmark"></i></button>
            </div>
            <div class="p-8 space-y-6">
                <input type="hidden" id="liq-asset-id">
                <input type="hidden" id="liq-context">

                <!-- Campos Renda Variável -->
                <div id="liq-rv-fields" class="hidden space-y-4">
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label
                                class="block text-xs font-bold text-slate-500 uppercase tracking-wider mb-2">Quantidade
                                (<span id="liq-max-qty">0</span>)</label>
                            <input type="number" id="liq-qty" step="any" oninput="updateLiquidationValues()"
                                class="w-full px-4 py-3 rounded-xl border border-slate-200 outline-none focus:border-yellow-400 font-bold text-slate-700">
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-slate-500 uppercase tracking-wider mb-2">Preço
                                Venda</label>
                            <div class="relative">
                                <span
                                    class="liq-currency-symbol absolute left-4 top-3.5 text-slate-400 font-bold">R$</span>
                                <input type="text" inputmode="numeric" id="liq-price"
                                    oninput="formatCurrencyInput(this); updateLiquidationValues()"
                                    class="w-full pl-10 pr-4 py-3 rounded-xl border border-slate-200 outline-none focus:border-yellow-400 font-bold text-slate-700">
                            </div>
                        </div>
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-slate-500 uppercase tracking-wider mb-2">Outros
                            Custos</label>
                        <div class="relative">
                            <span class="liq-currency-symbol absolute left-4 top-3.5 text-slate-400 font-bold">R$</span>
                            <input type="text" inputmode="numeric" id="liq-costs" value="0,00"
                                oninput="formatCurrencyInput(this); updateLiquidationValues()"
                                class="w-full pl-10 pr-4 py-3 rounded-xl border border-slate-200 outline-none focus:border-yellow-400 text-slate-600">
                        </div>
                    </div>
                </div>

                <!-- Campos Outros (Reserva/RF/Tesouro) -->
                <div id="liq-other-fields" class="hidden space-y-4">
                    <div class="flex p-1 bg-slate-100 rounded-xl mb-4">
                        <button onclick="toggleLiquidationType('total')" id="btn-liq-total"
                            class="flex-1 py-2 rounded-lg text-sm font-bold shadow-sm bg-white text-slate-800 transition-all">Total</button>
                        <button onclick="toggleLiquidationType('partial')" id="btn-liq-partial"
                            class="flex-1 py-2 rounded-lg text-sm font-medium text-slate-500 hover:text-slate-700 transition-all">Parcial</button>
                    </div>
                    <div id="liq-partial-container" class="hidden">
                        <label class="block text-xs font-bold text-slate-500 uppercase tracking-wider mb-2">Valor do
                            Resgate</label>
                        <div class="relative">
                            <span class="liq-currency-symbol absolute left-4 top-3.5 text-slate-400 font-bold">R$</span>
                            <input type="text" inputmode="numeric" id="liq-withdraw-value"
                                oninput="formatCurrencyInput(this); updateLiquidationValues()"
                                class="w-full pl-10 pr-4 py-3 rounded-xl border border-slate-200 outline-none focus:border-yellow-400 font-bold text-slate-700">
                        </div>
                        <p class="text-xs text-slate-400 mt-1 text-right">Saldo Atual: <span id="liq-current-balance"
                                class="font-bold"></span></p>
                    </div>
                </div>

                <!-- Final Value Readonly -->
                <div>
                    <label class="block text-xs font-bold text-slate-500 uppercase tracking-wider mb-2">Valor Final
                        (Recebido)</label>
                    <div class="relative">
                        <span class="liq-currency-symbol absolute left-4 top-3.5 text-slate-400 font-bold">R$</span>
                        <input type="number" id="liq-final-value" step="0.01"
                            class="w-full pl-10 pr-4 py-3 rounded-xl border border-yellow-200 bg-yellow-50 font-bold text-xl text-yellow-700 outline-none">
                    </div>
                </div>

                <div><label
                        class="block text-xs font-bold text-slate-500 uppercase tracking-wider mb-2">Data</label><input
                        type="date" id="liq-date" class="w-full px-4 py-3 rounded-xl border border-slate-200"></div>
            </div>
            <div class="p-6 border-t border-slate-100 flex justify-end gap-3 bg-slate-50 rounded-b-3xl"><button
                    onclick="closeLiquidationModal()"
                    class="px-6 py-3 text-slate-500 hover:bg-slate-200 rounded-xl font-semibold">Cancelar</button><button
                    onclick="confirmLiquidation()"
                    class="px-8 py-3 bg-yellow-500 hover:bg-yellow-600 text-white rounded-xl font-bold shadow-lg flex items-center gap-2"><i
                        class="fa-solid fa-sack-dollar"></i> Confirmar</button></div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js';
        import { getAuth, GoogleAuthProvider, signInWithPopup, signOut, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js';
        import { getFirestore, collection, addDoc, onSnapshot, doc, updateDoc, deleteDoc, query, setDoc, getDoc, writeBatch, getDocs } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js';

        // --- ÁREA DE CONFIGURAÇÃO DO FIREBASE (Edite aqui para Deploy) ---
        const clientCredentials = {
            apiKey: "AIzaSyCKIOuVjmbIo2KNDjwW7kE9P1nBj0O-oIE",
            authDomain: "meus-investimentos-260ce.firebaseapp.com",
            projectId: "meus-investimentos-260ce",
            storageBucket: "meus-investimentos-260ce.firebasestorage.app",
            messagingSenderId: "231648743488",
            appId: "1:231648743488:web:f11778354e2c9751328fa5"
        };

        const firebaseConfig = (clientCredentials.apiKey)
            ? clientCredentials
            : JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const provider = new GoogleAuthProvider();

        const appId = (clientCredentials.apiKey)
            ? "meu_app_investimentos_prod"
            : (typeof __app_id !== 'undefined' ? __app_id : 'default-app-id').replace(/[./]/g, '_');

        let user = null;
        let unsubscribeListeners = [];

        // Constants
        const ANCIENT_ID = "portfolio_principal"; // Legacy ID for migration

        // --- Auth Functions ---
        window.loginWithGoogle = async () => {
            try {
                await signInWithPopup(auth, provider);
            } catch (error) {
                console.error("Login Error:", error);
                alert("Erro ao fazer login: " + error.message);
            }
        };

        window.handleLogout = async () => {
            try {
                await signOut(auth);
                // Listeners are cleared in onAuthStateChanged
            } catch (error) {
                console.error("Logout Error:", error);
            }
        };

        // --- Auth State Observer ---
        onAuthStateChanged(auth, (currentUser) => {
            // Check for legacy anonymous session
            if (currentUser && currentUser.isAnonymous) {
                console.log("Detectado usuário anônimo antigo. Desconectando para forçar Google Login...");
                signOut(auth);
                return;
            }

            user = currentUser;
            const loginOverlay = document.getElementById('login-overlay');
            if (user) {
                console.log("Conectado como:", user.uid);
                if (loginOverlay) loginOverlay.classList.add('opacity-0', 'pointer-events-none');

                // Update Header Name
                const headerName = document.querySelector('.text-base.font-bold.text-slate-700');
                if (headerName) {
                    headerName.textContent = user.displayName || user.email || "Usuário (Sem Nome)";
                    headerName.classList.add('text-indigo-600');
                }

                setupRealtimeListeners(user.uid);
            } else {
                console.log("Desconectado.");
                if (loginOverlay) loginOverlay.classList.remove('opacity-0', 'pointer-events-none');

                const headerName = document.querySelector('.text-base.font-bold.text-slate-700');
                if (headerName) headerName.textContent = "Visitante";

                // Clear Data / Listeners
                unsubscribeListeners.forEach(unsub => unsub());
                unsubscribeListeners = [];
                window.mockReservaAssets.length = 0;
                window.mockRendaFixaAssets.length = 0;
                window.mockTesouroAssets.length = 0;
                window.mockRendaVariavelAssets.length = 0;
                window.proventos = [];
                window.liquidationHistory = [];

                // Refresh UI to Empty
                if (window.renderDashboard) renderDashboard();
            }
        });

        // --- Realtime Listeners ---
        function setupRealtimeListeners(userId) {
            // Clear existing listeners just in case
            unsubscribeListeners.forEach(unsub => unsub());
            unsubscribeListeners = [];

            // 1. Assets
            const unsubAssets = onSnapshot(collection(db, 'artifacts', appId, 'users', userId, 'assets'), (snapshot) => {
                window.mockReservaAssets.length = 0;
                window.mockRendaFixaAssets.length = 0;
                window.mockTesouroAssets.length = 0;
                window.mockRendaVariavelAssets.length = 0;

                snapshot.forEach(doc => {
                    const data = doc.data();
                    const asset = { id: doc.id, ...data };

                    if (asset.category === 'renda-variavel' || asset.ticker) {
                        window.mockRendaVariavelAssets.push(asset);
                    } else if (asset.category === 'tesouro' || (asset.type && asset.type.includes('Tesouro'))) {
                        window.mockTesouroAssets.push(asset);
                    } else if (asset.category === 'renda-fixa' || asset.type === 'Debenture') {
                        window.mockRendaFixaAssets.push(asset);
                    } else {
                        window.mockReservaAssets.push(asset);
                    }
                });

                if (window.renderDashboard) {
                    if (currentContext === 'dashboard') renderDashboard();
                    else navigateTo(currentContext);
                }
            });
            unsubscribeListeners.push(unsubAssets);

            // 2. History
            const unsubHistory = onSnapshot(collection(db, 'artifacts', appId, 'users', userId, 'history'), (snapshot) => {
                window.liquidationHistory.length = 0;
                snapshot.forEach(doc => {
                    window.liquidationHistory.push({ id: doc.id, ...doc.data() });
                });
                if (currentContext === 'historico') renderHistorico();
            });
            unsubscribeListeners.push(unsubHistory);

            // 3. Proventos
            const unsubProventos = onSnapshot(collection(db, 'artifacts', appId, 'users', userId, 'proventos'), (snapshot) => {
                window.proventos = [];
                snapshot.forEach(doc => {
                    const data = doc.data();
                    window.proventos.push({ ...data, id: doc.id });
                });
                window.proventos.sort((a, b) => new Date(b.date) - new Date(a.date));
                if (window.renderProventos) window.renderProventos();
            });
            unsubscribeListeners.push(unsubProventos);

            // 4. Settings (Goals, etc)
            const settingsDocs = ['goals', 'rv_goals', 'rebalance_goals'];
            settingsDocs.forEach(docName => {
                const unsub = onSnapshot(doc(db, 'artifacts', appId, 'users', userId, 'settings', docName), (docSnap) => {
                    if (!docSnap.exists()) return;
                    const data = docSnap.data();

                    if (docName === 'goals') {
                        window.annualGoal = data.annualGoal || 0;
                        window.availableCash = data.availableCash || 0;
                        window.proventosGoal = data.proventosGoal || 0;
                        const caixaInput = document.getElementById('reb-caixa');
                        if (caixaInput) caixaInput.value = window.availableCash;
                        if (window.renderDashboard) window.renderDashboard();
                        if (window.renderProventos) window.renderProventos();
                    } else if (docName === 'rv_goals') {
                        if (data.goals) {
                            window.rvAssetGoals = data.goals;
                            if (currentContext === 'renda-variavel') renderRendaVariavel(window.currentRvFilter);
                        }
                    } else if (docName === 'rebalance_goals') {
                        if (data.goals) {
                            window.rebalanceGoals = data.goals;
                            if (currentContext === 'rebalanceamento') renderRebalanceamento();
                        }
                    }
                });
                unsubscribeListeners.push(unsub);
            });
        }

        // --- Migration Logic ---
        window.migrateAncientData = async () => {
            if (!user) return alert("Faça login primeiro.");
            if (!confirm("Isso importará os dados da versão antiga para sua conta. Deseja continuar?")) return;

            try {
                showSuccessMessage("Migrando dados...");
                const batch = writeBatch(db);
                let opCount = 0;

                // 1. Assets
                const oldAssets = await getDocs(collection(db, 'artifacts', appId, 'users', ANCIENT_ID, 'assets'));
                oldAssets.forEach(docSnap => {
                    const ref = doc(collection(db, 'artifacts', appId, 'users', user.uid, 'assets'));
                    batch.set(ref, docSnap.data());
                    opCount++;
                });

                // 2. History
                const oldHistory = await getDocs(collection(db, 'artifacts', appId, 'users', ANCIENT_ID, 'history'));
                oldHistory.forEach(docSnap => {
                    const ref = doc(collection(db, 'artifacts', appId, 'users', user.uid, 'history'));
                    batch.set(ref, docSnap.data());
                    opCount++;
                });

                // 3. Proventos
                const oldProventos = await getDocs(collection(db, 'artifacts', appId, 'users', ANCIENT_ID, 'proventos'));
                oldProventos.forEach(docSnap => {
                    const ref = doc(collection(db, 'artifacts', appId, 'users', user.uid, 'proventos'));
                    batch.set(ref, docSnap.data());
                    opCount++;
                });

                // 4. Settings
                const settingsDocs = ['goals', 'rv_goals', 'rebalance_goals'];
                for (const docName of settingsDocs) {
                    const snap = await getDoc(doc(db, 'artifacts', appId, 'users', ANCIENT_ID, 'settings', docName));
                    if (snap.exists()) {
                        const ref = doc(db, 'artifacts', appId, 'users', user.uid, 'settings', docName);
                        batch.set(ref, snap.data());
                        opCount++;
                    }
                }

                if (opCount > 0) {
                    await batch.commit();
                    showSuccessMessage(`${opCount} registros migrados com sucesso!`);
                } else {
                    alert("Nenhum dado antigo encontrado para migrar.");
                }

            } catch (e) {
                console.error("Migration Error:", e);
                alert("Erro na migração: " + e.message);
            }
        }

        // --- Wrapper Functions (Updated to use auth.currentUser.uid) ---
        window.firebaseSaveAsset = async (assetData) => {
            if (!auth.currentUser) return;
            try {
                await addDoc(collection(db, 'artifacts', appId, 'users', auth.currentUser.uid, 'assets'), assetData);
            } catch (e) { console.error(e); alert("Erro ao salvar."); }
        };

        window.firebaseUpdateAsset = async (id, data) => {
            if (!auth.currentUser) return;
            try {
                await updateDoc(doc(db, 'artifacts', appId, 'users', auth.currentUser.uid, 'assets', id), data);
            } catch (e) { console.error(e); }
        };

        window.firebaseDeleteAsset = async (id) => {
            if (!auth.currentUser) return;
            try {
                await deleteDoc(doc(db, 'artifacts', appId, 'users', auth.currentUser.uid, 'assets', id));
            } catch (e) { console.error(e); }
        };

        window.firebaseSaveHistory = async (historyData) => {
            if (!auth.currentUser) return;
            try {
                await addDoc(collection(db, 'artifacts', appId, 'users', auth.currentUser.uid, 'history'), historyData);
            } catch (e) { console.error(e); }
        };

        window.firebaseSaveGoal = async (value) => {
            if (!auth.currentUser) return;
            try {
                await setDoc(doc(db, 'artifacts', appId, 'users', auth.currentUser.uid, 'settings', 'goals'), { annualGoal: parseFloat(value) }, { merge: true });
            } catch (e) { console.error(e); }
        };

        window.firebaseSaveProventosGoal = async (value) => {
            if (!auth.currentUser) return;
            try {
                await setDoc(doc(db, 'artifacts', appId, 'users', auth.currentUser.uid, 'settings', 'goals'), { proventosGoal: parseFloat(value) }, { merge: true });
            } catch (e) { console.error(e); }
        };

        window.firebaseSaveCash = async (value) => {
            if (!auth.currentUser) return;
            try {
                window.availableCash = parseFloat(value);
                await setDoc(doc(db, 'artifacts', appId, 'users', auth.currentUser.uid, 'settings', 'goals'), { availableCash: parseFloat(value) }, { merge: true });
            } catch (e) { console.error(e); }
        };

        window.firebaseSaveAssetGoals = async (goals) => {
            if (!auth.currentUser) return;
            try {
                await setDoc(doc(db, 'artifacts', appId, 'users', auth.currentUser.uid, 'settings', 'rv_goals'), { goals }, { merge: true });
            } catch (e) { console.error(e); }
        };

        window.firebaseSaveRebalanceGoals = async (rebGoals) => {
            if (!auth.currentUser) return;
            try {
                await setDoc(doc(db, 'artifacts', appId, 'users', auth.currentUser.uid, 'settings', 'rebalance_goals'), { goals: rebGoals }, { merge: true });
            } catch (e) { console.error(e); }
        };

        window.firebaseSaveProvento = async (provData) => {
            if (!auth.currentUser) return;
            try {
                const id = provData.id;
                await setDoc(doc(db, 'artifacts', appId, 'users', auth.currentUser.uid, 'proventos', id), provData);
            } catch (e) { console.error(e); alert("Erro ao salvar."); }
        };

        window.firebaseUpdateProvento = async (id, data) => {
            if (!auth.currentUser) return;
            try {
                await updateDoc(doc(db, 'artifacts', appId, 'users', auth.currentUser.uid, 'proventos', id), data);
            } catch (e) { console.error(e); }
        };

        window.firebaseDeleteProvento = async (id) => {
            if (!auth.currentUser) return;
            try {
                await deleteDoc(doc(db, 'artifacts', appId, 'users', auth.currentUser.uid, 'proventos', id));
            } catch (e) { console.error(e); }
        };

    </script>

    <!-- INJEÇÃO DO MANIFESTO PWA (DINÂMICO) -->
    <script>
        // Cria um manifesto PWA dinamicamente em Data URI para permitir "Adicionar à Tela de Início"
        const manifestData = {
            "name": "Meus Investimentos",
            "short_name": "Investimentos",
            "start_url": ".",
            "display": "standalone",
            "background_color": "#f8fafc",
            "theme_color": "#004aad",
            "icons": [{
                "src": "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24'%3E%3Crect width='24' height='24' rx='5' fill='%23004aad'/%3E%3Cpath fill='white' d='M12 3.5l-9 4.5 9 4.5 9-4.5-9-4.5zm0 7l-9 4.5 9 4.5 9-4.5-9-4.5z'/%3E%3C/svg%3E",
                "sizes": "192x192",
                "type": "image/svg+xml"
            }]
        };
        const stringManifest = JSON.stringify(manifestData);
        const blob = new Blob([stringManifest], { type: 'application/json' });
        const manifestURL = URL.createObjectURL(blob);
        document.getElementById('manifest-placeholder').setAttribute('href', manifestURL);
    </script>

    <script>
        let currentContext = 'dashboard';
        let currentUsdRate = 5.00;
        window.annualGoal = 0; // Transformado em variável global window para acesso no módulo
        window.rebalanceGoals = {
            'reserva': { target: 20, subs: { 'Reserva': 10, 'Tesouro Selic': 10 } },
            'renda-fixa': { target: 30, subs: { 'Renda Fixa CDI': 10, 'Renda Fixa IPCA': 10, 'Tesouro IPCA': 10 } },
            'renda-variavel': { target: 40, subs: { 'Ações': 15, 'FIIs': 15, 'Exterior': 5, 'Cripto': 5 } },
            'aposentadoria': { target: 10, subs: { 'Tesouro Renda+': 10 } }
        };
        window.rvAssetGoals = { 'PETR4': 20, 'VALE3': 20, 'HGLG11': 30, 'VT': 100, 'BTC': 100 };
        window.currentRvFilter = 'all';
        window.currentTesouroFilter = 'all';

        // --- VARIÁVEIS GLOBAIS (window.*) PARA ACESSO NO MÓDULO FIREBASE ---
        window.mockReservaAssets = [];
        window.mockRendaFixaAssets = [];
        window.mockTesouroAssets = [];
        window.mockRendaVariavelAssets = [];
        window.liquidationHistory = [];
        // Variáveis locais para facilitar leitura dentro deste script
        const mockDashboardAssets = [];
        let mockReservaAssets = window.mockReservaAssets;
        let mockRendaFixaAssets = window.mockRendaFixaAssets;
        let mockTesouroAssets = window.mockTesouroAssets;
        let mockRendaVariavelAssets = window.mockRendaVariavelAssets;
        let liquidationHistory = window.liquidationHistory;

        // --- CURRENCY MASKS & PARSING ---
        // Converte string formatada ("1.234,56") para float (1234.56)
        window.parseCurrencyValue = (val) => {
            if (!val) return 0;
            if (typeof val === 'number') return val;
            // Remove tudo que não é dígito ou vírgula (para centavos) ou ponto (se fosse US, mas aqui assumimos BRL input "1.000,00")
            // Vamos assumir padrão PT-BR: pontos separadores de milhar, vírgula decimal.
            // Estrategia: remover pontos, substituir virgula por ponto via replace.
            const clean = val.replace(/\./g, '').replace(',', '.');
            const floatVal = parseFloat(clean);
            return isNaN(floatVal) ? 0 : floatVal;
        };

        // Formata input enquanto digita (máscara)
        window.formatCurrencyInput = (input) => {
            let value = input.value.replace(/\D/g, ''); // Remove tudo que não é dígito

            // Se estiver vazio, limpa
            if (value === '') {
                input.value = '';
                return;
            }

            // Converte para número e divide por 100 para ter os centavos
            const numberValue = parseFloat(value) / 100;

            // Formata para BRL STRING
            input.value = numberValue.toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 });

            // Disparar evento de input manualmente se necessário para frameworks, mas aqui usamos oninput direto
        };

        const formatCurrency = (val, currency = 'BRL') => { if (currency === 'USD') return new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD' }).format(val); return new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(val); };
        const formatDate = (dateString) => { if (!dateString) return '-'; const parts = dateString.split('-'); const date = new Date(parts[0], parts[1] - 1, parts[2]); return new Intl.DateTimeFormat('pt-BR').format(date); };
        const calculateDays = (maturityDate) => { const today = new Date(); today.setHours(0, 0, 0, 0); const parts = maturityDate.split('-'); const maturity = new Date(parts[0], parts[1] - 1, parts[2]); return Math.ceil((maturity - today) / (1000 * 60 * 60 * 24)); };

        function calculateGlobalMetrics() {
            let totalValue = 0; let totalInvested = 0;
            const process = (list) => { list.forEach(a => { let val = (a.current !== undefined && a.current !== null) ? a.current : (a.quantity * a.currentPrice); let cost = (a.invested !== undefined && a.invested !== null) ? a.invested : (a.quantity * a.avgPrice); if (a.currency === 'USD') { val *= currentUsdRate; cost *= currentUsdRate; } totalValue += val; totalInvested += cost; }); };
            process(window.mockReservaAssets); process(window.mockRendaFixaAssets); process(window.mockTesouroAssets); process(window.mockRendaVariavelAssets);
            const profit = totalValue - totalInvested; const profitPerc = totalInvested > 0 ? (profit / totalInvested) * 100 : 0;
            const caixaInput = document.getElementById('reb-caixa'); if (caixaInput) totalValue += (window.parseCurrencyValue(caixaInput.value) || 0);
            return { totalValue, totalInvested, profit, profitPerc };
        }
        function calculateTotalPortfolio() { return calculateGlobalMetrics().totalValue; }

        // --- FUNÇÃO PARA EXPORTAR RELATÓRIO PDF ---
        window.exportToPDF = () => {
            // Cria um container temporário
            const reportContainer = document.createElement('div');
            reportContainer.className = "p-12 bg-white text-slate-800 font-sans";
            // AJUSTE: Reduzi de 794px para 700px para compensar as margens do PDF e evitar cortes
            reportContainer.style.width = "700px";

            const metrics = calculateGlobalMetrics();
            const now = new Date();
            const dateTimeStr = now.toLocaleDateString('pt-BR') + ' ' + now.toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' });

            // Recupera Caixa
            const caixaVal = window.availableCash || 0;

            // Helper para espaçamento forçado (mais confiável que margin no html2pdf)
            const spacer = '<div style="height: 50px; width: 100%;"></div>';
            const smallSpacer = '<div style="height: 30px; width: 100%;"></div>';

            // Cabeçalho
            let html = `
                <div class="flex justify-between items-center border-b-2 border-primary pb-6">
                    <div class="flex items-center gap-4">
                         <div class="w-12 h-12 bg-primary rounded-xl flex items-center justify-center text-white text-2xl"><i class="fa-solid fa-layer-group"></i></div>
                         <div>
                             <h1 class="text-2xl font-bold text-primary leading-none mb-1">Meus Investimentos</h1>
                             <p class="text-sm text-slate-500 font-medium">Relatório de Posição Consolidada</p>
                         </div>
                    </div>
                    <div class="text-right">
                        <p class="text-base font-bold text-slate-700">Henrique</p>
                        <p class="text-xs text-slate-500 mt-1">${dateTimeStr}</p>
                    </div>
                </div>
            `;

            html += smallSpacer;

            // Resumo
            html += `
                <div class="bg-slate-50 p-8 rounded-2xl border border-slate-200 flex justify-between shadow-sm">
                    <div>
                        <p class="text-xs font-bold text-slate-500 uppercase tracking-wider mb-3">Patrimônio Total</p>
                        <h2 class="text-2xl font-bold text-slate-800 tracking-tight">${formatCurrency(metrics.totalValue)}</h2>
                    </div>
                    <div class="text-right">
                        <p class="text-xs font-bold text-slate-500 uppercase tracking-wider mb-3">Resultado Acumulado</p>
                        <h2 class="text-2xl font-bold ${metrics.profit >= 0 ? 'text-emerald-600' : 'text-red-600'} tracking-tight">
                            ${metrics.profit >= 0 ? '+' : ''}${formatCurrency(metrics.profit)}
                            <span class="text-sm font-bold align-middle ml-2 opacity-80">(${metrics.profitPerc.toFixed(2)}%)</span>
                        </h2>
                    </div>
                </div>
            `;

            html += spacer;

            // SEÇÃO CAIXA (MOVIDO PARA ANTES DO TOP 10)
            // Fonte reduzida de text-3xl para text-2xl
            html += `
                <div class="bg-gradient-to-r from-blue-50 to-white p-6 rounded-xl border border-blue-100 flex items-center gap-6 shadow-sm break-inside-avoid">
                    <div class="w-14 h-14 bg-white rounded-full flex items-center justify-center text-blue-600 text-2xl shadow-sm border border-blue-50">
                        <i class="fa-solid fa-wallet"></i>
                    </div>
                    <div>
                        <h3 class="font-bold text-xs text-slate-500 uppercase tracking-widest mb-1">Caixa Disponível</h3>
                        <p class="text-2xl font-bold text-slate-800">${formatCurrency(caixaVal)}</p>
                    </div>
                </div>
            `;

            html += spacer;

            // Função helper para consolidar lista total para Top 10 (COM AGRUPAMENTO)
            const getAllAssets = () => {
                let groupedAssets = {};

                const add = (list, cat) => list.forEach(item => {
                    let cur = item.current;
                    let inv = item.invested;
                    // Chave de agrupamento: Ticker ou Issuer ou Nome
                    const key = item.ticker || item.issuer || item.name || item.type;

                    if (cat === 'Renda Variável') {
                        cur = item.quantity * item.currentPrice;
                        inv = item.quantity * item.avgPrice;
                        if (item.currency === 'USD') { cur *= currentUsdRate; inv *= currentUsdRate; }
                    }

                    if (!groupedAssets[key]) {
                        groupedAssets[key] = {
                            name: key,
                            cat: cat,
                            current: 0,
                            invested: 0
                        };
                    }

                    groupedAssets[key].current += cur;
                    groupedAssets[key].invested += inv;
                });

                add(window.mockReservaAssets, 'Reserva');
                add(window.mockRendaFixaAssets, 'Renda Fixa');
                add(window.mockTesouroAssets, 'Tesouro');
                add(window.mockRendaVariavelAssets, 'Renda Variável');

                // Converte de volta para array e calcula rentabilidade do grupo
                return Object.values(groupedAssets).map(item => ({
                    name: item.name,
                    cat: item.cat,
                    profit: item.current - item.invested,
                    profitPerc: item.invested > 0 ? ((item.current - item.invested) / item.invested) * 100 : 0
                }));
            };

            // Top 10 Rentabilidade
            const top10 = getAllAssets().sort((a, b) => b.profitPerc - a.profitPerc).slice(0, 10);
            if (top10.length > 0) {
                let rowsTop = '';
                top10.forEach((item, i) => {
                    rowsTop += `
                        <tr class="border-b border-slate-100 text-sm">
                            <td class="py-3 pl-3 font-bold text-slate-400 w-10">#${i + 1}</td>
                            <td class="py-3 font-semibold text-slate-700">${item.name}</td>
                            <td class="py-3 text-slate-500 text-xs uppercase tracking-wide">${item.cat}</td>
                            <td class="py-3 text-right font-bold ${item.profitPerc >= 0 ? 'text-emerald-600' : 'text-red-600'} pr-3">${item.profitPerc >= 0 ? '+' : ''}${item.profitPerc.toFixed(2)}%</td>
                        </tr>`;
                });

                html += `
                    <div>
                        <h3 class="font-bold text-base text-slate-800 mb-6 uppercase tracking-wider border-b-2 border-slate-100 pb-3 flex items-center gap-2">
                            <i class="fa-solid fa-ranking-star text-yellow-500"></i> Top 10 Rentabilidade
                        </h3>
                        <div class="bg-white rounded-xl border border-slate-100 overflow-hidden">
                            <table class="w-full text-left">
                                <thead class="bg-slate-50 text-[10px] font-bold text-slate-400 uppercase tracking-wider border-b border-slate-100">
                                    <tr>
                                        <th class="py-3 pl-3">Rank</th>
                                        <th class="py-3">Ativo</th>
                                        <th class="py-3">Categoria</th>
                                        <th class="py-3 text-right pr-3">Rentabilidade</th>
                                    </tr>
                                </thead>
                                <tbody>${rowsTop}</tbody>
                            </table>
                        </div>
                    </div>
                `;
                html += spacer;
            }

            // Função de Tabela Genérica
            const createTable = (title, items, isVariable = false, grouped = false, subHeader = false) => {
                if (items.length === 0) return '';
                let rows = '';
                let subTotal = 0;

                items.forEach(item => {
                    let currentVal = item.current;
                    let investedVal = item.invested;
                    let displayName = item.name || item.ticker || item.issuer || item.type;
                    let displayInfo = item.maturity ? formatDate(item.maturity) : '-';

                    if (isVariable) {
                        currentVal = item.quantity * item.currentPrice;
                        investedVal = item.quantity * item.avgPrice;
                        if (item.currency === 'USD') { currentVal *= currentUsdRate; investedVal *= currentUsdRate; }
                        displayInfo = item.quantity;
                    }

                    if (grouped) {
                        currentVal = item.current;
                        investedVal = item.invested;
                        displayInfo = item.qty ? item.qty.toFixed(2) : '-';
                    }

                    subTotal += currentVal;
                    const profit = currentVal - investedVal;
                    const profitClass = profit >= 0 ? 'text-emerald-600' : 'text-red-600';

                    rows += `
                        <tr class="border-b border-slate-50 text-xs hover:bg-slate-50/50">
                            <td class="py-3 pl-3 font-medium text-slate-700">${displayName}</td>
                            <td class="py-3 text-center text-slate-500">${displayInfo}</td>
                            <td class="py-3 text-right text-slate-500">${formatCurrency(investedVal)}</td>
                            <td class="py-3 text-right font-bold text-slate-800">${formatCurrency(currentVal)}</td>
                            <td class="py-3 text-right font-bold ${profitClass} pr-3">${profit >= 0 ? '+' : ''}${formatCurrency(profit)}</td>
                        </tr>
                    `;
                });

                const titleBlock = subHeader
                    ? `<h4 class="font-bold text-sm text-primary mb-3 mt-0 uppercase tracking-wider pl-2 border-l-2 border-primary/30">${title}</h4>`
                    : `<h3 class="font-bold text-lg text-primary mb-4 border-b border-primary/20 pb-2 uppercase flex items-center gap-2"><div class="w-1.5 h-6 bg-primary rounded-full"></div> ${title}</h3>`;

                // Removidas classes mb-* e usado o spacer externo ou interno se for subheader
                let blockHtml = `
                    <div class="break-inside-avoid">
                        ${titleBlock}
                        <div class="border border-slate-200 rounded-lg overflow-hidden">
                            <table class="w-full text-left">
                                <thead class="bg-slate-100/50 text-[10px] font-bold text-slate-500 uppercase tracking-wider border-b border-slate-200">
                                    <tr>
                                        <th class="py-2 pl-3">Ativo</th>
                                        <th class="py-2 text-center">${isVariable || grouped ? 'Qtd/Info' : 'Vencimento'}</th>
                                        <th class="py-2 text-right">Investido</th>
                                        <th class="py-2 text-right">Valor Atual</th>
                                        <th class="py-2 text-right pr-3">Resultado</th>
                                    </tr>
                                </thead>
                                <tbody>${rows}</tbody>
                                <tfoot class="bg-slate-50 border-t border-slate-200">
                                    <tr class="font-bold text-xs text-slate-800">
                                        <td class="py-3 pl-3" colspan="3">Total ${title}</td>
                                        <td class="py-3 text-right">${formatCurrency(subTotal)}</td>
                                        <td class="py-3"></td>
                                    </tr>
                                </tfoot>
                            </table>
                        </div>
                    </div>
                `;

                if (subHeader) {
                    // Se for subheader, daremos um espaçamento menor antes dele, mas dentro do bloco pai
                    return '<div style="height: 30px;"></div>' + blockHtml;
                }

                return blockHtml;
            };

            // 1. Reserva e Renda Fixa
            if (window.mockReservaAssets.length > 0) {
                // QUEBRA DE PÁGINA FORÇADA ANTES DA RESERVA (PÁGINA 2)
                html += '<div style="page-break-before: always;"></div>';
                html += createTable('Reserva de Emergência', window.mockReservaAssets);
                html += spacer;
            }
            if (window.mockRendaFixaAssets.length > 0) {
                html += createTable('Renda Fixa', window.mockRendaFixaAssets);
                html += spacer;
            }

            // 2. Tesouro Direto
            if (window.mockTesouroAssets.length > 0) {
                const tGrouped = window.mockTesouroAssets.reduce((acc, curr) => {
                    const name = curr.issuer; // Título
                    if (!acc[name]) acc[name] = { name: name, invested: 0, current: 0, qty: 0 };
                    acc[name].invested += curr.invested;
                    acc[name].current += curr.current;
                    acc[name].qty += (curr.quantity || 0);
                    return acc;
                }, {});
                const tList = Object.values(tGrouped).sort((a, b) => b.current - a.current);
                html += createTable('Tesouro Direto (Consolidado)', tList, false, true);
                html += spacer;
            }

            // 3. Renda Variável
            if (window.mockRendaVariavelAssets.length > 0) {
                const rvAssets = window.mockRendaVariavelAssets;
                const filterRV = (t) => rvAssets.filter(a => (a.type || 'Ação') === t);

                const acoes = filterRV('Ação');
                const fiis = rvAssets.filter(a => ['FII', 'FIIs'].includes(a.type));
                const exterior = rvAssets.filter(a => ['Stock', 'ETF', 'REIT', 'Exterior'].includes(a.type) || a.currency === 'USD');
                const cripto = rvAssets.filter(a => ['Cripto', 'Crypto'].includes(a.type));
                const others = rvAssets.filter(a => !['Ação', 'FII', 'FIIs', 'Cripto', 'Crypto'].includes(a.type) && !exterior.includes(a));

                // Abre Seção Pai
                html += `
                    <div>
                         <h3 class="font-bold text-lg text-primary mb-4 border-b border-primary/20 pb-2 uppercase flex items-center gap-2">
                            <div class="w-1.5 h-6 bg-primary rounded-full"></div> Renda Variável
                         </h3>
                         <div class="pl-2">
                `;

                // Remover o espaçamento inicial do primeiro item
                let first = true;
                const addTable = (t, d) => {
                    let tbl = createTable(t, d, true, false, true);
                    if (first) {
                        tbl = tbl.replace('<div style="height: 30px;"></div>', ''); // Remove o spacer top do primeiro
                        first = false;
                    }
                    html += tbl;
                };

                if (acoes.length > 0) addTable('Ações', acoes);
                if (fiis.length > 0) addTable('Fundos Imobiliários', fiis);
                if (exterior.length > 0) addTable('Investimento no Exterior', exterior);
                if (cripto.length > 0) addTable('Criptoativos', cripto);
                if (others.length > 0) addTable('Outros RV', others);

                html += `</div></div>`;
            }

            reportContainer.innerHTML = html;

            // Configurações do html2pdf
            const opt = {
                margin: 10,
                filename: `relatorio-investimentos-${now.toISOString().split('T')[0]}.pdf`,
                image: { type: 'jpeg', quality: 0.98 },
                html2canvas: { scale: 2, useCORS: true },
                jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
            };

            // Gera e Salva
            html2pdf().set(opt).from(reportContainer).save();
        };

        function renderAssetTable(assets, tableBodyId, totalId, profitId, profitPercId) {
            const tbody = document.getElementById(tableBodyId); if (!tbody) return; tbody.innerHTML = '';
            let totalVal = 0; let totalInvest = 0;
            const sortedAssets = [...assets].sort((a, b) => new Date(a.maturity) - new Date(b.maturity));
            sortedAssets.forEach(item => {
                totalVal += item.current; totalInvest += item.invested;
                const profit = item.current - item.invested; const profitPerc = item.invested > 0 ? (profit / item.invested) * 100 : 0;

                // Lógica de Cor e Sinal
                const profitClass = profit >= 0 ? 'text-emerald-600' : 'text-red-600';
                const profitSign = profit >= 0 ? '+' : '';
                const percClass = profit >= 0 ? 'text-emerald-500' : 'text-red-500';

                const daysLeft = calculateDays(item.maturity);
                let daysDisplay = `<span class="text-xs font-medium px-2 py-1 rounded-full bg-slate-100 text-slate-600">${daysLeft} dias</span>`;
                let liqIconClass = "text-slate-400 hover:text-emerald-600";
                if (daysLeft <= 0) { daysDisplay = `<span class="text-xs font-bold px-2 py-1 rounded-full bg-red-100 text-red-700">Vencido</span>`; liqIconClass = "text-red-500 hover:text-red-700 animate-pulse"; }
                else if (daysLeft < 90) { daysDisplay = `<span class="text-xs font-medium px-2 py-1 rounded-full bg-orange-100 text-orange-700">${daysLeft} dias</span>`; if (daysLeft < 15) liqIconClass = "text-yellow-500 hover:text-yellow-600"; }

                const tr = document.createElement('tr'); tr.className = "hover:bg-slate-50 dark:hover:bg-slate-700/50 border-b border-slate-50 dark:border-slate-800 transition-colors";
                tr.innerHTML = `<td class="px-6 py-4 pl-6"><span class="px-2 py-1 text-xs font-bold rounded bg-blue-50 dark:bg-blue-900/30 text-blue-700 dark:text-blue-400 border border-blue-100 dark:border-blue-800 whitespace-nowrap">${item.type}</span></td><td class="px-6 py-4 font-medium text-slate-700 dark:text-slate-200">${item.issuer}</td><td class="px-6 py-4 text-slate-600 dark:text-slate-400">${formatDate(item.maturity)}</td><td class="px-6 py-4 text-center">${daysDisplay}</td><td class="px-6 py-4 text-right text-slate-500 dark:text-slate-400">${formatCurrency(item.invested)}</td><td class="px-6 py-4 text-center text-xs font-medium bg-slate-50 dark:bg-slate-800 rounded text-slate-600 dark:text-slate-400">${item.rate}</td><td class="px-6 py-4 text-slate-600 dark:text-slate-400">${item.broker}</td><td class="px-6 py-4 text-right font-bold text-slate-800 dark:text-slate-100">${formatCurrency(item.current)}</td><td class="px-6 py-4 text-right"><div class="${profitClass} font-bold text-sm">${profitSign}${formatCurrency(profit)}</div><div class="${percClass} text-xs">${profitSign}${profitPerc.toFixed(2)}%</div></td><td class="px-6 py-4 text-center pr-6"><div class="flex items-center justify-center gap-3"><button onclick="openLiquidationModal('${item.id}')" class="${liqIconClass} transition-colors p-1" title="Liquidar"><i class="fa-solid fa-hand-holding-dollar text-lg"></i></button><button onclick="openEditModal('${item.id}')" class="text-slate-400 hover:text-blue-600 transition-colors p-1" title="Editar"><i class="fa-solid fa-pen"></i></button><button onclick="openDeleteModal('${item.id}')" class="text-slate-400 hover:text-red-500 transition-colors p-1" title="Remover"><i class="fa-solid fa-trash"></i></button></div></td>`;
                tbody.appendChild(tr);
            });
            if (totalId) document.getElementById(totalId).textContent = formatCurrency(totalVal);

            if (profitId) {
                const totalProfit = totalVal - totalInvest;
                const totalProfitEl = document.getElementById(profitId);
                totalProfitEl.textContent = (totalProfit >= 0 ? '+' : '') + formatCurrency(totalProfit);
                totalProfitEl.className = `text-3xl font-bold ${totalProfit >= 0 ? 'text-emerald-600' : 'text-red-600'}`;
            }
            if (profitPercId) {
                const totalProfit = totalVal - totalInvest;
                const perc = totalInvest > 0 ? ((totalProfit / totalInvest) * 100) : 0;
                const totalPercEl = document.getElementById(profitPercId);
                totalPercEl.textContent = (perc >= 0 ? '+' : '') + perc.toFixed(2) + '%';
                totalPercEl.className = `text-sm font-medium ${perc >= 0 ? 'text-emerald-600 bg-emerald-50' : 'text-red-600 bg-red-50'} px-2 rounded`;
            }
        }

        function renderTesouro(filter = window.currentTesouroFilter || 'all') {
            window.currentTesouroFilter = filter;
            const tbody = document.getElementById('tesouro-table-body'); if (!tbody) return;

            // --- PRESERVE STATE ---
            const expandedIssuers = new Set();
            const existingGroups = tbody.querySelectorAll('tr[id^="group-tesouro-"]');
            existingGroups.forEach(row => {
                const index = row.id.split('-').pop();
                const icon = document.getElementById(`icon-tesouro-${index}`);
                if (icon && icon.classList.contains('rotate-90')) {
                    const issuer = row.querySelector('span.font-bold')?.textContent;
                    if (issuer) expandedIssuers.add(issuer);
                }
            });

            tbody.innerHTML = ''; let totalVal = 0; let totalInvest = 0;

            document.querySelectorAll('.tesouro-filter-btn').forEach(btn => {
                const btnText = btn.innerText;
                let isActive = false;
                if (filter === 'all' && btnText === 'Todos') isActive = true;
                else if (filter === 'Selic' && btnText === 'Selic') isActive = true;
                else if (filter === 'IPCA' && btnText === 'IPCA+') isActive = true;
                else if (filter === 'Renda+' && btnText === 'Renda+') isActive = true;
                else if (filter === 'Prefixado' && btnText.includes('Pré')) isActive = true;

                if (isActive) {
                    btn.classList.remove('bg-slate-100', 'text-slate-600');
                    btn.classList.add('bg-primary', 'text-white', 'font-bold');
                    btn.classList.remove('font-medium');
                } else {
                    btn.classList.remove('bg-primary', 'text-white', 'font-bold');
                    btn.classList.add('bg-slate-100', 'text-slate-600', 'font-medium');
                }
            });

            const filtered = window.mockTesouroAssets.filter(a => {
                if (filter === 'all') return true;
                if (filter === 'Selic') return a.type.includes('Selic');
                if (filter === 'IPCA') return a.type.includes('IPCA') && !a.type.includes('Renda+');
                if (filter === 'Renda+') return a.type.includes('Renda+');
                if (filter === 'Prefixado') return a.type.includes('Prefixado') || a.type.includes('Pré-fixado');
                return false;
            });

            const grouped = filtered.reduce((acc, curr) => { if (!acc[curr.issuer]) acc[curr.issuer] = []; acc[curr.issuer].push(curr); return acc; }, {});
            const sortedKeys = Object.keys(grouped).sort((a, b) => {
                const dateA = new Date(grouped[a][0].maturity);
                const dateB = new Date(grouped[b][0].maturity);
                return dateA - dateB;
            });
            sortedKeys.forEach((issuer, index) => {
                const group = grouped[issuer].sort((a, b) => new Date(a.dateInv) - new Date(b.dateInv)); const groupInvested = group.reduce((sum, item) => sum + item.invested, 0); const groupCurrent = group.reduce((sum, item) => sum + item.current, 0); const groupProfit = groupCurrent - groupInvested; const groupProfitPerc = groupInvested > 0 ? (groupProfit / groupInvested) * 100 : 0; const maturity = group[0].maturity; const daysLeft = calculateDays(maturity); const groupQty = group.reduce((sum, item) => sum + (item.quantity || 0), 0); totalVal += groupCurrent; totalInvest += groupInvested;

                // Lógica Visual Grupo
                const profitClass = groupProfit >= 0 ? 'text-emerald-600' : 'text-red-600';
                const profitSign = groupProfit >= 0 ? '+' : '';
                const percClass = groupProfit >= 0 ? 'text-emerald-500' : 'text-red-500';

                // Verifica se deve manter expandido
                const isExpanded = expandedIssuers.has(issuer);
                const iconClassRotate = isExpanded ? 'rotate-90' : '';
                const childRowClass = isExpanded ? '' : 'hidden';

                const tr = document.createElement('tr'); tr.className = "hover:bg-slate-50 dark:hover:bg-slate-700/50 transition-colors border-b border-slate-100 dark:border-slate-800 cursor-pointer group"; tr.id = `group-tesouro-${index}`;
                tr.innerHTML = `<td class="px-6 py-4 pl-6 flex items-center gap-3"><div class="w-6 h-6 rounded bg-slate-100 dark:bg-slate-800 flex items-center justify-center text-slate-500 dark:text-slate-400 transition-transform duration-200 cursor-pointer hover:bg-slate-200 dark:hover:bg-slate-700 ${iconClassRotate}" onclick="toggleGroup('tesouro-${index}')" id="icon-tesouro-${index}"><i class="fa-solid fa-chevron-right text-xs"></i></div><div><span class="font-bold text-slate-800 dark:text-slate-100">${issuer}</span><span class="text-xs text-slate-400 block">${group.length} aporte(s)</span></div></td><td class="px-6 py-4 text-center text-slate-600 dark:text-slate-400 font-medium">${groupQty > 0 ? groupQty.toFixed(2) : '-'}</td><td class="px-6 py-4 text-slate-600 dark:text-slate-400">${formatDate(maturity)}</td><td class="px-6 py-4 text-center"><span class="text-xs font-medium px-2 py-1 rounded-full bg-slate-100 dark:bg-slate-800 text-slate-600 dark:text-slate-400">${daysLeft} dias</span></td><td class="px-6 py-4 text-right font-medium text-slate-600 dark:text-slate-400">${formatCurrency(groupInvested)}</td><td class="px-6 py-4 text-right font-bold text-slate-800 dark:text-slate-100">${formatCurrency(groupCurrent)}</td><td class="px-6 py-4 text-right"><div class="${profitClass} font-bold text-sm">${profitSign}${formatCurrency(groupProfit)}</div><div class="${percClass} text-xs">${profitSign}${groupProfitPerc.toFixed(2)}%</div></td><td class="px-6 py-4 text-center flex items-center justify-center gap-3"><button onclick="event.stopPropagation(); openInvestModal({ category: 'tesouro', type: '${group[0].type}', issuer: '${issuer}', maturity: '${maturity}' })" class="bg-blue-50 dark:bg-blue-900/30 text-primary dark:text-blue-400 hover:bg-blue-100 dark:hover:bg-blue-800/50 px-3 py-1.5 rounded-lg text-xs font-bold transition-colors border border-blue-100 dark:border-blue-800 flex items-center gap-1"><i class="fa-solid fa-plus"></i> Aportar</button><span class="text-xs text-slate-300 cursor-pointer hover:text-primary transition-colors" onclick="event.stopPropagation(); toggleGroup('tesouro-${index}')">Expandir</span></td>`;
                tbody.appendChild(tr);

                group.forEach(item => {
                    const profit = item.current - item.invested;
                    // Lógica Visual Item
                    const itemProfitClass = profit >= 0 ? 'text-emerald-600' : 'text-red-600';
                    const itemSign = profit >= 0 ? '+' : '';

                    const childTr = document.createElement('tr'); childTr.className = `${childRowClass} child-row border-b border-slate-50 text-sm group-tesouro-${index}`;
                    childTr.innerHTML = `<td class="px-6 py-3 text-slate-500 dark:text-slate-400 text-xs">Aporte ${formatDate(item.dateInv)}</td><td class="px-6 py-3 text-center text-slate-500 dark:text-slate-400 text-xs">${item.quantity ? item.quantity.toFixed(2) : '-'}</td><td colspan="2"></td><td class="px-6 py-3 text-right text-slate-500 dark:text-slate-400">${formatCurrency(item.invested)}</td><td class="px-6 py-3 text-right text-slate-700 dark:text-slate-200 font-medium">${formatCurrency(item.current)}</td><td class="px-6 py-3 text-right ${itemProfitClass} text-xs">${itemSign}${formatCurrency(profit)}</td><td class="px-6 py-3 text-center"><div class="flex items-center justify-center gap-3"><button onclick="openLiquidationModal('${item.id}')" class="text-slate-400 hover:text-emerald-600 p-1"><i class="fa-solid fa-hand-holding-dollar"></i></button><button onclick="openEditModal('${item.id}')" class="text-slate-400 hover:text-blue-600 p-1"><i class="fa-solid fa-pen"></i></button><button onclick="openDeleteModal('${item.id}')" class="text-slate-400 hover:text-red-500 p-1"><i class="fa-solid fa-trash"></i></button></div></td>`; tbody.appendChild(childTr);
                });
            });

            // Totais Globais
            const totalProfit = totalVal - totalInvest;
            const totalPerc = totalInvest > 0 ? ((totalProfit / totalInvest) * 100) : 0;
            document.getElementById('tesouro-total').textContent = formatCurrency(totalVal);

            const pEl = document.getElementById('tesouro-profit');
            pEl.textContent = (totalProfit >= 0 ? '+' : '') + formatCurrency(totalProfit);
            pEl.className = `text-3xl font-bold ${totalProfit >= 0 ? 'text-emerald-600' : 'text-red-600'}`;

            const ppEl = document.getElementById('tesouro-profit-perc');
            ppEl.textContent = (totalPerc >= 0 ? '+' : '') + totalPerc.toFixed(2) + '%';
            ppEl.className = `text-sm font-medium ${totalPerc >= 0 ? 'text-emerald-600' : 'text-red-600'}`;
        }

        function renderReserva() {
            const tbody = document.getElementById('reserva-table-body'); if (!tbody) return; tbody.innerHTML = '';
            // FIXED: Procura em ambas as listas
            const tesouroSelic = window.mockTesouroAssets.filter(a => a.type && a.type.toLowerCase().includes('selic'));
            const allAssets = [...window.mockReservaAssets, ...tesouroSelic];

            let totalVal = 0; let totalInvest = 0;

            // Agrupar
            const grouped = allAssets.reduce((acc, curr) => {
                if (!acc[curr.issuer]) acc[curr.issuer] = [];
                acc[curr.issuer].push(curr);
                return acc;
            }, {});

            Object.keys(grouped).forEach((issuer, index) => {
                const group = grouped[issuer];

                // Cálculos do Grupo
                const groupInvested = group.reduce((sum, item) => sum + item.invested, 0);
                const groupCurrent = group.reduce((sum, item) => sum + item.current, 0);
                const groupProfit = groupCurrent - groupInvested;
                const groupProfitPerc = groupInvested > 0 ? (groupProfit / groupInvested) * 100 : 0;

                const firstItem = group[0];
                const maturity = firstItem.maturity;
                const daysLeft = calculateDays(maturity);
                const type = firstItem.type;
                const rate = firstItem.rate;
                const broker = group.length > 1 ? 'Vários' : firstItem.broker;

                totalVal += groupCurrent;
                totalInvest += groupInvested;

                // Lógica Visual do Grupo
                let daysDisplay = `<span class="text-xs font-medium px-2 py-1 rounded-full bg-slate-100 text-slate-600">${daysLeft} dias</span>`;
                if (daysLeft <= 0) daysDisplay = `<span class="text-xs font-bold px-2 py-1 rounded-full bg-red-100 text-red-700">Vencido</span>`;
                else if (daysLeft < 90) daysDisplay = `<span class="text-xs font-medium px-2 py-1 rounded-full bg-orange-100 text-orange-700">${daysLeft} dias</span>`;

                const profitClass = groupProfit >= 0 ? 'text-emerald-600' : 'text-red-600';
                const profitSign = groupProfit >= 0 ? '+' : '';
                const percClass = groupProfit >= 0 ? 'text-emerald-500' : 'text-red-500';

                const tr = document.createElement('tr');
                tr.className = "hover:bg-slate-50 dark:hover:bg-slate-700/50 border-b border-slate-100 dark:border-slate-800 group transition-colors";
                tr.id = `group-reserva-${index}`;

                // HTML da linha do grupo
                tr.innerHTML = `
                    <td class="px-6 py-4 pl-6 flex items-center gap-3">
                        <div class="w-6 h-6 rounded bg-slate-100 flex items-center justify-center text-slate-500 transition-transform duration-200 cursor-pointer hover:bg-slate-200" onclick="toggleGroup('reserva-${index}')" id="icon-reserva-${index}">
                            <i class="fa-solid fa-chevron-right text-xs"></i>
                        </div>
                        <span class="px-2 py-1 text-xs font-bold rounded bg-blue-50 text-blue-700 border border-blue-100 whitespace-nowrap">${type}</span>
                    </td>
                    <td class="px-6 py-4">
                        <span class="font-bold text-slate-800 dark:text-slate-100">${issuer}</span>
                        ${group.length > 1 ? `<span class="text-xs text-slate-400 block">${group.length} aporte(s)</span>` : ''}
                    </td>
                    <td class="px-6 py-4 text-slate-600">${formatDate(maturity)}</td>
                    <td class="px-6 py-4 text-center">${daysDisplay}</td>
                    <td class="px-6 py-4 text-right font-medium text-slate-600">${formatCurrency(groupInvested)}</td>
                    <td class="px-6 py-4 text-center text-xs font-medium bg-slate-50 rounded text-slate-600">${rate}</td>
                    <td class="px-6 py-4 text-slate-600">${broker}</td>
                    <td class="px-6 py-4 text-right font-bold text-slate-800">${formatCurrency(groupCurrent)}</td>
                    <td class="px-6 py-4 text-right">
                        <div class="${profitClass} font-bold text-sm">${profitSign}${formatCurrency(groupProfit)}</div>
                        <div class="${percClass} text-xs">${profitSign}${groupProfitPerc.toFixed(2)}%</div>
                    </td>
                    <td class="px-6 py-4 text-center text-slate-300 text-xs">${group.length > 1 ? 'Expandir' : ''}</td>
                `;

                // Se for item único, coloca botões de ação na linha principal
                if (group.length === 1) {
                    let liqIconClass = daysLeft < 15 ? "text-yellow-500 hover:text-yellow-600" : "text-slate-400 hover:text-emerald-600";
                    if (daysLeft <= 0) liqIconClass = "text-red-500 hover:text-red-700 animate-pulse";
                    tr.querySelector('td:last-child').innerHTML = `<div class="flex items-center justify-center gap-3"><button onclick="openLiquidationModal('${firstItem.id}')" class="${liqIconClass} transition-colors p-1"><i class="fa-solid fa-hand-holding-dollar text-lg"></i></button><button onclick="openEditModal('${firstItem.id}')" class="text-slate-400 hover:text-blue-600 transition-colors p-1"><i class="fa-solid fa-pen"></i></button><button onclick="openDeleteModal('${firstItem.id}')" class="text-slate-400 hover:text-red-500 transition-colors p-1"><i class="fa-solid fa-trash"></i></button></div>`;
                }

                tbody.appendChild(tr);

                // Linhas Filhas (para grupos com > 1 item)
                if (group.length > 1) {
                    group.forEach(item => {
                        const profit = item.current - item.invested;
                        const itemProfitClass = profit >= 0 ? 'text-emerald-600' : 'text-red-600';
                        const itemSign = profit >= 0 ? '+' : '';

                        let liqIconClass = "text-slate-400 hover:text-emerald-600";
                        const iDays = calculateDays(item.maturity);
                        if (iDays < 15) liqIconClass = "text-yellow-500 hover:text-yellow-600";
                        if (iDays <= 0) liqIconClass = "text-red-500 hover:text-red-700";

                        const childTr = document.createElement('tr');
                        childTr.className = `hidden child-row border-b border-slate-50 text-sm group-reserva-${index}`;

                        childTr.innerHTML = `
                            <td class="px-6 py-3 text-slate-500 text-xs" colspan="2">Aporte ${formatDate(item.dateInv)} via ${item.broker}</td>
                            <td colspan="2"></td>
                            <td class="px-6 py-3 text-right text-slate-500">${formatCurrency(item.invested)}</td>
                            <td colspan="2"></td>
                            <td class="px-6 py-3 text-right text-slate-700 font-medium">${formatCurrency(item.current)}</td>
                            <td class="px-6 py-3 text-right ${itemProfitClass} text-xs">${itemSign}${formatCurrency(profit)}</td>
                            <td class="px-6 py-3 text-center">
                                <div class="flex items-center justify-center gap-3">
                                    <button onclick="openLiquidationModal('${item.id}')" class="${liqIconClass} p-1"><i class="fa-solid fa-hand-holding-dollar"></i></button>
                                    <button onclick="openEditModal('${item.id}')" class="text-slate-400 hover:text-blue-600 p-1"><i class="fa-solid fa-pen"></i></button>
                                    <button onclick="openDeleteModal('${item.id}')" class="text-slate-400 hover:text-red-500 p-1"><i class="fa-solid fa-trash"></i></button>
                                </div>
                            </td>
                        `;
                        tbody.appendChild(childTr);
                    });
                }
            });

            // Totais Globais da Reserva
            const totalProfit = totalVal - totalInvest;
            const totalPerc = totalInvest > 0 ? ((totalProfit / totalInvest) * 100) : 0;

            document.getElementById('reserva-total').textContent = formatCurrency(totalVal);

            const pEl = document.getElementById('reserva-profit');
            pEl.textContent = (totalProfit >= 0 ? '+' : '') + formatCurrency(totalProfit);
            pEl.className = `text-3xl font-bold ${totalProfit >= 0 ? 'text-emerald-600' : 'text-red-600'}`;

            const ppEl = document.getElementById('reserva-profit-perc');
            ppEl.textContent = (totalPerc >= 0 ? '+' : '') + totalPerc.toFixed(2) + '%';
            ppEl.className = `text-sm font-medium ${totalPerc >= 0 ? 'text-emerald-600 bg-emerald-50' : 'text-red-600 bg-red-50'} px-2 rounded`;
        }

        function toggleGroup(groupId) {
            const children = document.querySelectorAll(`.group-${groupId}`);
            const icon = document.getElementById(`icon-${groupId}`);
            let isHidden = true;
            children.forEach(row => { if (row.classList.contains('hidden')) { row.classList.remove('hidden'); isHidden = false; } else { row.classList.add('hidden'); } });
            if (isHidden) { icon.style.transform = "rotate(0deg)"; icon.classList.remove('bg-blue-100', 'text-primary'); icon.classList.add('bg-slate-100', 'text-slate-500'); } else { icon.style.transform = "rotate(90deg)"; icon.classList.remove('bg-slate-100', 'text-slate-500'); icon.classList.add('bg-blue-100', 'text-primary'); }
        }

        // Helper to calculate 12m Average Proventos
        window.calculateProventosAverage = () => {
            const now = new Date();
            const twelveMonthsAgo = new Date(now);
            twelveMonthsAgo.setFullYear(now.getFullYear() - 1);

            let total12m = 0;
            const provs = window.proventos || [];

            provs.forEach(p => {
                const parts = p.date.split('-');
                const d = new Date(parts[0], parts[1] - 1, parts[2]); // Local Time

                if (d >= twelveMonthsAgo && d <= now) {
                    let val = parseFloat(p.value);
                    if (p.currency === 'USD') {
                        if (p.exchangeRate) val *= p.exchangeRate;
                        else val *= (window.currentUsdRate || 5.0);
                    }
                    total12m += val;
                }
            });

            return total12m / 12;
        };

        function renderRendaVariavel(filter = window.currentRvFilter || 'all') {
            window.currentRvFilter = filter;
            const tbody = document.getElementById('rv-table-body'); if (!tbody) return;

            // Update Average Card (Running calculation here ensures it updates on render)
            const avgProv = window.calculateProventosAverage();
            const avgEl = document.getElementById('rv-avg-prov');
            if (avgEl) avgEl.textContent = formatCurrency(avgProv);

            // --- PRESERVE STATE ---
            const expandedTickers = new Set();
            const existingGroups = tbody.querySelectorAll('tr[id^="group-rv-"]');
            existingGroups.forEach(row => {
                const index = row.id.split('-').pop();
                const icon = document.getElementById(`icon-rv-${index}`);
                if (icon && icon.classList.contains('rotate-90')) {
                    const ticker = row.querySelector('span.font-bold')?.textContent;
                    if (ticker) expandedTickers.add(ticker);
                }
            });

            tbody.innerHTML = '';
            let totalEquityBRL = 0; let totalCostBRL = 0;
            const totalPortfolio = calculateTotalPortfolio();

            document.querySelectorAll('.rv-filter-btn').forEach(btn => {
                const isSelected = btn.getAttribute('onclick').includes(`'${filter}'`);
                if (isSelected) {
                    btn.classList.remove('bg-slate-100', 'text-slate-600');
                    btn.classList.add('bg-primary', 'text-white');
                } else {
                    btn.classList.remove('bg-primary', 'text-white');
                    btn.classList.add('bg-slate-100', 'text-slate-600');
                }
            });

            const grouped = window.mockRendaVariavelAssets.reduce((acc, curr) => {
                if (!acc[curr.ticker]) { acc[curr.ticker] = { ...curr, quantity: 0, investedBRL: 0, totalNative: 0, aportes: [] }; }
                const totalNative = curr.quantity * curr.currentPrice; const costNative = curr.quantity * curr.avgPrice;
                acc[curr.ticker].quantity += curr.quantity; acc[curr.ticker].totalNative += totalNative;
                acc[curr.ticker].investedBRL += (curr.currency === 'USD' ? costNative * currentUsdRate : costNative);
                acc[curr.ticker].aportes.push(curr);
                acc[curr.ticker].avgPrice = (acc[curr.ticker].investedBRL / acc[curr.ticker].quantity) / (curr.currency === 'USD' ? currentUsdRate : 1);
                return acc;
            }, {});

            // --- VALIDAÇÃO DE METAS ---
            const goalTotals = {};
            window.mockRendaVariavelAssets.forEach(a => {
                const goal = window.rvAssetGoals[a.ticker] || 0;
                if (!goalTotals[a.type]) goalTotals[a.type] = 0;
                // Evita somar duplicado se tiver multiplos aportes do mesmo ticker (mockAssets tem todos os aportes)
                // Mas mockRendaVariavelAssets é uma lista plana de aportes.
                // Preciso iterar Tickers únicos.
            });
            // Melhor usar 'grouped' que já agrupa por ticker
            Object.values(grouped).forEach(g => {
                const goal = window.rvAssetGoals[g.ticker] || 0;
                if (!goalTotals[g.type]) goalTotals[g.type] = 0;
                goalTotals[g.type] += goal;
            });

            const warningContainer = document.getElementById('rv-goals-warning');
            if (warningContainer) warningContainer.remove();

            const violations = Object.entries(goalTotals).filter(([type, total]) => total > 100);
            if (violations.length > 0) {
                const div = document.createElement('div');
                div.id = 'rv-goals-warning';
                div.className = "bg-red-50 border-l-4 border-red-500 p-4 mb-6 rounded-r shadow-sm flex items-start gap-3";
                const msg = violations.map(([type, total]) => `<b>${type}</b>: ${total.toFixed(1)}%`).join(', ');
                div.innerHTML = `<i class="fa-solid fa-triangle-exclamation text-red-500 mt-1"></i><div><p class="font-bold text-red-700 text-sm">Atenção: A soma das metas excede 100% nas categorias:</p><p class="text-sm text-red-600">${msg}</p></div>`;
                const mainView = document.getElementById('view-renda-variavel');
                if (mainView) mainView.prepend(div);
            }

            // --- CÁLCULO DE MTRICAS GLOBAIS (Simulando Rebalanceamento) ---
            // Precisamos do Total do Portfólio + Caixa para saber o Target Real
            const caixaInput = document.getElementById('reb-caixa');
            const caixaVal = caixaInput ? window.parseCurrencyValue(caixaInput.value) : 0;

            // Recalcula totais globais (Reserva, RF, Tesouro, RV)
            let globalTotal = 0;
            window.mockReservaAssets.forEach(a => globalTotal += a.current);
            window.mockTesouroAssets.forEach(a => globalTotal += a.current);
            window.mockRendaFixaAssets.forEach(a => globalTotal += a.current);
            window.mockRendaVariavelAssets.forEach(a => {
                let v = a.quantity * a.currentPrice;
                if (a.currency === 'USD') v *= currentUsdRate;
                globalTotal += v;
            });

            const totalPortfolioWithCaixa = globalTotal + caixaVal;

            const sortedTickers = Object.values(grouped).filter(a => filter === 'all' || a.type === filter).sort((a, b) => a.ticker.localeCompare(b.ticker));

            sortedTickers.forEach((group, index) => {
                let currentValBRL = group.totalNative; if (group.currency === 'USD') currentValBRL *= currentUsdRate;
                totalEquityBRL += currentValBRL; totalCostBRL += group.investedBRL;
                const profitBRL = currentValBRL - group.investedBRL; const profitPerc = group.investedBRL > 0 ? (profitBRL / group.investedBRL) * 100 : 0;

                // Lógica Visual Grupo
                const profitClass = profitBRL >= 0 ? 'text-emerald-600' : 'text-red-600';
                const profitSign = profitBRL >= 0 ? '+' : '';
                const percClass = profitBRL >= 0 ? 'text-emerald-500' : 'text-red-500';

                // Recommendation Logic
                let typeKey = group.type;
                if (typeKey === 'Ação') typeKey = 'Ações';
                if (typeKey === 'FII') typeKey = 'FIIs';

                // 1. Get Global Metrics & Targets from Rebalancing Logic
                const caixaInput = document.getElementById('reb-caixa');
                const caixaVal = caixaInput ? window.parseCurrencyValue(caixaInput.value) : 0;

                // Recalculate Total Portfolio (similar to calculateGlobalMetrics but we need it here)
                // We use the simpler method: Sum of current displayed assets + Caixa
                // Note: 'totalPortfolio' variable must be defined in the scope. 
                // Since this is inside a loop, we should calculate 'totalPortfolio' OUTSIDE loop. 
                // Converting this block to use pre-calculated values passed/calculated above.

                // ... Assuming I add the calculation at top of function ...
                // For now, let's use the locally accessible 'totalPortfolioWithCaixa' (to be defined)

                const subCategoryGoalPerc = rebalanceGoals['renda-variavel'].subs[typeKey] || 0;

                // CÁLCULO DO "CAIXA" DA SUBCATEGORIA (GAP)
                // Quanto falta para encher a subcategoria Ações, FIIs, etc.
                // Isso replica a lógica da tela de Rebalanceamento
                // Precisamos saber o Total Atual da Subcategoria.
                // Como 'grouped' tem todos os ativos, podemos somar agora ou ter pré-calculado.

                // Fail-safe: calculate subcategory total on the fly if needed, or rely on pre-calc.
                // Let's rely on a helper or just iterate 'grouped' once before this loop.
                const subTotalCurrent = Object.values(grouped)
                    .filter(g => {
                        let t = g.type; if (t === 'Ação') t = 'Ações'; if (t === 'FII') t = 'FIIs';
                        return t === typeKey;
                    })
                    .reduce((acc, g) => {
                        let v = g.totalNative; if (g.currency === 'USD') v *= currentUsdRate;
                        return acc + v;
                    }, 0);

                const subCategoryTargetVal = totalPortfolioWithCaixa * (subCategoryGoalPerc / 100);
                const subCategoryGap = subCategoryTargetVal - subTotalCurrent;

                // ASSET CALCULATION
                const assetGoalPerc = rvAssetGoals[group.ticker] || 0;
                // Target Value of Asset = (Total Portfolio) * (SubCat %) * (Asset %)
                const targetValue = totalPortfolioWithCaixa * (subCategoryGoalPerc / 100) * (assetGoalPerc / 100);

                // Recommendation Algorithm:
                // 1. If Subcategory is overweight (Gap <= 0), DO NOT BUY anything (Hold).
                // 2. If Subcategory has space (Gap > 0), suggest buying, but cap at the Subcategory Gap? 
                //    Or simply show the Asset Gap?
                //    User said: "With this value [Category Gap]... recommendations should be suggested".
                //    This usually means: Distribute the Category Gap among the assets that need it.
                //    Simplest robust interpretation: Show Buy ONLY if (Asset Gap > 0) AND (Category Gap > 0).

                const gap = targetValue - currentValBRL;

                let recText = '<span class="text-slate-400 font-medium">Aguardar</span>';
                let recClass = "bg-slate-100 text-slate-500";

                // Só sugere compra se a Categoria tem espaço E o Ativo está abaixo da meta
                if (subCategoryGap > 0 && gap > 0) {
                    // O valor sugerido deve ser o menor entre o Gap do Ativo e o Gap da Categoria?
                    // Se eu tenho 1k de espaço na categoria, e AAPL precisa de 500, compro 500.
                    // Se AAPL precisa de 2k, mas só tenho 1k na categoria... compro 1k?
                    // User: "Funciona como uma espécie de caixa".
                    // Se comprarmos 1k para AAPL, enchemos a categoria.
                    // Mas se tivermos OUTRO ativo (MSFT) que também precisa...
                    // A soma das recomendações não deveria estourar o Gap da Categoria.
                    // Sem um passo de normalização global prévio, é difícil garantir a soma exata.
                    // Para MVP AGORA: Sugerimos o Gap do Ativo. (A "Caixa" é o norte, se passar um pouco na soma visual tudo bem, 
                    // mas o importante é bloquear compras quando a caixa está fechada/negativa).
                    // Refinamento: Se (Gap > SubCategoryGap), cap? 
                    // Talvez não, pois se tivermos 10 ativos precisando, vamos sugerir comprar tudo e estourar.
                    // Mas o bloqueio de "SubCategoryGap <= 0" já resolve 90% do problema de alocação macro.

                    const suggestedAmount = gap;
                    let amountDisplay = `R$ ${Math.floor(suggestedAmount)}`;

                    if (group.currency === 'USD') {
                        const usdAmount = suggestedAmount / currentUsdRate;
                        amountDisplay += ` <span class="text-[10px] text-slate-400 font-normal ml-1">(US$ ${formatCurrency(usdAmount).replace('R$', '')})</span>`;
                    }

                    recText = `Comprar <span class="font-bold flex items-center justify-center">${amountDisplay}</span>`;
                    recClass = "bg-blue-50 text-blue-600 border border-blue-100";
                }

                // Verifica se deve manter expandido
                const isExpanded = expandedTickers.has(group.ticker);
                const iconClassRotate = isExpanded ? 'rotate-90' : '';
                const childRowClass = isExpanded ? '' : 'hidden';
                const iconBgClass = isExpanded ? 'bg-blue-100 text-primary' : 'bg-slate-100 text-slate-500'; // Ajuste de cor do ícone

                const currencyBadge = group.currency === 'USD' ? `<span class="ml-2 px-1.5 py-0.5 text-[9px] font-bold bg-yellow-100 text-yellow-700 rounded border border-yellow-200">USD</span>` : '';
                const tr = document.createElement('tr'); tr.className = "hover:bg-slate-50 dark:hover:bg-slate-700/50 border-b border-slate-50 dark:border-slate-800 last:border-0 group transition-colors"; tr.id = `group-rv-${index}`;
                tr.innerHTML = `<td class="px-6 py-4 pl-6"><div class="flex items-center gap-3"><div class="w-6 h-6 rounded flex items-center justify-center transition-transform duration-200 cursor-pointer hover:bg-slate-200 dark:hover:bg-slate-700 ${iconBgClass} ${iconClassRotate}" onclick="event.stopPropagation(); toggleGroup('rv-${index}')" id="icon-rv-${index}"><i class="fa-solid fa-chevron-right text-xs"></i></div><div class="flex flex-col"><div class="flex items-center"><span class="font-bold text-slate-800 dark:text-slate-100">${group.ticker}</span>${currencyBadge}</div><span class="text-[10px] text-slate-400 uppercase tracking-wider">${group.type}</span></div></div></td><td class="px-6 py-4 text-center"><div class="flex items-center justify-center gap-1 group/edit"><input type="number" value="${assetGoalPerc}" onchange="updateAssetGoal('${group.ticker}', this.value)" class="w-12 text-center bg-transparent border-b border-transparent hover:border-slate-300 dark:hover:border-slate-500 focus:border-primary outline-none font-bold text-slate-700 dark:text-slate-200 transition-colors"><span class="text-xs text-slate-400 font-bold">%</span></div></td><td class="px-6 py-4 text-right text-slate-600 dark:text-slate-400">${group.quantity.toFixed(4).replace(/\.?0+$/, '')}</td><td class="px-6 py-4 text-right"><div class="flex flex-col items-end"><span class="text-xs text-slate-400">PM: ${formatCurrency(group.avgPrice, group.currency)}</span><span class="font-bold text-slate-700 dark:text-slate-300">${formatCurrency(group.currentPrice, group.currency)}</span></div></td><td class="px-6 py-4 text-right font-bold text-slate-800 dark:text-slate-100">${formatCurrency(currentValBRL, 'BRL')}${group.currency === 'USD' ? `<div class="text-[10px] text-slate-400 font-normal">${formatCurrency(group.totalNative, 'USD')}</div>` : ''}</td><td class="px-6 py-4 text-right"><div class="${profitClass} font-bold text-sm">${profitSign}${formatCurrency(profitBRL, 'BRL')}</div><div class="${percClass} text-xs">${profitSign}${profitPerc.toFixed(2)}%</div></td><td class="px-6 py-4 text-center"><span class="inline-block px-3 py-1 rounded-lg text-xs font-medium ${recClass}">${recText}</span></td><td class="px-6 py-4 text-center pr-6 flex items-center justify-center gap-3"><button onclick="event.stopPropagation(); openInvestModal({ category: 'renda-variavel', type: '${group.type}', ticker: '${group.ticker}', currency: '${group.currency}' })" class="bg-emerald-50 dark:bg-emerald-900/30 text-emerald-600 dark:text-emerald-400 hover:bg-emerald-100 dark:hover:bg-emerald-800/50 px-3 py-1.5 rounded-lg text-xs font-bold transition-colors border border-emerald-100 dark:border-emerald-800 flex items-center gap-1"><i class="fa-solid fa-plus"></i> Aportar</button><span class="text-xs text-slate-300 cursor-pointer hover:text-primary transition-colors" onclick="event.stopPropagation(); toggleGroup('rv-${index}')">Expandir</span></td>`;
                tbody.appendChild(tr);

                group.aportes.sort((a, b) => new Date(a.dateInv) - new Date(b.dateInv)).forEach(item => {
                    const itemTotal = item.quantity * item.currentPrice; const itemProfit = itemTotal - (item.quantity * item.avgPrice); let itemTotalBRL = itemTotal; if (item.currency === 'USD') { itemTotalBRL *= currentUsdRate; }
                    const childTr = document.createElement('tr'); childTr.className = `${childRowClass} child-row border-b border-slate-50 dark:border-slate-800 text-sm group-rv-${index}`;

                    // Lógica Visual Item
                    let itemProfitVal = item.currency === 'USD' ? itemProfit * currentUsdRate : itemProfit;
                    const itemProfitClass = itemProfitVal >= 0 ? 'text-emerald-600' : 'text-red-600';
                    const itemSign = itemProfitVal >= 0 ? '+' : '';

                    childTr.innerHTML = `<td class="px-6 py-3 text-slate-500 text-xs pl-12" colspan="2"><i class="fa-regular fa-calendar mr-1"></i> ${formatDate(item.dateInv)} <span class="mx-2">•</span> ${item.broker}</td><td class="px-6 py-3 text-right text-slate-500 text-xs">${item.quantity}</td><td class="px-6 py-3 text-right text-slate-500 text-xs">Pago: ${formatCurrency(item.avgPrice, item.currency)}</td><td class="px-6 py-3 text-right text-slate-600 font-medium text-xs">${formatCurrency(itemTotalBRL, 'BRL')}</td><td class="px-6 py-3 text-right text-xs" colspan="2"></td><td class="px-6 py-3 text-center"><div class="flex items-center justify-center gap-3"><button onclick="openLiquidationModal('${item.id}')" class="text-slate-400 hover:text-emerald-600 p-1" title="Liquidar"><i class="fa-solid fa-hand-holding-dollar text-lg"></i></button><button onclick="openEditModal('${item.id}')" class="text-slate-400 hover:text-blue-600 p-1" title="Editar"><i class="fa-solid fa-pen"></i></button><button onclick="openDeleteModal('${item.id}')" class="text-slate-400 hover:text-red-500 p-1" title="Remover"><i class="fa-solid fa-trash"></i></button></div></td>`;
                    tbody.appendChild(childTr);
                });
            });

            document.getElementById('rv-total').textContent = formatCurrency(totalEquityBRL);
            const globalProfit = totalEquityBRL - totalCostBRL; const globalProfitPerc = totalCostBRL > 0 ? (globalProfit / totalCostBRL) * 100 : 0;
            const pEl = document.getElementById('rv-profit'); const ppEl = document.getElementById('rv-profit-perc');
            pEl.textContent = (globalProfit >= 0 ? '+' : '') + formatCurrency(globalProfit); ppEl.textContent = (globalProfitPerc >= 0 ? '+' : '') + globalProfitPerc.toFixed(2) + '%';
            if (globalProfit < 0) { pEl.className = "text-3xl font-bold text-red-600"; ppEl.className = "text-sm font-medium text-red-600 bg-red-50 px-2 rounded"; } else { pEl.className = "text-3xl font-bold text-emerald-600"; ppEl.className = "text-sm font-medium text-emerald-600 bg-emerald-50 px-2 rounded"; }
        }

        window.updateAssetGoal = (ticker, val) => {
            window.rvAssetGoals[ticker] = parseFloat(val);
            if (window.firebaseSaveAssetGoals) window.firebaseSaveAssetGoals(window.rvAssetGoals);
            renderRendaVariavel(window.currentRvFilter);
        };
        window.updateGoal = (catId, val) => {
            window.rebalanceGoals[catId].target = parseFloat(val);
            if (window.firebaseSaveRebalanceGoals) window.firebaseSaveRebalanceGoals(window.rebalanceGoals);
            renderRebalanceamento();
        };
        window.updateSubGoal = (catId, subKey, val) => {
            window.rebalanceGoals[catId].subs[subKey] = parseFloat(val);
            if (window.firebaseSaveRebalanceGoals) window.firebaseSaveRebalanceGoals(window.rebalanceGoals);
            renderRebalanceamento();
        };

        // Helper para mudar rentabilidade automaticamente no Tesouro
        window.autoSelectRateType = () => {
            const type = document.getElementById('input-type').value;
            const rateType = document.getElementById('input-rate-type');
            if (!rateType) return;

            if (type.includes('Selic')) rateType.value = 'Selic';
            else if (type.includes('IPCA') || type.includes('Renda+')) rateType.value = 'IPCA';
            else if (type.includes('Prefixado')) rateType.value = 'PRE';
        };

        // Helper para atualizar símbolo da moeda (R$ / US$) na tela de Renda Variável
        window.updateCurrencySymbol = () => {
            const currency = document.getElementById('input-currency').value;
            const symbol = currency === 'USD' ? 'US$' : 'R$';
            const spans = document.querySelectorAll('.dynamic-currency-symbol');
            spans.forEach(span => span.textContent = symbol);
        };

        // Helper para selecionar moeda automaticamente baseada na categoria (RV)
        window.autoSelectCurrency = () => {
            const type = document.getElementById('input-type').value;
            const currency = document.getElementById('input-currency');
            if (!currency) return;

            if (type === 'Exterior' || type === 'Cripto') {
                currency.value = 'USD';
            } else {
                currency.value = 'BRL';
            }
            // Atualiza os símbolos visuais (R$/US$)
            updateCurrencySymbol();
        };

        function renderRendaFixa() { renderAssetTable(window.mockRendaFixaAssets, 'renda-fixa-table-body', 'renda-fixa-total', 'renda-fixa-profit', 'renda-fixa-profit-perc'); renderBondLadder(); renderIndexerChart(); }

        function renderTopDividendPayers(filter = 'all') {
            const tbody = document.getElementById('top-dividend-body');
            if (!tbody) return;
            tbody.innerHTML = '';

            // Update Buttons
            const buttons = ['all', 'acao', 'fii', 'exterior'];
            buttons.forEach(key => {
                const btn = document.getElementById(`btn-top-div-${key}`);
                if (!btn) return;
                let isActive = false;
                if (filter === 'all' && key === 'all') isActive = true;
                if (filter === 'Ação' && key === 'acao') isActive = true;
                if (filter === 'FII' && key === 'fii') isActive = true;
                if (filter === 'Exterior' && key === 'exterior') isActive = true;

                if (isActive) {
                    btn.classList.remove('text-slate-500', 'hover:text-slate-700', 'font-medium');
                    btn.classList.add('bg-white', 'text-slate-800', 'shadow-sm', 'font-bold');
                } else {
                    btn.classList.add('text-slate-500', 'hover:text-slate-700', 'font-medium');
                    btn.classList.remove('bg-white', 'text-slate-800', 'shadow-sm', 'font-bold');
                }
            });

            const now = new Date();
            const twelveMonthsAgo = new Date(now);
            twelveMonthsAgo.setFullYear(now.getFullYear() - 1);

            // Aggregate
            const aggregated = {};
            const provs = window.proventos || [];

            provs.forEach(p => {
                const parts = p.date.split('-');
                const d = new Date(parts[0], parts[1] - 1, parts[2]);

                if (d >= twelveMonthsAgo && d <= now) {
                    // Filter Check
                    if (filter !== 'all') {
                        const cat = p.category;
                        let match = false;
                        if (filter === 'Ação') match = (cat === 'Ação' || cat === 'BDR');
                        else if (filter === 'FII') match = (cat === 'FII');
                        else if (filter === 'Exterior') match = (cat === 'Exterior' || cat === 'BDR' || p.currency === 'USD');

                        if (!match && !cat) {
                            const asset = window.mockRendaVariavelAssets.find(a => a.ticker === p.asset);
                            if (asset) {
                                const t = asset.type;
                                if (filter === 'Ação' && t === 'Ação') match = true;
                                if (filter === 'FII' && t === 'FII') match = true;
                                if (filter === 'Exterior' && (t === 'Exterior' || t === 'Stock')) match = true;
                            }
                        }

                        if (!match) return;
                    }

                    const key = p.asset;
                    if (!aggregated[key]) aggregated[key] = { asset: key, value: 0, currency: p.currency, category: p.category };

                    let val = parseFloat(p.value);
                    if (p.currency === 'USD') {
                        if (p.exchangeRate) val *= p.exchangeRate;
                        else val *= (window.currentUsdRate || 5.0);
                    }
                    aggregated[key].value += val;
                }
            });

            // Convert to Array and Sort
            const sorted = Object.values(aggregated).sort((a, b) => b.value - a.value).slice(0, 7);

            if (sorted.length === 0) {
                tbody.innerHTML = `<tr><td colspan="4" class="px-6 py-8 text-center text-slate-400">Nenhum provento encontrado</td></tr>`;
                return;
            }

            sorted.forEach((item, index) => {
                const rank = index + 1;
                let rankIcon = `<span class="font-bold text-slate-400 w-6 h-6 flex items-center justify-center rounded-full bg-slate-100 text-xs">${rank}</span>`;

                if (rank === 1) rankIcon = `<span class="w-6 h-6 flex items-center justify-center text-lg">🥇</span>`;
                if (rank === 2) rankIcon = `<span class="w-6 h-6 flex items-center justify-center text-lg">🥈</span>`;
                if (rank === 3) rankIcon = `<span class="w-6 h-6 flex items-center justify-center text-lg">🥉</span>`;

                let catDisplay = item.category || '-';
                if (!item.category || item.category === 'Outros') {
                    const assetInfo = window.mockRendaVariavelAssets.find(a => a.ticker === item.asset);
                    if (assetInfo) catDisplay = assetInfo.type;
                }

                const tr = document.createElement('tr');
                tr.className = "hover:bg-slate-50 dark:hover:bg-slate-700/50 transition-colors border-b border-slate-50 dark:border-slate-800 last:border-0";
                tr.innerHTML = `
                    <td class="px-6 py-4 text-center flex justify-center">${rankIcon}</td>
                    <td class="px-6 py-4 font-bold text-slate-800 dark:text-slate-100">${item.asset}</td>
                    <td class="px-6 py-4"><span class="px-2 py-1 bg-slate-100 dark:bg-slate-800 rounded text-xs text-slate-600 dark:text-slate-400 font-bold">${catDisplay}</span></td>
                    <td class="px-6 py-4 text-right font-bold text-emerald-600">+${formatCurrency(item.value)}</td>
                `;
                tbody.appendChild(tr);
            });
        }

        function renderDashboard() {
            const metrics = calculateGlobalMetrics();
            document.getElementById('dash-total-balance').textContent = formatCurrency(metrics.totalValue);

            // Atualiza valor do lucro
            const profitEl = document.getElementById('dash-total-profit');
            profitEl.textContent = (metrics.profit >= 0 ? '+' : '') + formatCurrency(metrics.profit);

            // Atualiza porcentagem e cores
            const profitPercEl = document.getElementById('dash-total-profit-perc');
            profitPercEl.textContent = (metrics.profitPerc >= 0 ? '+' : '') + metrics.profitPerc.toFixed(2) + '%';

            if (metrics.profit >= 0) {
                profitPercEl.className = "text-sm font-bold px-2 py-0.5 rounded-lg bg-emerald-100 text-emerald-700";
                profitEl.classList.remove('text-red-600');
                profitEl.classList.add('text-slate-800');
            } else {
                profitPercEl.className = "text-sm font-bold px-2 py-0.5 rounded-lg bg-red-100 text-red-700";
                profitEl.classList.remove('text-slate-800');
                profitEl.classList.add('text-red-600');
            }

            renderGoalCard(metrics.totalValue);
            renderTopDividendPayers(); // Initial Render

            const tbody = document.getElementById('dash-assets-body');
            if (tbody) {
                tbody.innerHTML = '';

                // 1. Agrega ativos pelo Nome/Ticker para evitar duplicatas (ex: vários Tesouro Selic)
                const aggMap = new Map();

                const addToAgg = (key, cat, invested, current, quantity, isVariable, unitPrice, currency) => {
                    if (!aggMap.has(key)) {
                        aggMap.set(key, {
                            name: key,
                            categoryDisplay: cat,
                            totalInvested: 0,
                            totalCurrent: 0,
                            totalQuantity: 0,
                            isVariable: isVariable,
                            currency: currency
                        });
                    }
                    const entry = aggMap.get(key);
                    entry.totalInvested += invested;
                    entry.totalCurrent += current;
                    entry.totalQuantity += (quantity || 0);
                    // Mantém a categoria (assumindo que ativos com mesmo nome são da mesma categoria)
                    entry.categoryDisplay = cat;
                };

                // Agrega Renda Fixa / Tesouro / Reserva
                const processFixedAgg = (list, cat) => {
                    list.forEach(a => {
                        const name = a.issuer; // Usa o Nome/Emissor como chave
                        addToAgg(name, cat, a.invested, a.current, 0, false, 0, 'BRL');
                    });
                };

                // Agrega Renda Variável
                const processVariableAgg = (list, cat) => {
                    list.forEach(a => {
                        let investedVal = a.quantity * a.avgPrice;
                        let currentVal = a.quantity * a.currentPrice;
                        if (a.currency === 'USD') {
                            investedVal *= currentUsdRate;
                            currentVal *= currentUsdRate;
                        }
                        const name = a.ticker || a.desc; // Usa Ticker como chave
                        addToAgg(name, cat, investedVal, currentVal, a.quantity, true, a.avgPrice, a.currency);
                    });
                };

                processFixedAgg(window.mockReservaAssets, 'Reserva');
                processFixedAgg(window.mockRendaFixaAssets, 'Renda Fixa');
                processFixedAgg(window.mockTesouroAssets, 'Tesouro');
                processVariableAgg(window.mockRendaVariavelAssets, 'Renda Var.');

                // 2. Converte Map em Array e calcula métricas finais
                const allAssets = Array.from(aggMap.values()).map(entry => {
                    const profit = entry.totalCurrent - entry.totalInvested;
                    const profitPerc = entry.totalInvested > 0 ? (profit / entry.totalInvested) * 100 : 0;

                    // Calcula preço médio ponderado para exibição em RV
                    const avgPrice = entry.isVariable && entry.totalQuantity > 0
                        ? (entry.totalInvested / entry.totalQuantity) // Em Reais convertido se for USD, mas unitCost original?
                        // Se for USD, o totalInvested já está convertido.
                        // Para exibir "Custo original" correto em USD, precisaríamos somar (qtd * custo_original_usd).
                        // Simplificação: recalculamos o PM implícito no valor total investido (em BRL).
                        // Se quiser exibir em USD, é mais complexo. VAMOS MANTER SIMPLES:
                        // Se for RV, vamos exibir o PM Calculado.
                        : 0;

                    // Ajuste reverso para exibir unitário na moeda original se for USD?
                    // O código anterior usava `a.unitCost` direto.
                    // Se tivermos múltiplos aportes em USD, o PM deve ser a média ponderada.
                    let unitCostDisplay = avgPrice;
                    if (entry.currency === 'USD') {
                        unitCostDisplay = unitCostDisplay / currentUsdRate;
                    }

                    return {
                        name: entry.name,
                        categoryDisplay: entry.categoryDisplay,
                        calculatedProfit: profit,
                        calculatedProfitPerc: profitPerc,
                        investedDisplay: entry.totalInvested,
                        unitCost: unitCostDisplay,
                        isVariable: entry.isVariable,
                        currency: entry.currency,
                        quantity: entry.totalQuantity
                    };
                });

                // 3. Ordena por RENTABILIDADE % (maior para menor)
                allAssets.sort((a, b) => b.calculatedProfitPerc - a.calculatedProfitPerc);

                // 4. Pega os 10 primeiros e Renderiza
                allAssets.slice(0, 10).forEach((a, i) => {
                    const tr = document.createElement('tr');
                    tr.className = "hover:bg-slate-50 dark:hover:bg-slate-700/50 border-b border-slate-50 dark:border-slate-800 text-sm";

                    let name = a.name;
                    if (name.length > 25) name = name.substring(0, 25) + '...';

                    // Coluna "Custo / Inv."
                    let costDisplay;
                    if (a.isVariable) {
                        costDisplay = formatCurrency(a.unitCost, a.currency);
                    } else {
                        costDisplay = formatCurrency(a.investedDisplay, 'BRL');
                    }

                    const profitClass = a.calculatedProfit >= 0 ? 'text-emerald-600' : 'text-red-600';
                    const profitSign = a.calculatedProfit >= 0 ? '+' : '';
                    const percentDisplay = a.calculatedProfitPerc.toFixed(2) + '%';

                    // Lógica de Ranking
                    const rank = i + 1;
                    let rankDisplay;
                    if (rank === 1) rankDisplay = `<div class="w-6 h-6 rounded-full bg-yellow-400 text-white flex items-center justify-center shadow-sm mx-auto"><i class="fa-solid fa-crown text-[10px]"></i></div>`;
                    else if (rank === 2) rankDisplay = `<div class="w-6 h-6 rounded-full bg-slate-300 text-white flex items-center justify-center shadow-sm mx-auto font-bold text-[10px]">2</div>`;
                    else if (rank === 3) rankDisplay = `<div class="w-6 h-6 rounded-full bg-amber-600 text-white flex items-center justify-center shadow-sm mx-auto font-bold text-[10px]">3</div>`;
                    else rankDisplay = `<span class="font-bold text-slate-400 text-xs block text-center">${rank}</span>`;

                    tr.innerHTML = `
                        <td class="px-6 py-4 text-center">${rankDisplay}</td>
                        <td class="px-6 py-4 font-bold text-slate-800 dark:text-slate-100">${name}</td>
                        <td class="px-6 py-4"><span class="px-2 py-1 rounded bg-slate-100 dark:bg-slate-800 text-xs font-bold text-slate-500 dark:text-slate-400">${a.categoryDisplay}</span></td>
                        <td class="px-6 py-4 text-right ${profitClass}">${profitSign}${percentDisplay}</td>
                    `;
                    tbody.appendChild(tr);
                });
            }

            let totals = { 'Reserva': 0, 'Renda Fixa': 0, 'Renda Variável': 0, 'Tesouro': 0, 'Caixa': 0 }; window.mockReservaAssets.forEach(a => totals['Reserva'] += a.current); window.mockRendaFixaAssets.forEach(a => totals['Renda Fixa'] += a.current); window.mockTesouroAssets.forEach(a => totals['Tesouro'] += a.current); window.mockRendaVariavelAssets.forEach(a => { let v = a.quantity * a.currentPrice; if (a.currency === 'USD') v *= currentUsdRate; totals['Renda Variável'] += v; }); totals['Caixa'] = window.availableCash || 0; renderChart(totals);
        }

        function renderGoalCard(currentValue) {
            const container = document.getElementById('goal-card-content');
            if (annualGoal <= 0) {
                container.innerHTML = `<p class="text-primary-light text-sm font-medium mb-1">Meta Anual</p><div class="flex flex-col items-center justify-center h-20 text-center"><p class="text-white font-bold text-base mb-1 leading-tight">Que tal estabelecer a sua meta?</p><button onclick="openGoalModal()" class="bg-white text-primary px-4 py-1.5 rounded-full text-xs font-bold hover:bg-slate-100 transition-colors">Definir Meta</button></div>`;
            } else {
                const percentage = Math.min(100, (currentValue / annualGoal) * 100);
                if (percentage >= 100) {
                    container.innerHTML = `<p class="text-primary-light text-sm font-medium mb-1">Meta Anual</p><div class="h-20 flex flex-col justify-center items-center text-center"><i class="fa-solid fa-trophy text-yellow-300 text-2xl mb-1 scale-up-center"></i><p class="text-white font-bold text-sm leading-tight">Parabéns! Meta Atingida 🎉</p><p class="text-[10px] text-primary-light mt-0.5">Você alcançou ${formatCurrency(annualGoal)}</p></div>`;
                } else {
                    container.innerHTML = `<div class="flex justify-between items-end mb-2"><p class="text-primary-light text-sm font-medium">Meta Anual</p><span class="text-2xl font-bold">${percentage.toFixed(1)}%</span></div><div class="w-full bg-black/20 rounded-full h-2.5 mb-3 overflow-hidden"><div class="bg-white h-2.5 rounded-full transition-all duration-1000 ease-out" style="width: ${percentage}%"></div></div><div class="flex justify-between text-xs text-primary-light"><span>Atual: ${formatCurrency(currentValue)}</span><span>Meta: ${formatCurrency(annualGoal)}</span></div>`;
                }
            }
        }

        const goalModal = document.getElementById('goal-modal');
        const goalInput = document.getElementById('goal-input');
        window.openGoalModal = () => { goalInput.value = annualGoal > 0 ? annualGoal : ''; goalModal.classList.remove('hidden'); setTimeout(() => { goalModal.classList.remove('opacity-0'); goalModal.querySelector('div').classList.remove('opacity-0', 'scale-95'); goalModal.querySelector('div').classList.add('scale-100'); }, 10); };
        window.closeGoalModal = () => { goalModal.classList.add('opacity-0'); goalModal.querySelector('div').classList.remove('scale-100'); goalModal.querySelector('div').classList.add('opacity-0', 'scale-95'); setTimeout(() => goalModal.classList.add('hidden'), 300); };
        window.saveGoal = () => {
            if (!validateInputs('goal-modal')) return;

            const val = parseFloat(goalInput.value);
            if (val > 0) {
                window.firebaseSaveGoal(val);
                closeGoalModal();
                showSuccessMessage("Meta definida com sucesso!");
            } else {
                alert("Por favor, insira um valor válido.");
            }
        };

        function renderRebalanceamento() {
            // Preservação de Foco e Valor (Contra Updates Externos)
            const activeId = document.activeElement ? document.activeElement.id : null;
            let selectionStart = null, selectionEnd = null;
            let activeValue = null; // Captura o valor exato que o usuário digitou

            if (activeId && (document.activeElement.tagName === 'INPUT' || document.activeElement.tagName === 'TEXTAREA')) {
                selectionStart = document.activeElement.selectionStart;
                selectionEnd = document.activeElement.selectionEnd;
                activeValue = document.activeElement.value; // Salva o valor "cru" (ex: "5.")
            }

            const container = document.getElementById('rebalance-container'); const caixaInput = document.getElementById('reb-caixa'); const caixa = window.parseCurrencyValue(caixaInput.value);
            let totals = { 'reserva': 0, 'renda-fixa': 0, 'renda-variavel': 0, 'aposentadoria': 0 };
            let subTotals = {
                'reserva': { 'Reserva': 0, 'Tesouro Selic': 0 },
                'renda-fixa': { 'Renda Fixa CDI': 0, 'Renda Fixa IPCA': 0, 'Tesouro IPCA': 0 },
                'renda-variavel': { 'Ações': 0, 'FIIs': 0, 'Exterior': 0, 'Cripto': 0 },
                'aposentadoria': { 'Tesouro Renda+': 0 }
            };

            // 1. Reserva e Tesouro Selic
            window.mockReservaAssets.forEach(a => {
                totals['reserva'] += a.current;
                subTotals['reserva']['Reserva'] += a.current;
            });

            // 2. Tesouro Direto
            window.mockTesouroAssets.forEach(a => {
                const type = a.type || '';
                const current = a.current;

                if (type.includes('Selic')) {
                    totals['reserva'] += current;
                    subTotals['reserva']['Tesouro Selic'] += current;
                } else if (type.includes('Renda+')) {
                    totals['aposentadoria'] += current;
                    subTotals['aposentadoria']['Tesouro Renda+'] += current;
                } else {
                    // Tesouro IPCA+ (e Pré-fixado como fallback para 'Apenas esses')
                    totals['renda-fixa'] += current;

                    // Categorização mais precisa para Subcategorias de Renda Fixa
                    const rate = a.rate || '';
                    if (rate.includes('IPCA') || type.includes('IPCA')) {
                        // Verifica se é Tesouro ou Privado
                        if (a.issuer === 'Tesouro Nacional' || type.includes('Tesouro')) {
                            subTotals['renda-fixa']['Tesouro IPCA'] += current;
                        } else {
                            subTotals['renda-fixa']['Renda Fixa IPCA'] += current;
                        }
                    } else {
                        // CDI, Pré ou Outros -> Renda Fixa CDI (Simplificação)
                        subTotals['renda-fixa']['Renda Fixa CDI'] += current;
                    }
                }
            });

            // 3. Renda Fixa Privada (LCI, LCA, CDB - Mock)
            window.mockRendaFixaAssets.forEach(a => {
                totals['renda-fixa'] += a.current;
                const rate = a.rate || '';
                if (rate.includes('IPCA')) {
                    subTotals['renda-fixa']['Renda Fixa IPCA'] += a.current;
                } else {
                    subTotals['renda-fixa']['Renda Fixa CDI'] += a.current;
                }
            });

            // 4. Renda Variável
            window.mockRendaVariavelAssets.forEach(a => {
                const current = (a.quantity * a.currentPrice * (a.currency === 'USD' ? currentUsdRate : 1));
                totals['renda-variavel'] += current;

                const type = a.type || 'Ação';
                const ticker = a.ticker || '';

                // Mapeamento Singular -> Plural
                if (type === 'Ação' || type === 'Ações') subTotals['renda-variavel']['Ações'] += current;
                else if (type === 'FII' || type === 'FIIs') subTotals['renda-variavel']['FIIs'] += current;
                else if (type === 'Cripto' || type === 'Crypto') subTotals['renda-variavel']['Cripto'] += current;
                else if (type === 'Stock' || type === 'ETF' || type === 'REIT' || a.currency === 'USD') subTotals['renda-variavel']['Exterior'] += current;
                else subTotals['renda-variavel']['Ações'] += current; // Fallback
            });

            const totalPatrimonio = Object.values(totals).reduce((a, b) => a + b, 0);
            const totalWithCaixa = totalPatrimonio + caixa;
            document.getElementById('reb-total-patrimony').textContent = formatCurrency(totalWithCaixa);

            // Renderiza UI

            // Preserva estado de expansão
            const expandedState = {};
            document.querySelectorAll('[id^="sub-"]').forEach(el => {
                if (!el.classList.contains('hidden')) expandedState[el.id.replace('sub-', '')] = true;
            });

            container.innerHTML = '';

            const categories = [
                { id: 'reserva', name: 'Reserva de Emergência', icon: 'fa-shield-heart', color: 'text-emerald-600', bg: 'bg-emerald-100' },
                { id: 'renda-fixa', name: 'Renda Fixa', icon: 'fa-building-columns', color: 'text-blue-600', bg: 'bg-blue-100' },
                { id: 'renda-variavel', name: 'Renda Variável', icon: 'fa-chart-line', color: 'text-purple-600', bg: 'bg-purple-100' },
                { id: 'aposentadoria', name: 'Aposentadoria', icon: 'fa-umbrella-beach', color: 'text-orange-600', bg: 'bg-orange-100' }
            ];

            const violations = [];

            categories.forEach(cat => {
                const currentVal = totals[cat.id]; const targetPerc = window.rebalanceGoals[cat.id].target; const targetVal = totalWithCaixa * (targetPerc / 100); const difference = targetVal - currentVal; const currentPerc = totalWithCaixa > 0 ? (currentVal / totalWithCaixa * 100) : 0;

                // ORDEM FIXA DAS SUBCATEGORIAS
                let subKeys = [];
                if (cat.id === 'reserva') subKeys = ['Reserva', 'Tesouro Selic'];
                else if (cat.id === 'renda-fixa') subKeys = ['Renda Fixa CDI', 'Renda Fixa IPCA', 'Tesouro IPCA'];
                else if (cat.id === 'renda-variavel') subKeys = ['Ações', 'FIIs', 'Exterior', 'Cripto'];
                else if (cat.id === 'aposentadoria') subKeys = ['Tesouro Renda+'];
                else subKeys = Object.keys(window.rebalanceGoals[cat.id].subs); // Fallback

                // Filter keys that actually exist in goals (in case one is missing for some reason)
                subKeys = subKeys.filter(k => window.rebalanceGoals[cat.id].subs[k] !== undefined);

                // Check if there are extra keys not in fixed list and append them (just in case)
                const allKeys = Object.keys(window.rebalanceGoals[cat.id].subs);
                allKeys.forEach(k => { if (!subKeys.includes(k)) subKeys.push(k); });

                const subPercSum = subKeys.reduce((acc, k) => acc + window.rebalanceGoals[cat.id].subs[k], 0); const isSumCorrect = Math.abs(subPercSum - targetPerc) < 0.1;

                // Validação: Subcategorias não podem exceder a categoria principal
                if (subPercSum > targetPerc + 0.001) {
                    violations.push(`<b>${cat.name}</b>: Soma das subs (${subPercSum.toFixed(1)}%) excede a meta da categoria (${targetPerc.toFixed(1)}%)`);
                }

                const isHiddenClass = expandedState[cat.id] ? '' : 'hidden'; // Usa o estado preservado

                // ADDED: Unique IDs for Inputs & oninput for Local Update
                const item = document.createElement('div'); item.className = "bg-white dark:bg-slate-800 rounded-xl border border-slate-200 dark:border-slate-700 overflow-hidden shadow-sm";
                item.innerHTML = `<div class="p-4 flex items-center justify-between cursor-pointer hover:bg-slate-50 dark:hover:bg-slate-700 transition-colors" onclick="document.getElementById('sub-${cat.id}').classList.toggle('hidden')"><div class="flex items-center gap-4 flex-1"><div class="w-10 h-10 rounded-lg ${cat.bg} ${cat.color} flex items-center justify-center"><i class="fa-solid ${cat.icon}"></i></div><div><h4 class="font-bold text-slate-800 dark:text-slate-100">${cat.name}</h4><div class="flex items-center gap-2 text-xs text-slate-500 dark:text-slate-400"><span>Atual: ${currentPerc.toFixed(1)}%</span></div></div></div><div class="flex items-center gap-6"><div class="text-right flex flex-col items-end"><span class="text-[10px] text-slate-400 font-bold uppercase tracking-wider">Meta</span><div class="flex items-center gap-1"><input type="number" id="goal-${cat.id}" value="${targetPerc}" oninput="updateGoalLocal('${cat.id}', this.value)" onchange="updateGoal('${cat.id}', this.value)" onclick="event.stopPropagation()" class="w-14 text-right border-b border-slate-300 dark:border-slate-600 focus:border-primary outline-none font-bold text-slate-700 dark:text-slate-200">%</div></div><div class="w-32 hidden md:block"><div class="flex justify-between text-[10px] mb-1"><span>Aporte Sugerido</span><span class="${difference > 0 ? 'text-blue-600' : 'text-emerald-600'} font-bold">${difference > 0 ? formatCurrency(difference) : '0,00'}</span></div><div class="h-1.5 w-full bg-slate-100 dark:bg-slate-700 rounded-full overflow-hidden"><div class="h-full ${difference > 0 ? 'bg-blue-500' : 'bg-emerald-500'}" style="width: ${Math.min(100, (currentVal / targetVal) * 100)}%"></div></div></div><i class="fa-solid fa-chevron-down text-slate-300 ml-2"></i></div></div><div id="sub-${cat.id}" class="${isHiddenClass} bg-slate-50/50 dark:bg-slate-900/50 border-t border-slate-100 dark:border-slate-700 p-4 space-y-1">${subKeys.map(subKey => { const subCurrent = subTotals[cat.id][subKey] || 0; const subTargetPerc = window.rebalanceGoals[cat.id].subs[subKey]; const subTargetVal = totalWithCaixa * (subTargetPerc / 100); const subDiff = subTargetVal - subCurrent; return `<div class="flex items-center justify-between text-sm py-2 px-2 rounded hover:bg-slate-100/80 dark:hover:bg-slate-700/80 transition-colors"><div class="flex items-center gap-3 flex-1"><div class="w-1.5 h-1.5 rounded-full ${subDiff > 0 ? 'bg-blue-400' : 'bg-emerald-400'}"></div><span class="text-slate-600 dark:text-slate-400 font-medium">${subKey}</span></div><div class="flex items-center gap-6"><span class="text-slate-400 text-xs w-20 text-right">${formatCurrency(subCurrent)}</span><div class="flex items-center gap-1 w-16 justify-end"><input type="number" id="subgoal-${cat.id}-${subKey.replace(/\s+/g, '_')}" value="${subTargetPerc}" class="w-10 text-right bg-transparent border-b border-slate-300 dark:border-slate-600 focus:border-primary outline-none text-xs font-bold text-slate-600 dark:text-slate-400" oninput="updateSubGoalLocal('${cat.id}', '${subKey}', this.value)" onchange="updateSubGoal('${cat.id}', '${subKey}', this.value)">%</div><div class="w-24 text-right"><span class="text-xs font-bold ${subDiff > 0 ? 'text-blue-600' : 'text-slate-400'}">${subDiff > 0 ? '+' + formatCurrency(subDiff) : '-'}</span></div></div></div>`; }).join('')}</div>`;
                container.appendChild(item);
            });

            if (violations.length > 0) {
                const div = document.createElement('div');
                div.className = "bg-red-50 border-l-4 border-red-500 p-4 mb-6 rounded-r shadow-sm flex items-start gap-3";
                div.innerHTML = `<i class="fa-solid fa-triangle-exclamation text-red-500 mt-1"></i><div><p class="font-bold text-red-700 text-sm">Atenção: A soma das subcategorias excede a meta principal:</p><ul class="text-sm text-red-600 list-disc list-inside">${violations.map(v => `<li>${v}</li>`).join('')}</ul></div>`;
                container.prepend(div);
            }

            // Restauração de Foco e Valor
            if (activeId) {
                const el = document.getElementById(activeId);
                if (el) {
                    // Se o elemento ativo é um dos inputs de meta, restaura o valor "cru" que o usuário estava digitando
                    // Isso impede que um update externo sobrescreva "5." com "5", ou mova o cursor
                    if (activeValue !== null) {
                        el.value = activeValue;
                    }

                    el.focus();
                    if (selectionStart !== null && selectionEnd !== null) {
                        try { el.setSelectionRange(selectionStart, selectionEnd); } catch (e) { }
                    }
                }
            }
        }

        window.updateGoal = (catId, val) => {
            if (window.firebaseSaveRebalanceGoals) window.firebaseSaveRebalanceGoals(window.rebalanceGoals);
        };

        window.updateSubGoal = (catId, subKey, val) => {
            if (window.firebaseSaveRebalanceGoals) window.firebaseSaveRebalanceGoals(window.rebalanceGoals);
        };

        // Immediate Local Updates (oninput) - APENAS ATUALIZA O MODELO, NÃO RENDERIZA
        // Isso evita que a digitação seja interrompida ou formatada incorretamente (ex: "5." virando "5")
        window.updateGoalLocal = (catId, val) => {
            const numVal = parseFloat(val);
            if (!isNaN(numVal)) window.rebalanceGoals[catId].target = numVal;
        };

        window.updateSubGoalLocal = (catId, subKey, val) => {
            if (!window.rebalanceGoals[catId]) return;
            if (!window.rebalanceGoals[catId].subs) window.rebalanceGoals[catId].subs = {};

            const numVal = parseFloat(val);
            if (!isNaN(numVal)) window.rebalanceGoals[catId].subs[subKey] = numVal;
        };

        window.currentHistFilter = 'all';
        function renderHistorico(filter = window.currentHistFilter, searchTerm = '') {
            window.currentHistFilter = filter;
            if (arguments.length === 1 && document.getElementById('hist-search')) {
                searchTerm = document.getElementById('hist-search').value;
            }

            const tbody = document.getElementById('historico-table-body');
            const empty = document.getElementById('historico-empty');
            if (!tbody) return;

            // Update UI State for Buttons
            document.querySelectorAll('.hist-filter-btn').forEach(btn => {
                const btnRef = btn.getAttribute('onclick')?.includes(`'${filter}'`);
                if (btnRef) {
                    btn.className = "hist-filter-btn bg-primary text-white px-4 py-2 rounded-lg text-sm font-bold transition-all whitespace-nowrap";
                } else {
                    btn.className = "hist-filter-btn bg-slate-100 text-slate-600 hover:bg-slate-200 px-4 py-2 rounded-lg text-sm font-medium transition-all whitespace-nowrap";
                }
            });

            tbody.innerHTML = '';

            let filteredHistory = window.liquidationHistory || [];

            // Filter by Category
            if (filter !== 'all') {
                filteredHistory = filteredHistory.filter(item => {
                    const origin = item.origin || '';
                    return origin === filter;
                });
            }

            // Filter by Search
            if (searchTerm) {
                const term = searchTerm.toLowerCase();
                filteredHistory = filteredHistory.filter(item => {
                    const issuer = (item.issuer || '').toLowerCase();
                    const ticker = (item.ticker || '').toLowerCase();
                    const type = (item.type || '').toLowerCase();
                    return issuer.includes(term) || ticker.includes(term) || type.includes(term);
                });
            }

            if (filteredHistory.length === 0) {
                empty.classList.remove('hidden');
                empty.textContent = (window.liquidationHistory || []).length === 0 ? "Nenhum título liquidado." : "Nenhum item encontrado com o filtro atual.";
                return;
            }
            empty.classList.add('hidden');

            filteredHistory.sort((a, b) => new Date(b.liquidationDate) - new Date(a.liquidationDate)).forEach(item => {
                const profit = item.finalValue - item.invested;

                const isPartial = item.liquidationType === 'Parcial';
                let statusBadge = '';

                if (isPartial) {
                    statusBadge = `<span class="px-2 py-1 rounded bg-blue-50 text-blue-600 text-xs font-bold border border-blue-100">Parcial</span>`;
                } else {
                    statusBadge = `<span class="px-2 py-1 rounded bg-emerald-50 text-emerald-600 text-xs font-bold border border-emerald-100">Total</span>`;
                }

                const tr = document.createElement('tr');
                tr.innerHTML = `<td class="px-6 py-4 text-slate-600 dark:text-slate-400">${formatDate(item.liquidationDate)}</td><td class="px-6 py-4"><span class="px-2 py-1 rounded bg-slate-100 dark:bg-slate-800 font-bold text-xs">${item.type}</span></td><td class="px-6 py-4 font-medium text-slate-800 dark:text-slate-100">${item.issuer || item.ticker}</td><td class="px-6 py-4 text-right text-slate-500 dark:text-slate-400">${formatCurrency(item.invested)}</td><td class="px-6 py-4 text-right font-bold text-slate-700 dark:text-slate-200">${formatCurrency(item.finalValue)}</td><td class="px-6 py-4 text-right font-bold ${profit >= 0 ? 'text-emerald-600' : 'text-red-600'}">${profit >= 0 ? '+' : ''}${formatCurrency(profit)}</td><td class="px-6 py-4 text-center">${statusBadge}</td>`;
                tbody.appendChild(tr);
            });
        }

        let myChart = null, bondLadderChart = null, indexerChart = null;
        function renderChart(data) {
            const ctx = document.getElementById('allocationChart').getContext('2d');
            if (!ctx) return;
            if (myChart) myChart.destroy();
            const labels = Object.keys(data);
            const values = Object.values(data);
            myChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels,
                    datasets: [{
                        data: values,
                        backgroundColor: ['#004aad', '#3b82f6', '#60a5fa', '#93c5fd', '#c4b5fd'],
                        borderWidth: 0,
                        hoverOffset: 10
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    cutout: '80%',
                    plugins: {
                        legend: { display: false },
                        datalabels: { display: false }
                    }
                }
            });
            const legendEl = document.getElementById('chart-legend');
            if (legendEl) {
                legendEl.innerHTML = '';
                let total = values.reduce((a, b) => a + b, 0);
                labels.forEach((lbl, i) => {
                    const perc = total > 0 ? ((values[i] / total) * 100).toFixed(1) : 0;
                    legendEl.innerHTML += `<div class="flex items-center justify-between mb-2 text-sm"><div class="flex items-center gap-2"><span class="w-3 h-3 rounded-full" style="background-color: ${['#004aad', '#3b82f6', '#60a5fa', '#93c5fd', '#c4b5fd'][i % 5]}"></span><span class="text-slate-600 dark:text-slate-400">${lbl}</span></div><span class="font-bold text-slate-800 dark:text-slate-100">${perc}%</span></div>`;
                });
            }
        }
        function renderBondLadder() {
            const canvas = document.getElementById('bondLadderChart');
            if (!canvas) return;
            const ctx = canvas.getContext('2d');
            if (bondLadderChart) bondLadderChart.destroy();

            const currentYear = new Date().getFullYear();
            const years = [currentYear, currentYear + 1, currentYear + 2];
            const totals = [0, 0, 0];

            window.mockRendaFixaAssets.forEach(asset => {
                const parts = asset.maturity.split('-');
                const assetYear = parseInt(parts[0]);
                const index = years.indexOf(assetYear);
                if (index !== -1) totals[index] += asset.current;
            });

            const barLabelPlugin = {
                id: 'barLabelPlugin',
                afterDatasetsDraw(chart, args, options) {
                    const { ctx } = chart;
                    chart.data.datasets.forEach((dataset, i) => {
                        const meta = chart.getDatasetMeta(i);
                        if (!meta.hidden) {
                            meta.data.forEach((element, index) => {
                                const data = dataset.data[index];
                                if (data > 0) {
                                    const text = formatCurrency(data, 'BRL');
                                    ctx.font = 'bold 10px Poppins';
                                    ctx.fillStyle = document.documentElement.classList.contains('dark') ? '#cbd5e1' : '#64748b';
                                    ctx.textAlign = 'center';
                                    ctx.textBaseline = 'bottom';
                                    const x = element.x;
                                    const y = element.y - 5;
                                    ctx.fillText(text, x, y);
                                }
                            });
                        }
                    });
                }
            };

            bondLadderChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: years,
                    datasets: [{
                        label: 'Vencimento (R$)',
                        data: totals,
                        backgroundColor: document.documentElement.classList.contains('dark') ? '#3b82f6' : '#004aad',
                        borderRadius: 6,
                        barPercentage: 0.6
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        datalabels: { display: false }, // Disable default datalabels
                        tooltip: { enabled: false }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            display: false,
                            grid: { display: false }
                        },
                        x: {
                            grid: { display: false },
                            border: { display: false }
                        }
                    },
                    layout: {
                        padding: {
                            top: 20
                        }
                    }
                },
                plugins: [barLabelPlugin]
            });
        }
        function renderIndexerChart() {
            const canvas = document.getElementById('indexerChart');
            if (!canvas) return;
            const ctx = canvas.getContext('2d');
            if (indexerChart) indexerChart.destroy();

            let cdi = 0, ipca = 0, pre = 0;
            window.mockRendaFixaAssets.forEach(a => {
                const r = (a.rate || '').toUpperCase();
                if (r.includes('CDI') || r.includes('SELIC')) cdi += a.current;
                else if (r.includes('IPCA') || r.includes('IGPM')) ipca += a.current;
                else pre += a.current;
            });

            const total = cdi + ipca + pre;

            indexerChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['CDI', 'IPCA+', 'Pré'],
                    datasets: [{
                        data: [cdi, ipca, pre],
                        backgroundColor: ['#3b82f6', '#ef4444', '#f59e0b'],
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    cutout: '70%',
                    plugins: {
                        datalabels: { display: false }, // Disable default datalabels
                        legend: {
                            position: 'right',
                            labels: {
                                boxWidth: 8,
                                font: { size: 10 },
                                color: document.documentElement.classList.contains('dark') ? '#cbd5e1' : '#64748b',
                                usePointStyle: true,
                                generateLabels: function (chart) {
                                    const data = chart.data;
                                    if (data.labels.length && data.datasets.length) {
                                        return data.labels.map((label, i) => {
                                            const val = data.datasets[0].data[i];
                                            const perc = total > 0 ? ((val / total) * 100).toFixed(1) : 0;
                                            return {
                                                text: `${label} (${perc}%)`,
                                                fillStyle: data.datasets[0].backgroundColor[i],
                                                hidden: isNaN(data.datasets[0].data[i]) || chart.getDatasetMeta(0).data[i].hidden,
                                                index: i
                                            };
                                        });
                                    }
                                    return [];
                                }
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function (context) {
                                    const val = context.raw;
                                    const perc = total > 0 ? ((val / total) * 100).toFixed(1) : 0;
                                    return ` ${context.label}: ${formatCurrency(val, 'BRL')} (${perc}%)`;
                                }
                            }
                        }
                    }
                }
            });
        }

        // Lógica de Sidebar Mobile
        window.toggleSidebar = () => {
            const sidebar = document.getElementById('main-sidebar');
            const overlay = document.getElementById('sidebar-overlay');
            if (!sidebar || !overlay) return;

            const isHidden = sidebar.classList.contains('hidden');
            if (isHidden) {
                // Abrir
                sidebar.classList.remove('hidden');
                sidebar.classList.add('flex');
                overlay.classList.remove('hidden');
            } else {
                // Fechar
                sidebar.classList.add('hidden');
                sidebar.classList.remove('flex');
                overlay.classList.add('hidden');
            }
        };

        function navigateTo(viewId) {
            // Fecha sidebar no mobile
            const sidebar = document.getElementById('main-sidebar');
            if (sidebar && window.innerWidth < 768 && !sidebar.classList.contains('hidden')) {
                toggleSidebar();
            }

            if (viewId !== 'historico') currentContext = viewId;
            document.querySelectorAll('.sidebar-link').forEach(el => { el.classList.remove('active'); if (el.querySelector('i')) { el.querySelector('i').classList.remove('text-white/90'); el.querySelector('i').classList.add('text-slate-400'); } });
            let menuId = viewId === 'historico' ? (currentContext === 'tesouro' ? 'tesouro' : (currentContext === 'renda-fixa' ? 'renda-fixa' : (currentContext === 'renda-variavel' ? 'renda-variavel' : 'reserva'))) : viewId;
            const activeLink = document.getElementById('nav-' + menuId);
            if (activeLink) { activeLink.classList.add('active'); activeLink.querySelector('i').classList.remove('text-slate-400'); activeLink.querySelector('i').classList.add('text-white/90'); }
            if (viewId === 'historico') document.getElementById('btn-voltar-historico').onclick = () => navigateTo(menuId);
            document.querySelectorAll('[id^="view-"]').forEach(el => el.classList.add('hidden'));
            const target = document.getElementById('view-' + viewId);
            if (target) target.classList.remove('hidden'); else document.getElementById('view-rebalanceamento').classList.remove('hidden');

            const titles = { 'dashboard': 'Visão Geral', 'reserva': 'Reserva de Emergência', 'renda-fixa': 'Renda Fixa', 'renda-variavel': 'Renda Variável', 'tesouro': 'Tesouro Direto', 'historico': 'Histórico de Liquidações', 'rebalanceamento': 'Rebalanceamento', 'proventos': 'Proventos' };

            // Subtítulos criativos para cada contexto
            const subtitles = {
                'dashboard': 'Bem-vindo de volta. O dinheiro nunca dorme.',
                'rebalanceamento': 'Equilíbrio é a chave para o sucesso no longo prazo.',
                'reserva': 'Segurança e liquidez para os momentos inesperados.',
                'renda-fixa': 'Construindo patrimônio com previsibilidade e solidez.',
                'renda-variavel': 'Onde a volatilidade encontra as maiores oportunidades.',
                'tesouro': 'A garantia soberana para seus objetivos futuros.',
                'historico': 'O registro detalhado de suas vitórias passadas.',
                'proventos': 'Colhendo os frutos da sua disciplina.'
            };

            document.getElementById('page-title').textContent = titles[viewId] || 'Meus Investimentos';
            document.getElementById('page-subtitle').textContent = subtitles[viewId] || 'Gerenciando seu futuro.';

            if (viewId === 'reserva') renderReserva();
            if (viewId === 'renda-fixa') renderRendaFixa();
            if (viewId === 'renda-variavel') renderRendaVariavel();
            if (viewId === 'tesouro') renderTesouro();
            if (viewId === 'historico') renderHistorico();
            if (viewId === 'dashboard') renderDashboard();
            if (viewId === 'rebalanceamento') renderRebalanceamento();
            if (viewId === 'proventos') renderProventos();
        }

        const modal = document.getElementById('transaction-modal');
        const modalFields = document.getElementById('modal-fields-container');
        window.calculateTesouroTotal = () => { const qty = parseFloat(document.getElementById('input-qty')?.value) || 0; const price = parseFloat(document.getElementById('input-unit-price')?.value) || 0; document.getElementById('input-total-calc').value = (qty * price).toFixed(2); };
        window.calculateTesouroTotal = () => {
            const qty = parseFloat(document.getElementById('input-qty')?.value) || 0;
            const price = parseFloat(document.getElementById('input-unit-price')?.value) || 0;
            const total = qty * price;
            const totalEl = document.getElementById('input-total-calc');
            if (totalEl) totalEl.value = total.toFixed(2);
        };

        window.calculateRVTotal = () => { const qty = parseFloat(document.getElementById('input-qty')?.value) || 0; const price = parseFloat(document.getElementById('input-buy-price')?.value) || 0; const costs = parseFloat(document.getElementById('input-other-costs')?.value) || 0; document.getElementById('input-total-calc').value = ((qty * price) + costs).toFixed(2); };
        window.openModal = () => {
            const modal = document.getElementById('transaction-modal');
            const selector = document.getElementById('category-selector');
            const fields = document.getElementById('modal-fields-container');
            const actions = document.getElementById('modal-actions');

            // Resetar para modo "Novo"
            document.getElementById('edit-asset-id').value = '';
            document.getElementById('modal-save-btn-text').textContent = 'Salvar';

            modal.classList.remove('hidden');

            // Fix: Proventos context should open Renda Variável input
            if (currentContext === 'proventos') {
                selectCategory('renda-variavel');
            } else if (currentContext === 'dashboard' || currentContext === 'rebalanceamento') {
                document.getElementById('modal-title').textContent = "Novo Aporte";
                selector.classList.remove('hidden'); selector.classList.add('grid');
                fields.classList.add('hidden'); fields.classList.remove('grid');
                actions.classList.add('hidden'); actions.classList.remove('flex');
            } else {
                selectCategory(currentContext);
            }
            setTimeout(() => { modal.classList.remove('opacity-0'); document.getElementById('modal-content').classList.remove('opacity-0', 'scale-95'); document.getElementById('modal-content').classList.add('scale-100'); }, 10);
        };

        window.closeModal = () => { document.getElementById('transaction-modal').classList.add('opacity-0'); document.getElementById('modal-content').classList.remove('scale-100'); document.getElementById('modal-content').classList.add('opacity-0', 'scale-95'); setTimeout(() => document.getElementById('transaction-modal').classList.add('hidden'), 300); };

        // --- FUNÇÃO PARA ABRIR O MODAL DE EDIÇÃO ---
        window.openEditModal = (id) => {
            let asset;
            if (currentContext === 'renda-variavel') asset = window.mockRendaVariavelAssets.find(a => a.id == id);
            else if (currentContext === 'tesouro') asset = window.mockTesouroAssets.find(a => a.id == id);
            else if (currentContext === 'renda-fixa') asset = window.mockRendaFixaAssets.find(a => a.id == id);
            else {
                asset = window.mockReservaAssets.find(a => a.id == id);
                if (!asset) asset = window.mockTesouroAssets.find(a => a.id == id);
            }

            if (!asset) return;

            // Define o contexto se estiver no dashboard ou outro lugar
            let editContext = currentContext;
            if (currentContext === 'dashboard' || currentContext === 'rebalanceamento') {
                if (asset.category) editContext = asset.category;
                else {
                    // Tenta adivinhar pelo tipo
                    if (asset.ticker) editContext = 'renda-variavel';
                    else if (asset.type && asset.type.includes('Tesouro')) editContext = 'tesouro';
                    else editContext = 'reserva'; // Default
                }
            }

            // Seleciona a categoria e renderiza os campos
            selectCategory(editContext);
            document.getElementById('modal-title').textContent = "Editar Ativo";
            document.getElementById('edit-asset-id').value = id;
            document.getElementById('modal-save-btn-text').textContent = 'Atualizar';

            // Preenche os campos com atraso para garantir que o HTML foi renderizado
            setTimeout(() => {
                if (document.getElementById('application-date')) document.getElementById('application-date').value = asset.dateInv || '';
                if (document.getElementById('input-broker')) document.getElementById('input-broker').value = asset.broker || ''; // Preencher corretora

                if (editContext === 'renda-variavel') {
                    if (document.getElementById('input-type')) document.getElementById('input-type').value = asset.type || 'Ação';
                    if (document.getElementById('input-ticker')) document.getElementById('input-ticker').value = asset.ticker || '';
                    if (document.getElementById('input-qty')) document.getElementById('input-qty').value = asset.quantity || 0;
                    if (document.getElementById('input-buy-price')) document.getElementById('input-buy-price').value = (asset.currentPrice || 0).toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
                    if (document.getElementById('input-other-costs')) document.getElementById('input-other-costs').value = (asset.costs || 0).toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
                    if (document.getElementById('input-currency')) {
                        document.getElementById('input-currency').value = asset.currency || 'BRL';
                        // Garante que o símbolo (R$/US$) esteja correto ao abrir a edição
                        updateCurrencySymbol();
                    }
                    calculateRVTotal();
                } else if (editContext === 'tesouro') {
                    if (document.getElementById('input-type')) document.getElementById('input-type').value = asset.type || '';
                    if (document.getElementById('input-issuer')) document.getElementById('input-issuer').value = asset.issuer || '';
                    if (document.getElementById('input-qty')) document.getElementById('input-qty').value = asset.quantity || 1;
                    if (document.getElementById('input-unit-price')) document.getElementById('input-unit-price').value = (asset.unitPrice || asset.invested || 0).toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
                    if (document.getElementById('input-maturity')) document.getElementById('input-maturity').value = asset.maturity || '';

                    if (asset.rate) {
                        let type = 'PRE'; let val = 0;
                        if (asset.rate.includes('Selic')) { type = 'Selic'; val = asset.rate.replace('Selic + ', '').replace('%', ''); }
                        else if (asset.rate.includes('IPCA')) { type = 'IPCA'; val = asset.rate.replace('IPCA + ', '').replace('%', ''); }
                        else if (asset.rate.includes('CDI')) { type = 'CDI'; val = asset.rate.replace('% CDI', ''); }
                        else { val = asset.rate.replace('%', ''); }

                        if (document.getElementById('input-rate-type')) document.getElementById('input-rate-type').value = type;
                        if (document.getElementById('input-rate-val')) document.getElementById('input-rate-val').value = parseFloat(val);
                    }
                    document.getElementById('input-total-calc').value = asset.invested || 0;
                } else {
                    if (document.getElementById('input-type')) document.getElementById('input-type').value = asset.type || 'CDB';
                    if (document.getElementById('input-issuer')) document.getElementById('input-issuer').value = asset.issuer || '';
                    if (document.getElementById('input-invested')) document.getElementById('input-invested').value = (asset.invested || 0).toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
                    if (document.getElementById('input-maturity')) document.getElementById('input-maturity').value = asset.maturity || '';

                    if (asset.rate) {
                        let type = 'PRE'; let val = 0;
                        if (asset.rate.includes('Selic')) { type = 'Selic'; val = asset.rate.replace('Selic + ', '').replace('%', ''); }
                        else if (asset.rate.includes('IPCA')) { type = 'IPCA'; val = asset.rate.replace('IPCA + ', '').replace('%', ''); }
                        else if (asset.rate.includes('CDI')) { type = 'CDI'; val = asset.rate.replace('% CDI', ''); }
                        else { val = asset.rate.replace('%', ''); }

                        if (document.getElementById('input-rate-type')) document.getElementById('input-rate-type').value = type;
                        if (document.getElementById('input-rate-val')) document.getElementById('input-rate-val').value = parseFloat(val);
                    }
                }
            }, 50);

            // Mostra o modal (já feito pelo selectCategory, mas garantindo)
            const modal = document.getElementById('transaction-modal');
            modal.classList.remove('hidden');
            setTimeout(() => {
                modal.classList.remove('opacity-0');
                document.getElementById('modal-content').classList.remove('opacity-0', 'scale-95');
                document.getElementById('modal-content').classList.add('scale-100');
            }, 10);
        };

        // --- FUNÇÃO PARA NOVO APORTE PRÉ-PREENCHIDO ---
        window.openInvestModal = (data) => {
            selectCategory(data.category);
            window.openModal(); // Abre como "Novo Aporte"

            // Preenche os campos fixos
            setTimeout(() => {
                if (data.category === 'tesouro') {
                    if (document.getElementById('input-issuer')) {
                        document.getElementById('input-issuer').value = data.issuer;
                    }
                    if (document.getElementById('input-maturity')) document.getElementById('input-maturity').value = data.maturity;

                    if (document.getElementById('input-type')) {
                        let typeVal = data.type || '';
                        if (typeVal.includes('Selic')) typeVal = 'Tesouro Selic';
                        else if (typeVal.includes('IPCA')) typeVal = 'Tesouro IPCA+';
                        else if (typeVal.includes('Renda+')) typeVal = 'Tesouro Renda+';
                        else if (typeVal.includes('Prefixado') || typeVal.includes('Pré')) typeVal = 'Tesouro Prefixado';

                        document.getElementById('input-type').value = typeVal;
                        if (window.autoSelectRateType) window.autoSelectRateType();
                    }
                } else if (data.category === 'renda-variavel') {
                    if (document.getElementById('input-type')) document.getElementById('input-type').value = data.type;
                    if (document.getElementById('input-ticker')) document.getElementById('input-ticker').value = data.ticker;
                    if (document.getElementById('input-currency')) {
                        document.getElementById('input-currency').value = data.currency;
                        if (window.updateCurrencySymbol) window.updateCurrencySymbol();
                    }
                }
            }, 50);
        };

        // --- VALIDAÇÃO E CONFIGURAÇÕES ---
        window.enableInputValidation = localStorage.getItem('enableInputValidation') === 'true'; // Load from storage

        window.openSettingsModal = () => {
            const m = document.getElementById('settings-modal');
            const chk = document.getElementById('setting-validation-check');
            if (chk) chk.checked = window.enableInputValidation;

            const darkChk = document.getElementById('setting-dark-mode-check');
            if (darkChk) darkChk.checked = document.documentElement.classList.contains('dark');

            m.classList.remove('hidden');
            setTimeout(() => {
                m.classList.remove('opacity-0');
                document.getElementById('settings-modal-content').classList.remove('opacity-0', 'scale-95');
                document.getElementById('settings-modal-content').classList.add('scale-100');
            }, 10);
        };

        window.closeSettingsModal = () => {
            const m = document.getElementById('settings-modal');
            m.classList.add('opacity-0');
            document.getElementById('settings-modal-content').classList.remove('scale-100');
            document.getElementById('settings-modal-content').classList.add('opacity-0', 'scale-95');
            setTimeout(() => m.classList.add('hidden'), 300);
        };

        window.toggleValidationSetting = (val) => {
            window.enableInputValidation = val;
            localStorage.setItem('enableInputValidation', val);
        };

        window.validateInputs = (containerId) => {
            if (!window.enableInputValidation) return true;


            const container = document.getElementById(containerId);
            if (!container) return true;

            const inputs = container.querySelectorAll('input:not([type="hidden"]), select');
            let isValid = true;
            let firstInvalid = null;

            inputs.forEach(input => {
                // Reset styling
                input.classList.remove('border-red-500', 'bg-red-50');

                // Simple validation: required if it's visible
                if (input.offsetParent !== null && !input.value) {
                    // Ignore specific optional fields usually? For now, assume all visible inputs in these modals are required except maybe "Costs"
                    // Let's make "costs" optional
                    if (input.id === 'input-other-costs' || input.id === 'liq-costs') return;

                    input.classList.add('border-red-500', 'bg-red-50');
                    isValid = false;
                    if (!firstInvalid) firstInvalid = input;
                }
            });

            if (!isValid) {
                if (firstInvalid) firstInvalid.focus();
                window.showValidationWarningModal();
            }
            return isValid;
        };

        window.showValidationWarningModal = () => {
            const m = document.getElementById('validation-warning-modal');
            if (m) {
                m.classList.remove('hidden');
                setTimeout(() => {
                    m.classList.remove('opacity-0');
                    m.querySelector('div').classList.remove('opacity-0', 'scale-95');
                    m.querySelector('div').classList.add('scale-100');
                }, 10);
            } else {
                alert("Atenção: Preencha todos os campos obrigatórios.");
            }
        };

        window.closeValidationModal = () => {
            const m = document.getElementById('validation-warning-modal');
            if (m) {
                m.classList.add('opacity-0');
                m.querySelector('div').classList.remove('scale-100');
                m.querySelector('div').classList.add('opacity-0', 'scale-95');
                setTimeout(() => m.classList.add('hidden'), 300);
            }
        };

        // --- SAVE ON ENTER UTILITY ---
        window.setupSaveOnEnter = (containerId, saveAction) => {
            const container = document.getElementById(containerId);
            if (!container) return;
            const inputs = container.querySelectorAll('input, select');
            inputs.forEach(inp => {
                // avoid duplicate listeners
                if (inp.dataset.hasEnterListener) return;
                inp.dataset.hasEnterListener = 'true';

                inp.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        saveAction();
                    }
                });
            });
        };

        window.saveNewAsset = () => {
            if (!validateInputs('modal-fields-container')) return;

            const context = document.getElementById('modal-context').value;
            const editId = document.getElementById('edit-asset-id').value;
            const dateInv = document.getElementById('application-date').value;
            // Pegar corretora de forma dinâmica (agora existe em todos os forms)
            const broker = document.getElementById('input-broker')?.value || 'Manual';

            let newItem = {};

            // Helper para formatar a taxa
            const getFormattedRate = () => {
                const rType = document.getElementById('input-rate-type')?.value;
                const rVal = document.getElementById('input-rate-val')?.value;
                if (!rType || !rVal) return 'Indexado';
                if (rType === 'CDI') return `${rVal}% CDI`;
                if (rType === 'IPCA') return `IPCA + ${rVal}%`;
                if (rType === 'Selic') return `Selic + ${rVal}%`;
                if (rType === 'PRE') return `${rVal}%`;
                return `${rType} ${rVal}%`;
            };

            if (context === 'renda-variavel') {
                const type = document.getElementById('input-type').value; const ticker = document.getElementById('input-ticker').value.toUpperCase(); const qty = parseFloat(document.getElementById('input-qty').value);
                const price = window.parseCurrencyValue(document.getElementById('input-buy-price').value);
                const costs = window.parseCurrencyValue(document.getElementById('input-other-costs')?.value);
                const currency = document.getElementById('input-currency')?.value || 'BRL';
                if (!ticker || qty <= 0 || price <= 0) return alert("Preencha todos os campos corretamente.");
                const totalSpent = (qty * price) + costs; const avgPriceWithCosts = totalSpent / qty;
                newItem = { dateInv, type, ticker, quantity: qty, avgPrice: avgPriceWithCosts, currentPrice: price, broker: broker, currency, category: 'renda-variavel' };
            } else {
                if (context === 'tesouro') {
                    const type = document.getElementById('input-type').value;
                    const maturity = document.getElementById('input-maturity').value;
                    const year = maturity ? maturity.split('-')[0] : '';

                    let displayYear = year;
                    if (type && type.includes('Renda+') && year) {
                        const y = parseInt(year);
                        if (!isNaN(y)) displayYear = y - 19;
                    }

                    // Força a padronização do nome (Tipo + Ano)
                    const issuer = `${type} ${displayYear}`;

                    const qty = parseFloat(document.getElementById('input-qty').value) || 0;
                    const unitPrice = window.parseCurrencyValue(document.getElementById('input-unit-price').value);
                    const invested = window.parseCurrencyValue(document.getElementById('input-total-calc').value); // Total Calculated is also masked if user types? Actually calculateTesouroTotal sets it. 
                    // Wait, calculateTesouroTotal sets .value = (qty * price).toFixed(2). So it is standard number format "1234.56".
                    // However, if the user edits it? The field is readonly usually? No, "input-total-calc" is disabled or readonly? 
                    // Checking HTML... <input id="input-total-calc" disabled ...> 
                    // So it will have dot format. `parseCurrencyValue` handles dots as thousands separators if likely. 
                    // But if it comes from .toFixed(2), it is "1234.56". `parseCurrencyValue("1234.56")` -> clean "123456" -> 123456? WRONG.
                    // If the field is calculated programmatically safely as "1234.56", we should use parseFloat.
                    // BUT: user might be able to edit it? If it is disabled, we rely on calculation.
                    // Let's check `calculateTesouroTotal`. I didn't change it to output formatted string.
                    // In previous step: `total = qty * price;`... `totalEl.value = total.toFixed(2);`
                    // So it remains valid float string.
                    // RE-READ: I need to be careful. If `input-total-calc` is used as source of truth.
                    // Actually, let's look at `input-invested` for Fixed Income. That one IS user editable and masked.
                    // For Tesouro: `input-unit-price` is masked. `input-total-calc` is result.
                    // `const invested = parseFloat(...)` is currently used.
                    // If `input-total-calc` is purely output of `qty * price`, it uses dot decimal.
                    // `parseCurrencyValue` expects comma decimal for BRL.
                    // Exception: `input-total-calc` is NOT masked in my plan (it is disabled).
                    // So for Tesouro: `invested` comes from `input-total-calc`.

                    // ISSUE: `parseCurrencyValue` logic: `val.replace(/\./g, '').replace(',', '.')`
                    // If val is "1234.56" (from toFixed), it becomes "123456" -> huge number.
                    // FIX: `parseCurrencyValue` should detect if it's already a valid float-like string?
                    // Or I should just use `parseFloat` for `input-total-calc` if it is not masked.

                    // Let's use `parseFloat` for `input-total-calc` as it is not masked.
                    // But `input-unit-price` IS masked.

                    // Code below shows `input-invested` used for "Outros" (Fixed Income mock).
                    // That one IS masked.

                    // Decisions:
                    // Tesouro `invested`: use parseFloat from `input-total-calc`.
                    // Tesouro `unitPrice`: use parseCurrencyValue from `input-unit-price`.

                    // Renda Fixa `invested`: use parseCurrencyValue from `input-invested`.

                    const rate = getFormattedRate();
                    // invested comes from calc, unmasked
                    const investedCalc = parseFloat(document.getElementById('input-total-calc').value) || (qty * unitPrice);
                    newItem = { dateInv, type, issuer, maturity, invested: investedCalc, quantity: qty, unitPrice: unitPrice, current: investedCalc, rate: rate, broker: broker, currency: 'BRL', category: 'tesouro' };
                } else {
                    const type = document.getElementById('input-type').value; const issuer = document.getElementById('input-issuer').value;
                    const invested = window.parseCurrencyValue(document.getElementById('input-invested').value);
                    const maturity = document.getElementById('input-maturity').value;
                    const rate = getFormattedRate();
                    newItem = { dateInv, type, issuer, maturity, invested, current: invested, rate: rate, broker: broker, currency: 'BRL', category: context };
                }
            }

            if (editId) {
                // Modo Edição
                if (window.firebaseUpdateAsset) {
                    window.firebaseUpdateAsset(editId, newItem);
                    closeModal();
                    showSuccessMessage("Ativo atualizado!");
                }
            } else {
                // Modo Criação
                if (window.firebaseSaveAsset) {
                    window.firebaseSaveAsset(newItem);
                    closeModal();
                    showSuccessMessage("Enviando para o Firebase...");
                } else {
                    alert("Erro: Conexão com Firebase não encontrada.");
                }
            }
        };

        // --- LÓGICA DE FILTRAGEM DO TESOURO ---
        // --- LÓGICA DE FILTRAGEM GENÉRICA (Tesouro e Renda Variável) ---
        window.filterUpdateList = (filterValue, clickedBtn) => {
            // Atualiza estilo dos botões
            const container = document.getElementById('update-balances-filters');
            if (container) {
                const buttons = container.querySelectorAll('button');
                buttons.forEach(btn => {
                    btn.className = "filter-btn bg-slate-100 text-slate-600 px-3 py-1.5 rounded-lg text-xs font-medium whitespace-nowrap hover:bg-slate-200 transition-colors";
                });
                if (clickedBtn) {
                    clickedBtn.className = "filter-btn bg-primary text-white px-3 py-1.5 rounded-lg text-xs font-bold whitespace-nowrap transition-colors";
                }
            }

            // Filtra os itens da lista
            const list = document.getElementById('update-balances-list');
            Array.from(list.children).forEach(div => {
                // Verifica emissor (Tesouro) ou Tipo (RV)
                let match = false;
                if (filterValue === 'all') match = true;
                else if (div.dataset.issuer === filterValue) match = true;
                else if (div.dataset.type === filterValue) match = true;

                // Composite Filters for Renda Fixa
                if (filterValue === 'CDB/LC') {
                    if (div.dataset.type === 'CDB' || div.dataset.type === 'LC') match = true;
                } else if (filterValue === 'LCI/LCA') {
                    if (div.dataset.type === 'LCI' || div.dataset.type === 'LCA') match = true;
                }

                if (match) {
                    div.classList.remove('hidden');
                } else {
                    div.classList.add('hidden');
                }
            });
        };

        const updateModal = document.getElementById('update-balances-modal');
        const updateList = document.getElementById('update-balances-list');

        window.openUpdateBalancesModal = () => {
            updateList.innerHTML = '';
            let assets = [];

            // Cria cópias dos arrays para não bagunçar a ordem original global se ordenarmos aqui
            if (currentContext === 'renda-variavel') assets = [...window.mockRendaVariavelAssets];
            else if (currentContext === 'tesouro') assets = [...window.mockTesouroAssets];
            else assets = currentContext === 'renda-fixa' ? [...window.mockRendaFixaAssets] : [...window.mockReservaAssets];

            if (currentContext === 'renda-variavel') {
                document.getElementById('usd-rate-container').classList.remove('hidden');
                document.getElementById('usd-rate-input').value = currentUsdRate;
            } else {
                document.getElementById('usd-rate-container').classList.add('hidden');
            }

            // --- GERAÇÃO DINÂMICA DE FILTROS ---
            const filtersContainer = document.getElementById('update-balances-filters');
            if (currentContext === 'tesouro' || currentContext === 'renda-variavel' || currentContext === 'renda-fixa') {
                filtersContainer.classList.remove('hidden');
                filtersContainer.innerHTML = ''; // Limpa filtros anteriores

                // Botão "Todos"
                const allBtn = document.createElement('button');
                allBtn.textContent = "Todos";
                allBtn.onclick = () => window.filterUpdateList('all', allBtn);
                allBtn.className = "filter-btn bg-primary text-white px-3 py-1.5 rounded-lg text-xs font-bold whitespace-nowrap transition-colors"; // Ativo por padrão
                filtersContainer.appendChild(allBtn);

                if (currentContext === 'tesouro') {
                    // Botões para cada Título Único
                    const uniqueIssuers = [...new Set(assets.map(a => a.issuer))].sort();
                    uniqueIssuers.forEach(issuer => {
                        const btn = document.createElement('button');
                        btn.textContent = issuer;
                        btn.className = "filter-btn bg-slate-100 text-slate-600 px-3 py-1.5 rounded-lg text-xs font-medium whitespace-nowrap hover:bg-slate-200 transition-colors";
                        btn.onclick = () => window.filterUpdateList(issuer, btn);
                        filtersContainer.appendChild(btn);
                    });
                } else if (currentContext === 'renda-variavel') {
                    // Botões para Tipos de Renda Variável
                    const variableTypes = ['Ação', 'FII', 'Exterior', 'Cripto'];
                    const typeLabels = { 'Ação': 'Ações', 'FII': 'FIIs', 'Exterior': 'Exterior', 'Cripto': 'Cripto' };

                    variableTypes.forEach(type => {
                        const btn = document.createElement('button');
                        btn.textContent = typeLabels[type] || type;
                        btn.className = "filter-btn bg-slate-100 text-slate-600 px-3 py-1.5 rounded-lg text-xs font-medium whitespace-nowrap hover:bg-slate-200 transition-colors";
                        btn.onclick = () => window.filterUpdateList(type, btn);
                        filtersContainer.appendChild(btn);
                    });
                } else if (currentContext === 'renda-fixa') {
                    // Filtros Extras Renda Fixa
                    ['CDB/LC', 'LCI/LCA'].forEach(filter => {
                        const btn = document.createElement('button');
                        btn.textContent = filter;
                        btn.className = "filter-btn bg-slate-100 text-slate-600 px-3 py-1.5 rounded-lg text-xs font-medium whitespace-nowrap hover:bg-slate-200 transition-colors";
                        btn.onclick = () => window.filterUpdateList(filter, btn);
                        filtersContainer.appendChild(btn);
                    });
                }

            } else {
                filtersContainer.classList.add('hidden');
            }

            // ORDENAÇÃO ESPECÍFICA POR CONTEXTO
            if (currentContext === 'tesouro') {
                // Tesouro: Do mais antigo para o mais recente (Cronológico de Aporte)
                assets.sort((a, b) => {
                    const dateA = new Date(a.dateInv || '2099-01-01');
                    const dateB = new Date(b.dateInv || '2099-01-01');
                    return dateA - dateB;
                });
            } else if (currentContext === 'renda-variavel') {
                // Renda Variável: Alfabética por Ticker
                assets.sort((a, b) => a.ticker.localeCompare(b.ticker));
            } else {
                // Renda Fixa e Reserva: Ordenar por Vencimento (Mais próximo primeiro)
                assets.sort((a, b) => {
                    const dateA = new Date(a.maturity || '2099-01-01');
                    const dateB = new Date(b.maturity || '2099-01-01');
                    return dateA - dateB;
                });
            }

            assets.forEach(asset => {
                const label = currentContext === 'renda-variavel' ? asset.ticker : asset.issuer;
                const currentVal = currentContext === 'renda-variavel' ? asset.currentPrice : asset.current;
                const div = document.createElement('div');
                div.className = "flex justify-between p-3 bg-slate-50 border rounded-lg items-center transition-all duration-300";

                // Adiciona identificador para o filtro
                if (currentContext === 'tesouro') {
                    div.dataset.issuer = asset.issuer;
                } else if (currentContext === 'renda-variavel') {
                    div.dataset.type = asset.type;
                } else if (currentContext === 'renda-fixa') {
                    div.dataset.type = asset.type; // Also set type for Renda Fixa filtering
                }

                const currencyLabel = asset.currency === 'USD' ? 'US$' : 'R$';

                // Exibir Data do Aporte ou Vencimento para diferenciar
                let subInfo = '';
                if (currentContext === 'tesouro' && asset.dateInv) {
                    const parts = asset.dateInv.split('-');
                    const dateFmt = `${parts[2]}/${parts[1]}/${parts[0]}`;
                    subInfo = `<span class="text-[10px] text-slate-400 block font-normal mt-0.5">Aporte: ${dateFmt}</span>`;
                } else if ((currentContext === 'renda-fixa' || currentContext === 'reserva') && asset.maturity) {
                    const parts = asset.maturity.split('-');
                    const dateFmt = `${parts[2]}/${parts[1]}/${parts[0]}`;
                    subInfo = `<span class="text-[10px] text-slate-400 block font-normal mt-0.5">Vencimento: ${dateFmt}</span>`;
                }

                // INFORMAÇÃO DE ÚLTIMA ATUALIZAÇÃO
                let updateInfo = '';
                if (asset.lastUpdated) {
                    const d = new Date(asset.lastUpdated);
                    const fmt = d.toLocaleDateString('pt-BR', { day: '2-digit', month: '2-digit', year: '2-digit', hour: '2-digit', minute: '2-digit' });
                    updateInfo = `<span class="text-[10px] text-emerald-600 block font-medium mt-0.5"><i class="fa-regular fa-clock mr-1"></i>Atualizado: ${fmt}</span>`;
                } else {
                    updateInfo = `<span class="text-[10px] text-slate-300 block font-normal mt-0.5">Sem registro de atualização</span>`;
                }



                div.innerHTML = `<div><p class="font-bold text-sm text-slate-800">${label}</p>${subInfo}${updateInfo}</div><div class="flex items-center gap-2"><span class="text-xs font-bold text-slate-400">${currencyLabel}</span><input type="text" inputmode="numeric" oninput="formatCurrencyInput(this)" value="${currentVal.toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}" data-id="${asset.id}" class="w-36 p-2 border rounded text-right font-bold text-slate-700 focus:ring-2 focus:ring-primary/20 outline-none transition-all"></div>`;
                updateList.appendChild(div);
            });
            // Re-bind Save on Enter for these new inputs
            setupSaveOnEnter('update-balances-content', window.saveUpdatedBalances);
            updateModal.classList.remove('hidden'); setTimeout(() => { updateModal.classList.remove('opacity-0'); document.getElementById('update-balances-content').classList.remove('opacity-0', 'scale-95'); document.getElementById('update-balances-content').classList.add('scale-100'); }, 10);
        };

        window.saveUpdatedBalances = () => {
            if (!validateInputs('update-balances-content')) return;

            const inputs = updateList.querySelectorAll('input:not([type="hidden"])'); // Select all inputs (text/number)
            let assets = [];
            if (currentContext === 'renda-variavel') {
                assets = window.mockRendaVariavelAssets;
                const newUsd = parseFloat(document.getElementById('usd-rate-input').value);
                if (newUsd > 0) currentUsdRate = newUsd;
            } else if (currentContext === 'tesouro') assets = window.mockTesouroAssets; else assets = currentContext === 'renda-fixa' ? window.mockRendaFixaAssets : window.mockReservaAssets;

            const now = new Date().toISOString(); // Timestamp atual

            inputs.forEach(inp => {
                if (inp.id === 'usd-rate-input') return;

                const id = inp.dataset.id; // IDs do Firebase são strings
                const asset = assets.find(a => a.id == id);
                if (asset) {
                    const newVal = window.parseCurrencyValue(inp.value);
                    if (isNaN(newVal)) return;

                    // Atualiza o valor E a data de atualização
                    if (currentContext === 'renda-variavel') {
                        if (window.firebaseUpdateAsset) window.firebaseUpdateAsset(id, { currentPrice: newVal, lastUpdated: now });
                    } else {
                        if (window.firebaseUpdateAsset) window.firebaseUpdateAsset(id, { current: newVal, lastUpdated: now });
                    }
                }
            });
            closeUpdateBalancesModal(); showSuccessMessage("Valores atualizados!");
            if (currentContext === 'renda-variavel') renderRendaVariavel(); else if (currentContext === 'tesouro') renderTesouro(); else if (currentContext === 'renda-fixa') renderRendaFixa(); else renderReserva();
        };
        window.closeUpdateBalancesModal = () => { updateModal.classList.add('opacity-0'); document.getElementById('update-balances-content').classList.remove('scale-100'); document.getElementById('update-balances-content').classList.add('opacity-0', 'scale-95'); setTimeout(() => updateModal.classList.add('hidden'), 300); };

        let liquidationType = 'total';

        window.toggleLiquidationType = (type) => {
            liquidationType = type;
            const btnTotal = document.getElementById('btn-liq-total');
            const btnPartial = document.getElementById('btn-liq-partial');
            const partialContainer = document.getElementById('liq-partial-container');
            const finalInput = document.getElementById('liq-final-value');

            if (type === 'total') {
                btnTotal.className = "flex-1 py-2 rounded-lg text-sm font-bold shadow-sm bg-white text-slate-800 transition-all shadow-md";
                btnPartial.className = "flex-1 py-2 rounded-lg text-sm font-medium text-slate-500 hover:text-slate-700 transition-all hover:bg-slate-200";
                partialContainer.classList.add('hidden');
                updateLiquidationValues();
                finalInput.setAttribute('readonly', true);
                finalInput.classList.add('bg-yellow-50', 'text-yellow-700');
                finalInput.classList.remove('bg-white', 'text-slate-700');
            } else {
                btnPartial.className = "flex-1 py-2 rounded-lg text-sm font-bold shadow-sm bg-white text-slate-800 transition-all shadow-md";
                btnTotal.className = "flex-1 py-2 rounded-lg text-sm font-medium text-slate-500 hover:text-slate-700 transition-all hover:bg-slate-200";
                partialContainer.classList.remove('hidden');
                updateLiquidationValues();
            }
        };

        window.updateLiquidationValues = () => {
            const context = document.getElementById('liq-context').value;
            const finalInput = document.getElementById('liq-final-value');

            if (context === 'renda-variavel') {
                const qty = parseFloat(document.getElementById('liq-qty').value) || 0;
                const price = window.parseCurrencyValue(document.getElementById('liq-price').value);
                const costs = window.parseCurrencyValue(document.getElementById('liq-costs').value);
                const total = (qty * price) - costs;
                finalInput.value = total.toFixed(2);
            } else {
                if (liquidationType === 'total') {
                    const maxVal = parseFloat(document.getElementById('liquidation-modal').dataset.maxValue) || 0;
                    finalInput.value = maxVal.toFixed(2);
                } else {
                    const val = window.parseCurrencyValue(document.getElementById('liq-withdraw-value').value);
                    finalInput.value = val.toFixed(2);
                }
            }
        };

        const liqModal = document.getElementById('liquidation-modal');
        window.openLiquidationModal = (id) => {
            let asset;
            if (currentContext === 'renda-variavel') asset = window.mockRendaVariavelAssets.find(a => a.id == id);
            else if (currentContext === 'tesouro') asset = window.mockTesouroAssets.find(a => a.id == id);
            else if (currentContext === 'renda-fixa') asset = window.mockRendaFixaAssets.find(a => a.id == id);
            else {
                asset = window.mockReservaAssets.find(a => a.id == id);
                if (!asset) asset = window.mockTesouroAssets.find(a => a.id == id);
            }

            if (!asset) return;

            document.getElementById('liq-asset-id').value = id;
            document.getElementById('liq-context').value = currentContext;
            document.getElementById('liq-date').value = new Date().toISOString().split('T')[0];

            const name = currentContext === 'renda-variavel' ? asset.ticker : asset.issuer;
            document.getElementById('liq-asset-name').textContent = name;

            const rvFields = document.getElementById('liq-rv-fields');
            const otherFields = document.getElementById('liq-other-fields');

            // Currency
            const currency = asset.currency || 'BRL';
            const symbol = currency === 'USD' ? 'US$' : 'R$';
            document.querySelectorAll('.liq-currency-symbol').forEach(el => el.textContent = symbol);

            if (currentContext === 'renda-variavel') {
                rvFields.classList.remove('hidden');
                otherFields.classList.add('hidden');

                document.getElementById('liq-max-qty').textContent = asset.quantity;
                document.getElementById('liq-qty').value = asset.quantity;
                // Preencher com valor formatado na abertura do modal
                document.getElementById('liq-price').value = asset.currentPrice.toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
                document.getElementById('liq-costs').value = '';

                liqModal.dataset.assetCurrency = currency;
            } else {
                rvFields.classList.add('hidden');
                otherFields.classList.remove('hidden');

                const currentVal = asset.current;
                liqModal.dataset.maxValue = currentVal;
                document.getElementById('liq-current-balance').textContent = formatCurrency(currentVal, 'BRL'); // Reserva is always BRL
                document.getElementById('liq-withdraw-value').value = '';

                toggleLiquidationType('total');
            }

            updateLiquidationValues();
            liqModal.classList.remove('hidden');
            setTimeout(() => { liqModal.classList.remove('opacity-0'); document.getElementById('liquidation-modal-content').classList.remove('opacity-0', 'scale-95'); document.getElementById('liquidation-modal-content').classList.add('scale-100'); }, 10);
        };

        window.confirmLiquidation = () => {
            const id = document.getElementById('liq-asset-id').value;
            const date = document.getElementById('liq-date').value;
            const context = document.getElementById('liq-context').value;
            let asset;

            if (context === 'renda-variavel') asset = window.mockRendaVariavelAssets.find(a => a.id == id);
            else if (context === 'tesouro') asset = window.mockTesouroAssets.find(a => a.id == id);
            else if (context === 'renda-fixa') asset = window.mockRendaFixaAssets.find(a => a.id == id);
            else {
                asset = window.mockReservaAssets.find(a => a.id == id);
                if (!asset) asset = window.mockTesouroAssets.find(a => a.id == id);
            }

            if (!asset) return;

            if (!validateInputs('liquidation-modal-content')) return;

            let finalValue = parseFloat(document.getElementById('liq-final-value').value) || 0;
            let historyType = 'Total';
            let investedPortion = 0;

            if (context === 'renda-variavel') {
                const qty = parseFloat(document.getElementById('liq-qty').value);
                const price = parseFloat(document.getElementById('liq-price').value);
                const costs = parseFloat(document.getElementById('liq-costs').value) || 0;

                if (qty > asset.quantity) return alert("Quantidade excede o disponível!");
                if (qty <= 0) return alert("Quantidade inválida.");

                if (qty < asset.quantity) historyType = 'Parcial';

                // Calculate Invested Portion (Quantity * Average Price)
                investedPortion = qty * asset.avgPrice;
                let finalValueNative = (qty * price) - costs;

                // Convert for History (normalized to BRL)
                if (asset.currency === 'USD') {
                    investedPortion *= currentUsdRate;
                    finalValue = finalValueNative * currentUsdRate;
                } else {
                    finalValue = finalValueNative;
                }

                if (window.firebaseSaveHistory) {
                    window.firebaseSaveHistory({
                        ...asset,
                        type: asset.type,
                        ticker: asset.ticker,
                        issuer: asset.type,
                        invested: investedPortion,
                        finalValue: finalValue,
                        liquidationDate: date,
                        origin: context,
                        liquidationType: historyType,
                        quantity: qty,
                        unitPrice: price,
                        costs: costs,
                        currency: asset.currency || 'BRL'
                    });
                }

                if (historyType === 'Total' || Math.abs(qty - asset.quantity) < 0.0001) {
                    window.firebaseDeleteAsset(id);
                } else {
                    window.firebaseUpdateAsset(id, { quantity: asset.quantity - qty });
                }

            } else {
                if (liquidationType === 'partial') {
                    historyType = 'Parcial';
                    if (finalValue >= asset.current) return alert("Valor parcial deve ser menor que o total. Use a opção Total.");
                    if (finalValue <= 0) return alert("Valor inválido.");

                    const ratio = finalValue / asset.current;
                    investedPortion = asset.invested * ratio;

                    if (window.firebaseSaveHistory) {
                        window.firebaseSaveHistory({
                            ...asset,
                            invested: investedPortion,
                            finalValue: finalValue,
                            liquidationDate: date,
                            origin: context,
                            liquidationType: historyType
                        });
                    }

                    window.firebaseUpdateAsset(id, { current: asset.current - finalValue, invested: asset.invested - investedPortion });

                } else {
                    investedPortion = asset.invested;
                    if (window.firebaseSaveHistory) {
                        window.firebaseSaveHistory({
                            ...asset,
                            invested: investedPortion,
                            finalValue: finalValue,
                            liquidationDate: date,
                            origin: context,
                            liquidationType: historyType
                        });
                    }
                    window.firebaseDeleteAsset(id);
                }
            }

            window.closeLiquidationModal();
            showSuccessMessage("Liquidado com sucesso!");
            if (context === 'renda-variavel') renderRendaVariavel();
            else if (context === 'tesouro') renderTesouro();
            else if (context === 'renda-fixa') renderRendaFixa();
            else renderReserva();
        };
        window.closeLiquidationModal = () => { liqModal.classList.add('opacity-0'); document.getElementById('liquidation-modal-content').classList.remove('scale-100'); document.getElementById('liquidation-modal-content').classList.add('opacity-0', 'scale-95'); setTimeout(() => liqModal.classList.add('hidden'), 300); };
        function showSuccessMessage(msg) { const m = document.getElementById('success-modal'); const c = document.getElementById('success-modal-content'); document.getElementById('success-message').textContent = msg; m.classList.remove('hidden'); setTimeout(() => { m.classList.remove('opacity-0'); c.classList.remove('opacity-0', 'scale-95'); c.classList.add('scale-100'); }, 10); setTimeout(() => { m.classList.add('opacity-0'); c.classList.remove('scale-100'); c.classList.add('opacity-0', 'scale-95'); setTimeout(() => m.classList.add('hidden'), 300); }, 1500); }

        function selectCategory(category) {
            document.getElementById('modal-context').value = category;
            renderModalFields(category);
            document.getElementById('category-selector').classList.remove('grid');
            document.getElementById('category-selector').classList.add('hidden');
            document.getElementById('modal-fields-container').classList.remove('hidden');
            document.getElementById('modal-fields-container').classList.add('grid');
            document.getElementById('modal-actions').classList.remove('hidden');
            document.getElementById('modal-actions').classList.add('flex');
            const titles = { 'reserva': 'Novo Aporte Reserva', 'renda-fixa': 'Novo Aporte Renda Fixa', 'tesouro': 'Novo Aporte Tesouro', 'renda-variavel': 'Novo Aporte RV' };
            document.getElementById('modal-title').textContent = titles[category];
        }

        function renderModalFields(context) {
            const modalFields = document.getElementById('modal-fields-container');
            if (context === 'renda-variavel') {
                // Adicionado campo Corretora, input wrappers com moeda dinâmica e placeholder
                // E o evento onchange="autoSelectCurrency()" no select de Categoria
                modalFields.innerHTML = `
                    <div>
                        <label class="block text-xs font-bold text-slate-500 uppercase tracking-wider mb-2">Categoria</label>
                        <select id="input-type" onchange="autoSelectCurrency()" class="w-full px-4 py-3 rounded-xl border border-slate-200 dark:border-slate-600 dark:bg-slate-700 dark:text-slate-100 outline-none focus:border-primary transition-colors">
                            <option value="Ação">Ação</option>
                            <option value="FII">FII</option>
                            <option value="Exterior">Exterior</option>
                            <option value="Cripto">Cripto</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-slate-500 uppercase tracking-wider mb-2">Ticker</label>
                        <input type="text" id="input-ticker" list="invest-tickers-list" placeholder="Ex: PETR4" oninput="window.autoSelectRVCategory(this.value)" class="w-full px-4 py-3 rounded-xl border border-slate-200 uppercase outline-none focus:border-primary transition-colors">
                        <datalist id="invest-tickers-list"></datalist>
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-slate-500 uppercase tracking-wider mb-2">Quantidade</label>
                        <input type="number" id="input-qty" step="any" placeholder="0" oninput="calculateRVTotal()" class="w-full px-4 py-3 rounded-xl border border-slate-200 outline-none focus:border-primary transition-colors">
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-slate-500 uppercase tracking-wider mb-2">Preço de Compra</label>
                        <div class="relative">
                            <span class="dynamic-currency-symbol absolute left-4 top-3.5 text-slate-400 font-bold">R$</span>
                            <input type="number" id="input-buy-price" step="0.01" placeholder="0,00" oninput="calculateRVTotal()" class="w-full pl-12 pr-4 py-3 rounded-xl border border-slate-200 outline-none focus:border-primary transition-colors">
                        </div>
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-slate-500 uppercase tracking-wider mb-2">Corretora</label>
                        <input type="text" id="input-broker" placeholder="Ex: XP, Binance" class="w-full px-4 py-3 rounded-xl border border-slate-200 outline-none focus:border-primary transition-colors">
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-slate-500 uppercase tracking-wider mb-2">Outros Custos</label>
                        <div class="relative">
                            <span class="dynamic-currency-symbol absolute left-4 top-3.5 text-slate-400 font-bold">R$</span>
                            <input type="number" id="input-other-costs" step="0.01" placeholder="0,00" oninput="calculateRVTotal()" class="w-full pl-12 pr-4 py-3 rounded-xl border border-slate-200 text-slate-600 outline-none focus:border-primary transition-colors">
                        </div>
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-slate-500 uppercase tracking-wider mb-2">Moeda</label>
                        <select id="input-currency" onchange="updateCurrencySymbol()" class="w-full px-4 py-3 rounded-xl border border-slate-200 outline-none focus:border-primary transition-colors">
                            <option value="BRL">Real (BRL)</option>
                            <option value="USD">Dólar (USD)</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-slate-500 uppercase tracking-wider mb-2">Data</label>
                        <input type="date" id="application-date" class="w-full px-4 py-3 rounded-xl border border-slate-200 outline-none focus:border-primary transition-colors">
                    </div>
                    <div class="md:col-span-2">
                        <label class="block text-xs font-bold text-slate-400 uppercase tracking-wider mb-2">Total Investido (Final)</label>
                        <div class="relative">
                            <span class="dynamic-currency-symbol absolute left-4 top-3.5 text-slate-400 font-bold">R$</span>
                            <input type="number" id="input-total-calc" readonly class="w-full pl-12 pr-4 py-3 rounded-xl border border-slate-100 bg-slate-50 font-bold text-lg text-slate-500 outline-none">
                        </div>
                    </div>`;

                // Populate Datalist with existing tickers from RV assets
                setTimeout(() => {
                    const list = document.getElementById('invest-tickers-list');
                    if (list && window.mockRendaVariavelAssets) {
                        list.innerHTML = '';
                        const tickers = [...new Set(window.mockRendaVariavelAssets.map(a => a.ticker))].sort();
                        tickers.forEach(t => {
                            const opt = document.createElement('option');
                            opt.value = t;
                            list.appendChild(opt);
                        });
                    }
                }, 0);

                // Auto-Select Logic attached to window to ensure scope access
                window.autoSelectRVCategory = (val) => {
                    if (!val || val.length < 3) return;
                    const ticker = val.toUpperCase().trim();

                    // 1. Try to find in existing assets
                    const asset = window.mockRendaVariavelAssets.find(a => a.ticker === ticker);
                    if (asset) {
                        const typeSelect = document.getElementById('input-type');
                        if (typeSelect) {
                            // Map internal types to Select Values
                            // Options: Ação, FII, Exterior, Cripto
                            let targetVal = 'Ação';
                            if (asset.type === 'FII' || asset.type === 'FIIs') targetVal = 'FII';
                            else if (['Stock', 'ETF', 'REIT', 'Exterior'].includes(asset.type) || asset.currency === 'USD') targetVal = 'Exterior';
                            else if (asset.type === 'Cripto') targetVal = 'Cripto';
                            else if (asset.type === 'BDR') targetVal = 'Ação'; // or Exterior? Usually BDRs are traded as Ação locally but keep simple.

                            typeSelect.value = targetVal;
                            if (window.autoSelectCurrency) window.autoSelectCurrency(); // Trigger currency update if needed
                        }
                    }
                };
            } else if (context === 'tesouro') {
                modalFields.innerHTML = `
                    <div>
                        <label class="block text-xs font-bold text-slate-500 uppercase tracking-wider mb-2">Tipo / Título</label>
                        <select id="input-type" onchange="autoSelectRateType()" class="w-full px-4 py-3 rounded-xl border border-slate-200 dark:border-slate-600 dark:bg-slate-700 dark:text-slate-100 outline-none focus:border-primary transition-colors">
                            <option value="Tesouro Selic">Tesouro Selic</option>
                            <option value="Tesouro IPCA+">Tesouro IPCA+</option>
                            <option value="Tesouro Prefixado">Tesouro Prefixado</option>
                            <option value="Tesouro Renda+">Tesouro Renda+</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-slate-500 dark:text-slate-400 uppercase tracking-wider mb-2">Instituição / Nome</label>
                        <input type="text" id="input-issuer" value="Tesouro Nacional" class="w-full px-4 py-3 rounded-xl border border-slate-200 dark:border-slate-600 dark:bg-slate-700 dark:text-slate-100 outline-none focus:border-primary transition-colors">
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-slate-500 dark:text-slate-400 uppercase tracking-wider mb-2">Corretora</label>
                        <input type="text" id="input-broker" placeholder="Ex: XP, Rico" class="w-full px-4 py-3 rounded-xl border border-slate-200 dark:border-slate-600 dark:bg-slate-700 dark:text-slate-100 outline-none focus:border-primary transition-colors">
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-slate-500 dark:text-slate-400 uppercase tracking-wider mb-2">Vencimento</label>
                        <input type="date" id="input-maturity" class="w-full px-4 py-3 rounded-xl border border-slate-200 dark:border-slate-600 dark:bg-slate-700 dark:text-slate-100 outline-none focus:border-primary transition-colors">
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-slate-500 dark:text-slate-400 uppercase tracking-wider mb-2">Data da Aplicação</label>
                        <input type="date" id="application-date" class="w-full px-4 py-3 rounded-xl border border-slate-200 dark:border-slate-600 dark:bg-slate-700 dark:text-slate-100 outline-none focus:border-primary transition-colors">
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-xs font-bold text-slate-500 dark:text-slate-400 uppercase tracking-wider mb-2">Quantidade</label>
                            <input type="number" id="input-qty" step="0.01" placeholder="0.00" oninput="calculateTesouroTotal()" class="w-full px-4 py-3 rounded-xl border border-slate-200 dark:border-slate-600 dark:bg-slate-700 dark:text-slate-100 outline-none focus:border-primary transition-colors">
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-slate-500 dark:text-slate-400 uppercase tracking-wider mb-2">Preço Unitário</label>
                            <div class="relative">
                                <span class="dynamic-currency-symbol absolute left-4 top-3.5 text-slate-400 font-bold">R$</span>
                                <input type="number" id="input-unit-price" step="0.01" placeholder="0.00" oninput="calculateTesouroTotal()" class="w-full pl-12 pr-4 py-3 rounded-xl border border-slate-200 dark:border-slate-600 dark:bg-slate-700 dark:text-slate-100 outline-none focus:border-primary transition-colors">
                            </div>
                        </div>
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-slate-500 dark:text-slate-400 uppercase tracking-wider mb-2">Rentabilidade Contratada</label>
                        <div class="flex gap-2">
                            <select id="input-rate-type" class="w-1/3 px-4 py-3 rounded-xl border border-slate-200 dark:border-slate-600 dark:bg-slate-700 dark:text-slate-100 outline-none focus:border-primary transition-colors">
                                <option value="Selic">Selic +</option>
                                <option value="IPCA">IPCA +</option>
                                <option value="PRE">Pré</option>
                            </select>
                            <input type="number" id="input-rate-val" step="0.01" placeholder="0.00" class="w-2/3 px-4 py-3 rounded-xl border border-slate-200 dark:border-slate-600 dark:bg-slate-700 dark:text-slate-100 outline-none focus:border-primary transition-colors">
                        </div>
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-slate-400 uppercase tracking-wider mb-2">Total Investido</label>
                        <div class="relative">
                            <span class="dynamic-currency-symbol absolute left-4 top-3.5 text-slate-400 font-bold">R$</span>
                            <input type="number" id="input-total-calc" readonly class="w-full pl-12 pr-4 py-3 rounded-xl border border-slate-100 dark:border-slate-700 bg-slate-50 dark:bg-slate-800 font-bold text-lg text-slate-500 dark:text-slate-400 outline-none">
                        </div>
                    </div>`;
            } else {
                // Adicionado wrappers R$ fixos e placeholder para Reserva/Fixa
                modalFields.innerHTML = `
                    <div>
                        <label class="block text-xs font-bold text-slate-500 uppercase tracking-wider mb-2">Tipo</label>
                        <select id="input-type" class="w-full px-4 py-3 rounded-xl border border-slate-200 dark:border-slate-600 dark:bg-slate-700 dark:text-slate-100 outline-none focus:border-primary transition-colors">
                            <option>CDB</option>
                            <option>LCI</option>
                            <option>LCA</option>
                            <option>LC</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-slate-500 dark:text-slate-400 uppercase tracking-wider mb-2">Emissor</label>
                        <input type="text" id="input-issuer" class="w-full px-4 py-3 rounded-xl border border-slate-200 dark:border-slate-600 dark:bg-slate-700 dark:text-slate-100 outline-none focus:border-primary transition-colors">
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-slate-500 dark:text-slate-400 uppercase tracking-wider mb-2">Corretora</label>
                        <input type="text" id="input-broker" class="w-full px-4 py-3 rounded-xl border border-slate-200 dark:border-slate-600 dark:bg-slate-700 dark:text-slate-100 outline-none focus:border-primary transition-colors">
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-slate-500 dark:text-slate-400 uppercase tracking-wider mb-2">Rentabilidade</label>
                        <div class="flex gap-2">
                            <select id="input-rate-type" class="w-1/3 px-2 py-3 rounded-xl border border-slate-200 dark:border-slate-600 dark:bg-slate-700 dark:text-slate-100 outline-none focus:border-primary transition-colors">
                                <option value="CDI">% CDI</option>
                                <option value="IPCA">IPCA+</option>
                                <option value="PRE">Pré</option>
                            </select>
                            <input type="number" id="input-rate-val" step="0.01" placeholder="0.00" class="w-2/3 px-4 py-3 rounded-xl border border-slate-200 dark:border-slate-600 dark:bg-slate-700 dark:text-slate-100 outline-none focus:border-primary transition-colors">
                        </div>
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-slate-500 dark:text-slate-400 uppercase tracking-wider mb-2">Data</label>
                        <input type="date" id="application-date" class="w-full px-4 py-3 rounded-xl border border-slate-200 dark:border-slate-600 dark:bg-slate-700 dark:text-slate-100 outline-none focus:border-primary transition-colors">
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-slate-500 dark:text-slate-400 uppercase tracking-wider mb-2">Vencimento</label>
                        <input type="date" id="input-maturity" class="w-full px-4 py-3 rounded-xl border border-slate-200 dark:border-slate-600 dark:bg-slate-700 dark:text-slate-100 outline-none focus:border-primary transition-colors">
                    </div>
                    <div class="md:col-span-2">
                        <label class="block text-xs font-bold text-slate-500 dark:text-slate-400 uppercase tracking-wider mb-2">Valor Investido</label>
                        <div class="relative">
                            <span class="absolute left-4 top-3.5 text-slate-400 font-bold">R$</span>
                            <input type="number" id="input-invested" step="0.01" placeholder="0,00" class="w-full pl-12 pr-4 py-3 rounded-xl border border-slate-200 dark:border-slate-600 dark:bg-slate-700 dark:text-slate-100 font-bold text-lg outline-none focus:border-primary transition-colors">
                        </div>
                    </div>
                    <div class="md:col-span-2 pb-2">
                        <label class="flex items-center gap-3 p-3 rounded-xl border border-emerald-100 bg-emerald-50 dark:bg-emerald-900/30 dark:border-emerald-800 cursor-pointer">
                            <input type="checkbox" id="liquidity-check" class="peer h-5 w-5 rounded border-emerald-300 text-emerald-600">
                            <span class="text-sm font-semibold text-emerald-700 dark:text-emerald-400">Liquidez Diária?</span>
                        </label>
                    </div>`;
                setTimeout(() => { const chk = document.getElementById('liquidity-check'); if (chk) chk.checked = (context === 'reserva'); }, 0);
            }
            document.getElementById('application-date').value = new Date().toISOString().split('T')[0];

            // Setup Enter Key for this newly rendered content
            setupSaveOnEnter('modal-fields-container', window.saveNewAsset);
        }

        // --- LÓGICA DE PROVENTOS (NOVO) ---
        window.proventos = []; // Removed localStorage init, now managed by realtime listener

        window.currentProventosFilter = 'all';
        window.currentProventosPage = 1;
        window.ITEMS_PER_PAGE = 25;

        window.renderProventos = (filter = window.currentProventosFilter) => {
            if (filter !== window.currentProventosFilter) {
                window.currentProventosPage = 1; // Reset page on filter change
            }
            window.currentProventosFilter = filter;
            const tbody = document.getElementById('proventos-table-body');
            const emptyState = document.getElementById('proventos-empty-state');
            if (!tbody) return;

            // Updated Filter Styles
            document.querySelectorAll('.prov-filter-btn').forEach(btn => {
                const btnText = btn.textContent.trim();
                const filterMatch = (filter === 'all' && btnText === 'Todos') ||
                    (filter === 'Ação' && btnText === 'Ações') ||
                    (filter === 'FII' && btnText === 'FIIs') ||
                    (filter === 'Exterior' && btnText === 'Exterior');

                if (filterMatch) {
                    btn.className = "prov-filter-btn bg-emerald-600 text-white px-3 py-1.5 rounded-lg text-xs font-bold transition-all shadow-sm ring-2 ring-emerald-600 ring-offset-1";
                } else {
                    btn.className = "prov-filter-btn bg-slate-50 dark:bg-slate-800 text-slate-500 dark:text-slate-400 hover:bg-slate-100 dark:hover:bg-slate-700 px-3 py-1.5 rounded-lg text-xs font-bold transition-all";
                }
            });

            tbody.innerHTML = '';
            let filtered = [...window.proventos];

            if (filter !== 'all') {
                filtered = filtered.filter(p => {
                    const cat = p.category || '';
                    if (filter === 'Ação') return cat === 'Ação' || cat === 'BDR';
                    if (filter === 'FII') return cat === 'FII';
                    if (filter === 'Exterior') return cat === 'Exterior' || cat === 'BDR' || p.currency === 'USD'; // BDR can be filtered here if desired, or under Ação
                    return cat === filter;
                });
            }

            // --- Paginação ---
            const totalItems = filtered.length;
            const totalPages = Math.ceil(totalItems / window.ITEMS_PER_PAGE) || 1;

            if (window.currentProventosPage > totalPages) window.currentProventosPage = totalPages;
            if (window.currentProventosPage < 1) window.currentProventosPage = 1;

            const startIdx = (window.currentProventosPage - 1) * window.ITEMS_PER_PAGE;
            const endIdx = startIdx + window.ITEMS_PER_PAGE;
            const pageItems = filtered.slice(startIdx, endIdx);

            const sorted = pageItems.sort((a, b) => new Date(b.date) - new Date(a.date));

            if (filtered.length === 0) {
                if (emptyState) emptyState.classList.remove('hidden');
                if (document.getElementById('proventos-pagination')) document.getElementById('proventos-pagination').classList.add('hidden');
            } else {
                if (emptyState) emptyState.classList.add('hidden');

                // Show pagination if needed
                const pagDiv = document.getElementById('proventos-pagination');
                if (pagDiv) {
                    if (totalItems > window.ITEMS_PER_PAGE) {
                        pagDiv.classList.remove('hidden');
                        document.getElementById('prov-page-info').textContent = `Página ${window.currentProventosPage} de ${totalPages}`;

                        const btnPrev = document.getElementById('prov-prev-page');
                        const btnNext = document.getElementById('prov-next-page');

                        btnPrev.onclick = () => { if (window.currentProventosPage > 1) { window.currentProventosPage--; window.renderProventos(filter); } };
                        btnNext.onclick = () => { if (window.currentProventosPage < totalPages) { window.currentProventosPage++; window.renderProventos(filter); } };

                        btnPrev.disabled = window.currentProventosPage === 1;
                        btnNext.disabled = window.currentProventosPage === totalPages;
                    } else {
                        pagDiv.classList.add('hidden');
                    }
                }

                sorted.forEach(p => {
                    const tr = document.createElement('tr');
                    tr.className = "hover:bg-slate-50 dark:hover:bg-slate-700/50 border-b border-slate-50 dark:border-slate-800 transition-colors";

                    const symbol = p.currency === 'USD' ? 'US$' : 'R$';
                    const valClass = "font-bold text-emerald-600";

                    // Ícone do Evento
                    let eventIcon = '<i class="fa-solid fa-coins text-yellow-500"></i>';
                    if (p.event === 'Dividendo') eventIcon = '<i class="fa-solid fa-hand-holding-dollar text-emerald-500"></i>';
                    else if (p.event === 'JCP') eventIcon = '<i class="fa-solid fa-building-columns text-blue-500"></i>';

                    const dateParts = p.date.split('-');
                    const dateFmt = `${dateParts[2]}/${dateParts[1]}/${dateParts[0]}`;

                    // Se for USD, mostra tooltip com conversão ou valor original
                    let displayVal = parseFloat(p.value).toFixed(2);
                    let subVal = '';
                    if (p.currency === 'USD' && p.exchangeRate) {
                        const brlVal = p.value * p.exchangeRate;
                        subVal = `<div class="text-[10px] text-slate-400 font-normal">≈ ${formatCurrency(brlVal)}</div>`;
                    }

                    tr.innerHTML = `
                        <td class="px-6 py-4 pl-6 text-slate-600 dark:text-slate-400 font-medium">${dateFmt}</td>
                        <td class="px-6 py-4 font-bold text-slate-800 dark:text-slate-100">${p.asset}</td>
                        <td class="px-6 py-4"><span class="px-2 py-1 text-xs font-bold rounded bg-slate-100 dark:bg-slate-800 text-slate-600 dark:text-slate-400 border border-slate-200 dark:border-slate-700">${p.category}</span></td>
                        <td class="px-6 py-4 text-slate-600 dark:text-slate-400 flex items-center gap-2">${eventIcon} ${p.event}</td>
                        <td class="px-6 py-4 text-right pr-6">
                            <div class="${valClass}">${symbol} ${displayVal}</div>
                            ${subVal}
                        </td>
                        <td class="px-6 py-4 text-center pr-6">
                            <div class="flex items-center justify-center gap-2">
                                <button onclick="window.editProvento('${p.id}')" title="Editar" class="w-8 h-8 rounded-full bg-slate-50 dark:bg-slate-800 hover:bg-white dark:hover:bg-slate-700 hover:shadow text-slate-400 hover:text-blue-500 transition-all border border-transparent hover:border-slate-100 dark:hover:border-slate-600">
                                    <i class="fa-solid fa-pen text-xs"></i>
                                </button>
                                <button onclick="window.deleteProvento('${p.id}')" title="Excluir" class="w-8 h-8 rounded-full bg-slate-50 dark:bg-slate-800 hover:bg-white dark:hover:bg-slate-700 hover:shadow text-slate-400 hover:text-red-500 transition-all border border-transparent hover:border-slate-100 dark:hover:border-slate-600">
                                    <i class="fa-solid fa-trash text-xs"></i>
                                </button>
                            </div>
                        </td>
                    `;
                    tbody.appendChild(tr);
                });
            }

            // --- Cálculos do Dashboard ---
            let total = 0, last12m = 0, ytd = 0, lastMonth = 0, thisMonth = 0;
            const now = new Date();
            const currentYear = now.getFullYear();
            const currentMonth = now.getMonth(); // 0-11

            // Definição de range para Last Month
            const lastMonthDate = new Date(currentYear, currentMonth - 1, 1);
            const lastMonthIdx = lastMonthDate.getMonth();
            const lastMonthYear = lastMonthDate.getFullYear();

            filtered.forEach(p => {
                // Ensure date string is parsed correctly without timezone issues (YYYY-MM-DD -> Local)
                const parts = p.date.split('-');
                const d = new Date(parts[0], parts[1] - 1, parts[2]); // Local Time

                let val = parseFloat(p.value);
                // Converte para BRL usando taxa salva ou fallback global
                if (p.currency === 'USD') {
                    if (p.exchangeRate) val *= p.exchangeRate;
                    else val *= (window.currentUsdRate || 5.0);
                }

                total += val;

                // YTD (Ano Atual)
                if (d.getFullYear() === currentYear) ytd += val;

                // 12m (Últimos 365 dias)
                const diffTime = now - d;
                const diffDays = diffTime / (1000 * 60 * 60 * 24);
                if (diffDays >= 0 && diffDays <= 365) last12m += val;

                // This Month
                if (d.getMonth() === currentMonth && d.getFullYear() === currentYear) thisMonth += val;

                // Last Month
                if (d.getMonth() === lastMonthIdx && d.getFullYear() === lastMonthYear) lastMonth += val;
            });

            // Atualiza Cards
            if (document.getElementById('prov-total')) document.getElementById('prov-total').textContent = formatCurrency(total);
            if (document.getElementById('prov-12m')) document.getElementById('prov-12m').textContent = formatCurrency(last12m);
            if (document.getElementById('prov-ytd')) document.getElementById('prov-ytd').textContent = formatCurrency(ytd);
            if (document.getElementById('prov-last-month')) document.getElementById('prov-last-month').textContent = formatCurrency(lastMonth);
            if (document.getElementById('prov-this-month')) document.getElementById('prov-this-month').textContent = formatCurrency(thisMonth);

            // Calc % Change (Este Mês vs Mês Passado)
            const changeEl = document.getElementById('prov-month-change');
            if (changeEl) {
                if (lastMonth > 0) {
                    const change = ((thisMonth - lastMonth) / lastMonth) * 100;
                    const sign = change >= 0 ? '+' : '';
                    changeEl.textContent = `${sign}${change.toFixed(1)}%`;
                    changeEl.className = `text-xs font-bold px-1.5 py-0.5 rounded ${change >= 0 ? 'bg-emerald-100 text-emerald-700' : 'bg-red-100 text-red-700'} mb-1`;
                } else if (thisMonth > 0) {
                    changeEl.textContent = "+Inf";
                    changeEl.className = "text-xs font-bold px-1.5 py-0.5 rounded bg-emerald-100 text-emerald-700 mb-1";
                } else {
                    changeEl.textContent = "-";
                    changeEl.className = "text-xs font-bold px-1.5 py-0.5 rounded bg-slate-100 text-slate-500 mb-1 opacity-50";
                }
            }

            // Update Charts
            if (window.renderProventosCharts) window.renderProventosCharts(filtered);


            if (window.updateProventosGoalCard) window.updateProventosGoalCard(ytd);
        }


        // --- Proventos Charts Logic ---
        window.proventosMainChart = null;
        window.proventosCompChart = null;

        // Register Plugin if available (it is auto-registered usually, but good practice to be explicit if using modules, here global script)
        if (typeof ChartDataLabels !== 'undefined') Chart.register(ChartDataLabels);

        window.renderProventosCharts = (data = null) => {
            // Retrieve current filtered data from context if not passed
            if (!data) {
                data = window.proventos || [];
                const filter = window.currentProventosFilter || 'all';
                if (filter !== 'all') {
                    data = data.filter(p => {
                        const cat = p.category || '';
                        if (filter === 'Ação') return cat === 'Ação' || cat === 'BDR';
                        if (filter === 'FII') return cat === 'FII';
                        if (filter === 'Exterior') return cat === 'Exterior' || cat === 'BDR' || p.currency === 'USD';
                        return cat === filter;
                    });
                }
            }

            const grouping = document.getElementById('chart-grouping') ? document.getElementById('chart-grouping').value : 'monthly';
            const range = document.getElementById('chart-range') ? document.getElementById('chart-range').value : 'all';

            if (typeof Chart === 'undefined') return;

            // 2. Filter by Date Range
            const now = new Date();
            let cutoffDate = null;
            if (range === '6m') cutoffDate = new Date(now.getFullYear(), now.getMonth() - 6, 1);
            else if (range === '1y') cutoffDate = new Date(now.getFullYear() - 1, now.getMonth(), 1);
            else if (range === '2y') cutoffDate = new Date(now.getFullYear() - 2, now.getMonth(), 1);
            else if (range === '5y') cutoffDate = new Date(now.getFullYear() - 5, now.getMonth(), 1);

            const chartData = cutoffDate ? data.filter(p => new Date(p.date) >= cutoffDate) : data;

            // 3. Agrupamento Logic & Detailed Aggregation
            const groups = {}; // Key -> { total: 0, assets: { 'PETR4': 100 } }

            const sortedForChart = [...chartData].sort((a, b) => new Date(a.date) - new Date(b.date));

            sortedForChart.forEach(p => {
                const parts = p.date.split('-');
                const d = new Date(parts[0], parts[1] - 1, parts[2]);

                let key = '';
                if (grouping === 'monthly') {
                    key = `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}`;
                } else if (grouping === 'quarterly') {
                    const q = Math.floor(d.getMonth() / 3) + 1;
                    key = `${d.getFullYear()}-Q${q}`;
                } else if (grouping === 'semiannual') {
                    const s = d.getMonth() < 6 ? 1 : 2;
                    key = `${d.getFullYear()}-S${s}`;
                } else if (grouping === 'annual') {
                    key = `${d.getFullYear()}`;
                }

                if (!groups[key]) groups[key] = { total: 0, assets: {} };

                let val = parseFloat(p.value);
                if (p.currency === 'USD') {
                    if (p.exchangeRate) val *= p.exchangeRate;
                    else val *= (window.currentUsdRate || 5.0);
                }

                groups[key].total += val;

                // Track asset contribution
                const assetName = p.asset || 'Outros';
                groups[key].assets[assetName] = (groups[key].assets[assetName] || 0) + val;
            });

            const labels = Object.keys(groups);
            const values = labels.map(k => groups[k].total);

            // 4. Render Main Chart
            const ctxMain = document.getElementById('proventos-main-chart');
            if (ctxMain) {
                if (window.proventosMainChart) window.proventosMainChart.destroy();
                const currencyFormatter = (value) => value.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL', maximumFractionDigits: 0 });

                window.proventosMainChart = new Chart(ctxMain, {
                    type: 'bar',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'Proventos (R$)',
                            data: values,
                            backgroundColor: '#10b981',
                            borderRadius: 4,
                            barThickness: grouping === 'annual' ? 60 : 'flex',
                            maxBarThickness: 60
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { display: false },
                            datalabels: {
                                display: grouping !== 'monthly',
                                anchor: 'end',
                                align: 'top',
                                formatter: (val) => formatCurrency(val), // Compact currency? formatCurrency is full.
                                font: { weight: 'bold', size: 10 },
                                color: document.documentElement.classList.contains('dark') ? '#cbd5e1' : '#64748b'
                            },
                            tooltip: {
                                callbacks: {
                                    label: (ctx) => ctx.parsed.y.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' }),
                                    afterBody: (tooltipItems) => {
                                        const idx = tooltipItems[0].dataIndex;
                                        const label = labels[idx];
                                        const details = groups[label].assets;
                                        // Sort desc
                                        const sortedAssets = Object.entries(details).sort((a, b) => b[1] - a[1]);
                                        // Top 10
                                        const top10 = sortedAssets.slice(0, 10);

                                        let lines = [' ', 'Maiores Pagadores:'];
                                        top10.forEach(item => {
                                            lines.push(`${item[0]}: ${formatCurrency(item[1])}`);
                                        });
                                        return lines;
                                    }
                                }
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                grid: { color: document.documentElement.classList.contains('dark') ? '#334155' : '#f1f5f9' },
                                ticks: {
                                    callback: (val) => currencyFormatter(val),
                                    font: { size: 10 },
                                    color: document.documentElement.classList.contains('dark') ? '#94a3b8' : '#64748b'
                                }
                            },
                            x: {
                                grid: { display: false },
                                ticks: {
                                    font: { size: 10 },
                                    color: document.documentElement.classList.contains('dark') ? '#94a3b8' : '#64748b'
                                }
                            }
                        }
                    },
                    plugins: [ChartDataLabels] // Ensure local activation if global fails
                });
            }

            // 5. Composition Logic (Horizontal Stacked)
            let comp = { 'Ação': 0, 'FII': 0, 'Exterior': 0 };
            let others = 0;

            chartData.forEach(p => {
                let val = parseFloat(p.value);
                if (p.currency === 'USD') {
                    if (p.exchangeRate) val *= p.exchangeRate;
                    else val *= (window.currentUsdRate || 5.0);
                }
                if (p.category === 'Ação' || p.category === 'BDR') comp['Ação'] += val;
                else if (p.category === 'FII') comp['FII'] += val;
                else if (p.category === 'Exterior' || p.currency === 'USD') comp['Exterior'] += val;
                else others += val;
            });

            // "Grey Space" Fix: Make sure x-axis max is correct. 
            // If we only plot 3 categories, we should scale to the sum of those 3 
            // OR include others if significant. 
            // Ideally we scale to the Total, so if others > 0 it shows as empty space (transparent) or we add a grey bar.
            // User complained about "grey space" which implies they want it FILLED.
            // So we should normalize percentages to the displayed segments or add "Outros".
            // Let's add "Outros" if > 0 to be accurate.

            const totalDisplayed = comp['Ação'] + comp['FII'] + comp['Exterior'] + others;

            const ctxComp = document.getElementById('proventos-composition-chart');
            if (ctxComp) {
                if (window.proventosCompChart) window.proventosCompChart.destroy();
                const legendDiv = document.getElementById('chart-comp-legend');
                if (legendDiv) {
                    const pAcao = totalDisplayed ? ((comp['Ação'] / totalDisplayed) * 100).toFixed(1) : 0;
                    const pFii = totalDisplayed ? ((comp['FII'] / totalDisplayed) * 100).toFixed(1) : 0;
                    const pExt = totalDisplayed ? ((comp['Exterior'] / totalDisplayed) * 100).toFixed(1) : 0;

                    let html = `
                        <div class="text-emerald-500">Ações: ${formatCurrency(comp['Ação'])} (${pAcao}%)</div>
                        <div class="text-blue-500">FIIs: ${formatCurrency(comp['FII'])} (${pFii}%)</div>
                        <div class="text-purple-500">Exterior: ${formatCurrency(comp['Exterior'])} (${pExt}%)</div>
                    `;
                    if (others > 0.01) {
                        const pOthers = ((others / totalDisplayed) * 100).toFixed(1);
                        html += `<div class="text-slate-500">Outros: ${formatCurrency(others)} (${pOthers}%)</div>`;
                    }

                    legendDiv.innerHTML = html;
                }

                window.proventosCompChart = new Chart(ctxComp, {
                    type: 'bar',
                    data: {
                        labels: ['Composição'],
                        datasets: [
                            { label: 'Ações', data: [comp['Ação']], backgroundColor: '#10b981', barThickness: 30 },
                            { label: 'FIIs', data: [comp['FII']], backgroundColor: '#3b82f6', barThickness: 30 },
                            { label: 'Exterior', data: [comp['Exterior']], backgroundColor: '#a855f7', barThickness: 30 },
                            // Add Others if exists so it fills the bar
                            { label: 'Outros', data: [others], backgroundColor: '#cbd5e1', barThickness: 30 }
                        ]
                    },
                    options: {
                        indexAxis: 'y',
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { display: false },
                            tooltip: { enabled: false }, // User requested removal
                            datalabels: { display: false } // No labels on this
                        },
                        scales: {
                            x: {
                                stacked: true,
                                display: false,
                                min: 0,
                                max: totalDisplayed // Force exact max to avoid padding gap 
                            },
                            y: { stacked: true, display: false }
                        },
                        layout: { padding: 0 } // Remove layout padding
                    }
                });
            }
        };

        // --- Lógica Modal Proventos ---
        window.openProventosModal = () => {
            const modal = document.getElementById('proventos-modal');
            modal.classList.remove('hidden');
            setTimeout(() => {
                modal.classList.remove('opacity-0');
                document.getElementById('proventos-modal-content').classList.remove('opacity-0', 'scale-95');
                document.getElementById('proventos-modal-content').classList.add('scale-100');
            }, 10);

            // Populate Datalist (moved here or keep in reset? Better here to ensure fresh list)
            const datalist = document.getElementById('rv-assets-list');
            if (datalist) {
                datalist.innerHTML = '';
                const tickers = [...new Set(window.mockRendaVariavelAssets.map(a => a.ticker))].sort();
                tickers.forEach(t => {
                    const opt = document.createElement('option');
                    opt.value = t;
                    datalist.appendChild(opt);
                });
            }
        }

        window.resetProventosForm = () => {
            document.getElementById('prov-edit-id').value = '';
            document.getElementById('prov-date').value = new Date().toISOString().split('T')[0];
            document.getElementById('prov-asset').value = '';
            document.getElementById('prov-category').value = '';
            document.getElementById('prov-event').value = 'Dividendo'; // Default
            document.getElementById('prov-event').innerHTML = '<option value="Dividendo">Dividendo</option><option value="JCP">JCP</option><option value="Rendimento">Rendimento</option><option value="Outros">Outros</option>'; // Reset Options fallback or better:

            // Re-populate default options if cleared
            const eventSelect = document.getElementById('prov-event');
            eventSelect.innerHTML = '';
            ['Dividendo', 'JCP', 'Rendimento', 'Bonificação', 'Outros'].forEach(opt => {
                const el = document.createElement('option');
                el.value = opt;
                el.textContent = opt;
                eventSelect.appendChild(el);
            });

            document.getElementById('prov-value').value = '';
            document.getElementById('prov-usd-rate').value = '';
            window.setProventosCurrency('BRL');
        }

        window.closeProventosModal = () => {
            const modal = document.getElementById('proventos-modal');
            modal.classList.add('opacity-0');
            document.getElementById('proventos-modal-content').classList.remove('scale-100');
            document.getElementById('proventos-modal-content').classList.add('opacity-0', 'scale-95');
            setTimeout(() => modal.classList.add('hidden'), 300);
        }

        window.autoFillProventosCategory = (ticker) => {
            if (!ticker) return;
            const upperTicker = ticker.toUpperCase();
            let categoryToSet = '';

            // 1. Busca nos Ativos Atuais
            const asset = window.mockRendaVariavelAssets.find(a => a.ticker === upperTicker);
            if (asset) {
                if (asset.type === 'Ação') categoryToSet = 'Ação';
                else if (asset.type === 'FII' || asset.type === 'FIIs') categoryToSet = 'FII';
                else if (['Stock', 'ETF', 'REIT', 'Exterior'].includes(asset.type) || asset.currency === 'USD') categoryToSet = 'Exterior';
                else if (asset.type === 'BDR') categoryToSet = 'BDR';
            }

            // 2. Fallback: Busca no Histórico de Proventos (para ativos já vendidos)
            if (!categoryToSet && window.proventos) {
                const pastProv = window.proventos.find(p => p.asset === upperTicker);
                if (pastProv && pastProv.category) {
                    categoryToSet = pastProv.category;
                }
            }

            if (categoryToSet) {
                const catSelect = document.getElementById('prov-category');
                catSelect.value = categoryToSet;

                // Dispara automações dependentes da categoria
                window.checkProventosCurrency();
                window.checkProventosEvent();
            }
        }

        window.checkProventosCurrency = () => {
            const cat = document.getElementById('prov-category').value;
            if (cat === 'Exterior') window.setProventosCurrency('USD');
            else window.setProventosCurrency('BRL');
        }

        window.checkProventosEvent = () => {
            const cat = document.getElementById('prov-category').value;
            const eventSelect = document.getElementById('prov-event');
            if (!eventSelect) return;

            // Limpa opções
            eventSelect.innerHTML = '';

            if (cat === 'Ação') {
                ['Dividendo', 'JCP', 'Bonificação'].forEach(opt => {
                    const el = document.createElement('option');
                    el.value = opt;
                    el.textContent = opt;
                    eventSelect.appendChild(el);
                });
            } else if (cat === 'FII') {
                const el = document.createElement('option');
                el.value = 'Rendimento';
                el.textContent = 'Rendimento';
                eventSelect.appendChild(el);
            } else if (cat === 'Exterior') {
                const el = document.createElement('option');
                el.value = 'Dividendo';
                el.textContent = 'Dividendo';
                eventSelect.appendChild(el);
            } else {
                // Default fallback
                ['Dividendo', 'JCP', 'Rendimento', 'Bonificação', 'Outros'].forEach(opt => {
                    const el = document.createElement('option');
                    el.value = opt;
                    el.textContent = opt;
                    eventSelect.appendChild(el);
                });
            }
        }

        window.setProventosCurrency = (curr) => {
            const btnBrl = document.getElementById('btn-curr-brl');
            const btnUsd = document.getElementById('btn-curr-usd');
            const symbol = document.getElementById('prov-currency-symbol');
            const modal = document.getElementById('proventos-modal');
            const rateContainer = document.getElementById('prov-rate-container');
            const taxContainer = document.getElementById('prov-tax-container');
            const convDisplay = document.getElementById('prov-converted-display');

            if (curr === 'USD') {
                btnUsd.className = "h-full px-3 rounded-lg text-xs font-bold bg-white shadow-sm text-slate-800 ring-2 ring-emerald-100";
                btnBrl.className = "h-full px-3 rounded-lg text-xs font-bold text-slate-500 hover:bg-white hover:shadow-sm";
                symbol.textContent = "US$";
                modal.dataset.currency = 'USD';

                // Show Rate & Tax Fields
                if (rateContainer) rateContainer.classList.remove('hidden');
                if (taxContainer) taxContainer.classList.remove('hidden');
                if (convDisplay) convDisplay.classList.remove('hidden');
            } else {
                btnBrl.className = "h-full px-3 rounded-lg text-xs font-bold bg-white shadow-sm text-slate-800 ring-2 ring-emerald-100";
                btnUsd.className = "h-full px-3 rounded-lg text-xs font-bold text-slate-500 hover:bg-white hover:shadow-sm";
                symbol.textContent = "R$";
                modal.dataset.currency = 'BRL';

                // Hide Rate & Tax Fields
                if (rateContainer) rateContainer.classList.add('hidden');
                if (taxContainer) taxContainer.classList.add('hidden');
                if (convDisplay) convDisplay.classList.add('hidden');
            }
            if (window.calculateProventosConversion) window.calculateProventosConversion();
        }

        window.saveProvento = () => {
            const date = document.getElementById('prov-date').value;
            const asset = document.getElementById('prov-asset').value.toUpperCase();
            const category = document.getElementById('prov-category').value;
            const event = document.getElementById('prov-event').value;
            let value = parseFloat(document.getElementById('prov-value').value);
            const tax = parseFloat(document.getElementById('prov-tax').value) || 0;
            const currency = document.getElementById('proventos-modal').dataset.currency || 'BRL';

            if (!validateInputs('proventos-modal-content')) return;

            if (!asset || !value || !date) return alert("Preencha data, ativo e valor.");

            let exchangeRate = 1;
            if (currency === 'USD') {
                exchangeRate = parseFloat(document.getElementById('prov-usd-rate').value);
                if (!exchangeRate || exchangeRate <= 0) return alert("Insira a Cotação do Dólar.");

                // Deduct taxes from the gross value to get the net value
                value = value - tax;
            }

            const id = document.getElementById('prov-edit-id').value;

            // Construct object
            // Use existing ID if editing, else generate new string ID (timestamp based is fine for unique key)
            const docId = id || Date.now().toString();

            const provObj = {
                id: docId,
                date, asset, category, event, value, currency, exchangeRate, tax
            };

            if (id) {
                // Edit
                if (window.firebaseUpdateProvento) {
                    window.firebaseUpdateProvento(id, provObj);
                    showSuccessMessage("Atualizando...");
                }
            } else {
                // New
                if (window.firebaseSaveProvento) {
                    window.firebaseSaveProvento(provObj);
                    showSuccessMessage("Salvando...");
                }
            }

            window.closeProventosModal();
        }

        window.calculateProventosConversion = () => {
            const curr = document.getElementById('proventos-modal').dataset.currency;
            const val = window.parseCurrencyValue(document.getElementById('prov-value').value);
            const tax = window.parseCurrencyValue(document.getElementById('prov-tax').value);
            const display = document.getElementById('prov-converted-display');

            if (curr === 'USD') {
                const rate = parseFloat(document.getElementById('prov-usd-rate').value) || 0;
                const netVal = val - tax;
                const converted = netVal * rate;
                display.textContent = `≈ ${formatCurrency(converted)}`;
            } else {
                display.textContent = ``;
            }
        }

        window.editProvento = (id) => {
            const p = window.proventos.find(item => item.id === id);
            if (!p) return;

            document.getElementById('prov-edit-id').value = p.id;
            document.getElementById('prov-date').value = p.date;
            document.getElementById('prov-asset').value = p.asset;
            document.getElementById('prov-category').value = p.category;

            window.checkProventosEvent(); // Update options based on category

            document.getElementById('prov-event').value = p.event;
            document.getElementById('prov-event').value = p.event;

            // If there's a tax saved, we need to add it back to the value for the input (Gross)
            // because we saved the Net value.
            const taxVal = p.tax || 0;
            document.getElementById('prov-value').value = p.value + (p.currency === 'USD' ? taxVal : 0);
            document.getElementById('prov-tax').value = taxVal > 0 ? taxVal : '';

            if (p.currency === 'USD') {
                document.getElementById('prov-usd-rate').value = p.exchangeRate || '';
                window.setProventosCurrency('USD');
            } else {
                document.getElementById('prov-usd-rate').value = '';
                document.getElementById('prov-tax').value = '';
                window.setProventosCurrency('BRL');
            }

            window.openProventosModal();
        }

        let proventoToDeleteId = null;

        window.deleteProvento = (id) => {
            proventoToDeleteId = id;
            const modal = document.getElementById('delete-modal');
            modal.classList.remove('hidden');
            setTimeout(() => {
                modal.classList.remove('opacity-0');
                document.getElementById('delete-modal-content').classList.remove('opacity-0', 'scale-95');
                document.getElementById('delete-modal-content').classList.add('scale-100');
            }, 10);
        }

        window.closeDeleteModal = () => {
            const modal = document.getElementById('delete-modal');
            modal.classList.add('opacity-0');
            document.getElementById('delete-modal-content').classList.remove('scale-100');
            document.getElementById('delete-modal-content').classList.add('opacity-0', 'scale-95');
            setTimeout(() => modal.classList.add('hidden'), 300);
            proventoToDeleteId = null;
        }

        window.confirmDeleteProvento = () => {
            if (proventoToDeleteId) {
                if (window.firebaseDeleteProvento) {
                    window.firebaseDeleteProvento(proventoToDeleteId);
                    showSuccessMessage("Excluindo...");
                }
            }
            closeDeleteModal();
        }

        // --- Proventos Goal Logic ---
        window.proventosGoal = parseFloat(localStorage.getItem('proventosGoal')) || 0;

        window.openProventosGoalModal = () => {
            const modal = document.getElementById('proventos-goal-modal');
            document.getElementById('input-proventos-goal').value = window.proventosGoal || '';
            modal.classList.remove('hidden');
            setTimeout(() => {
                modal.classList.remove('opacity-0');
                document.getElementById('proventos-goal-modal-content').classList.remove('opacity-0', 'scale-95');
                document.getElementById('proventos-goal-modal-content').classList.add('scale-100');
            }, 10);
        }

        window.closeProventosGoalModal = () => {
            const modal = document.getElementById('proventos-goal-modal');
            modal.classList.add('opacity-0');
            document.getElementById('proventos-goal-modal-content').classList.remove('scale-100');
            document.getElementById('proventos-goal-modal-content').classList.add('opacity-0', 'scale-95');
            setTimeout(() => modal.classList.add('hidden'), 300);
        }

        window.saveProventosGoal = () => {
            const val = parseFloat(document.getElementById('input-proventos-goal').value);
            if (isNaN(val) || val < 0) return alert("Insira um valor válido.");

            window.proventosGoal = val;

            // Save to Firebase if available, otherwise fallback/local (though app relies on online)
            if (window.firebaseSaveProventosGoal) {
                window.firebaseSaveProventosGoal(val);
            } else {
                localStorage.setItem('proventosGoal', window.proventosGoal);
            }

            window.renderProventos(); // Update card
            window.closeProventosGoalModal();
            showSuccessMessage("Meta atualizada!");
        }

        window.updateProventosGoalCard = (ytdValue) => {
            const cardContent = document.getElementById('proventos-goal-card-content');
            if (!cardContent) return;

            const goal = window.proventosGoal;

            if (!goal || goal <= 0) {
                cardContent.innerHTML = `
                    <p class="text-primary-light text-sm font-medium mb-1">Meta de Proventos</p>
                    <div class="h-20 flex flex-col items-center justify-center">
                         <p class="text-lg font-bold">R$ 0,00</p>
                         <p class="text-xs opacity-75">Insira a meta de proventos</p>
                    </div>
                `;
                return;
            }

            const progress = Math.min((ytdValue / goal) * 100, 100);
            const isCompleted = ytdValue >= goal;

            if (isCompleted) {
                cardContent.innerHTML = `
                    <p class="text-primary-light text-sm font-medium mb-1">Meta de Proventos</p>
                    <div class="h-20 flex flex-col items-center justify-center">
                         <div class="text-3xl mb-1">🎉</div>
                         <p class="text-sm font-bold">Parabéns! Meta Atingida!</p>
                         <p class="text-xs opacity-75">${formatCurrency(ytdValue)} / ${formatCurrency(goal)}</p>
                    </div>
                `;
            } else {
                cardContent.innerHTML = `
                    <p class="text-primary-light text-sm font-medium mb-1">Meta de Proventos</p>
                    <div class="h-20 flex flex-col justify-center">
                         <div class="flex justify-between items-end mb-1">
                            <span class="text-2xl font-bold">${progress.toFixed(0)}%</span>
                            <span class="text-xs opacity-75 mb-1">${formatCurrency(ytdValue)} / ${formatCurrency(goal)}</span>
                         </div>
                         <div class="w-full bg-black/20 rounded-full h-1.5 overflow-hidden">
                            <div class="bg-white h-full rounded-full transition-all duration-1000" style="width: ${progress}%"></div>
                         </div>
                    </div>
                `;
            }
        }

        // --- Easter Egg Changelog ---
        let versionClickCount = 0;
        let versionClickTimer = null;

        window.handleVersionClick = () => {
            versionClickCount++;

            if (versionClickTimer) clearTimeout(versionClickTimer);

            versionClickTimer = setTimeout(() => {
                versionClickCount = 0;
            }, 1000); // Reset after 1 second of inactivity

            if (versionClickCount === 3) {
                openChangelogModal();
                versionClickCount = 0;
                clearTimeout(versionClickTimer);
            }
        };

        window.openChangelogModal = () => {
            const modal = document.getElementById('changelog-modal');
            modal.classList.remove('hidden');
            setTimeout(() => {
                modal.classList.remove('opacity-0');
                document.getElementById('changelog-modal-content').classList.remove('opacity-0', 'scale-95');
                document.getElementById('changelog-modal-content').classList.add('scale-100');
            }, 10);
        }

        window.closeChangelogModal = () => {
            const modal = document.getElementById('changelog-modal');
            modal.classList.add('opacity-0');
            document.getElementById('changelog-modal-content').classList.remove('scale-100');
            document.getElementById('changelog-modal-content').classList.add('opacity-0', 'scale-95');
            setTimeout(() => modal.classList.add('hidden'), 300);
        }

        document.addEventListener('DOMContentLoaded', () => {
            if (window.renderDashboard) window.renderDashboard();
            window.renderProventos();
        });
    </script>

    <!-- Changelog Modal -->
    <div id="changelog-modal"
        class="fixed inset-0 bg-slate-900/60 z-[80] hidden flex items-center justify-center backdrop-blur-sm transition-opacity opacity-0">
        <div class="bg-white rounded-2xl shadow-2xl p-6 w-full max-w-md transform scale-95 opacity-0 transition-all"
            id="changelog-modal-content">
            <h3 class="font-bold text-lg text-slate-800 mb-4 flex items-center gap-2">
                <i class="fa-solid fa-rocket text-primary"></i> Novidades da Versão 1.5.0
            </h3>
            <div class="space-y-4 text-sm text-slate-600 mb-6 max-h-[60vh] overflow-y-auto">
                <div class="p-3 bg-slate-50 rounded-lg border border-slate-100">
                    <p class="font-bold text-slate-800 mb-1">✨ Experiência de Uso (UX)</p>
                    <ul class="list-disc list-inside space-y-1 text-xs">
                        <li><strong>Salvar com Enter:</strong> Mais agilidade em todos os formulários.</li>
                        <li><strong>Alerta de Validação:</strong> Nova configuração opcional para evitar cadastros
                            incompletos.</li>
                    </ul>
                </div>
                <div class="p-3 bg-slate-50 rounded-lg border border-slate-100">
                    <p class="font-bold text-slate-800 mb-1">💰 Evolução nos Proventos</p>
                    <ul class="list-disc list-inside space-y-1 text-xs">
                        <li><strong>Preenchimento Inteligente:</strong> O sistema agora lembra a categoria de ativos
                            antigos do seu histórico.</li>
                        <li><strong>Correção de Contexto:</strong> "Novo Aporte" na tela de proventos abre o formulário
                            correto.</li>
                        <li><strong>Gráficos Aprimorados:</strong> Visualização mensal/anual mais limpa e tooltips
                            informativos.</li>
                    </ul>
                </div>
                <div class="p-3 bg-slate-50 rounded-lg border border-slate-100">
                    <p class="font-bold text-slate-800 mb-1">🚀 Tesouro & Melhorias Gerais</p>
                    <ul class="list-disc list-inside space-y-1 text-xs">
                        <li><strong>Tesouro Direto:</strong> Ordenação inteligente por vencimento e filtros
                            persistentes.</li>
                        <li><strong>Meta Anual:</strong> Cards redesenhados para melhor visualização.</li>
                    </ul>
                </div>
            </div>
            <button onclick="closeChangelogModal()"
                class="w-full py-3 bg-primary hover:bg-primary-dark text-white rounded-xl font-bold shadow-lg shadow-blue-500/30 transition-colors">Entendi!</button>
        </div>
    </div>
    <!-- Validation Warning Modal -->
    <div id="validation-warning-modal"
        class="fixed inset-0 bg-slate-900/60 z-[100] hidden flex items-center justify-center backdrop-blur-sm transition-opacity opacity-0">
        <div class="bg-white rounded-2xl shadow-2xl w-96 transform transition-all opacity-0 scale-95 p-6 text-center">
            <div class="w-16 h-16 bg-red-100 rounded-full flex items-center justify-center mx-auto mb-4">
                <i class="fa-solid fa-triangle-exclamation text-red-500 text-2xl"></i>
            </div>
            <h3 class="font-bold text-lg text-slate-800 mb-2">Campos Incompletos</h3>
            <p class="text-sm text-slate-500 mb-6">Por favor, preencha todos os campos obrigatórios antes de salvar.</p>
            <button onclick="closeValidationModal()"
                class="w-full py-2.5 bg-slate-800 text-white rounded-xl font-bold hover:bg-slate-700 transition-colors">Entendido</button>
        </div>
    </div>

    <script>
        // Initialize Save on Enter for static modals
        document.addEventListener('DOMContentLoaded', () => {
            // Proventos Modal
            // We need to wait for functions to be defined if this script runs early? 
            // Usually this is at end of body so functions are ready.
            if (window.setupSaveOnEnter) {
                // Proventos
                window.setupSaveOnEnter('proventos-modal', window.saveProvento);
                // Liquidation
                window.setupSaveOnEnter('liquidation-modal', window.confirmLiquidation);
                // Goal
                window.setupSaveOnEnter('goal-modal', window.saveGoal);
                // Update Balances - this uses 'input' on fields but the save button is "Confirmar/Salvar"
                // Actually update balances is a list of inputs.
                window.setupSaveOnEnter('update-balances-content', window.saveUpdatedBalances);
            }
        });
    </script>
    <!-- Settings Modal -->
    <div id="settings-modal"
        class="fixed inset-0 bg-slate-900/60 z-[90] hidden flex items-center justify-center backdrop-blur-sm transition-opacity opacity-0">
        <div id="settings-modal-content"
            class="bg-white rounded-2xl shadow-2xl w-96 transform transition-all opacity-0 scale-95 p-6">
            <div class="flex justify-between items-center mb-6">
                <h3 class="font-bold text-lg text-slate-800">Configurações</h3>
                <button onclick="closeSettingsModal()" class="text-slate-400 hover:text-slate-600"><i
                        class="fa-solid fa-xmark text-xl"></i></button>
            </div>

            <div class="space-y-4">
                <div
                    class="flex items-center justify-between p-3 bg-slate-50 dark:bg-slate-700/50 rounded-xl border border-slate-100 dark:border-slate-600">
                    <div class="flex items-center gap-3">
                        <div
                            class="w-8 h-8 rounded-full bg-red-100 dark:bg-red-900/30 flex items-center justify-center text-red-500 dark:text-red-400">
                            <i class="fa-solid fa-triangle-exclamation text-xs"></i>
                        </div>
                        <div>
                            <p class="text-sm font-bold text-slate-700 dark:text-slate-200">Alerta de Validação</p>
                            <p class="text-[10px] text-slate-500 dark:text-slate-400">Exibir aviso ao salvar incompletos
                            </p>
                        </div>
                    </div>
                    <label class="relative inline-flex items-center cursor-pointer">
                        <input type="checkbox" id="setting-validation-check" class="sr-only peer"
                            onchange="window.toggleValidationSetting(this.checked)">
                        <div
                            class="w-9 h-5 bg-slate-200 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-4 after:w-4 after:transition-all peer-checked:bg-primary">
                        </div>
                    </label>
                </div>

                <div
                    class="flex items-center justify-between p-3 bg-slate-50 dark:bg-slate-700/50 rounded-xl border border-slate-100 dark:border-slate-600">
                    <div class="flex items-center gap-3">
                        <div
                            class="w-8 h-8 rounded-full bg-slate-200 dark:bg-slate-700 flex items-center justify-center text-slate-500 dark:text-slate-400">
                            <i class="fa-solid fa-moon text-xs"></i>
                        </div>
                        <div>
                            <p class="text-sm font-bold text-slate-700 dark:text-slate-200 flex items-center">Modo
                                Escuro <span
                                    class="px-1.5 py-0.5 rounded text-[10px] font-bold bg-blue-100 text-blue-700 dark:bg-blue-900/30 dark:text-blue-400 ml-2">BETA</span>
                            </p>
                            <p class="text-[10px] text-slate-500 dark:text-slate-400">Alterar tema do aplicativo</p>
                        </div>
                    </div>
                    <label class="relative inline-flex items-center cursor-pointer">
                        <input type="checkbox" id="setting-dark-mode-check" class="sr-only peer"
                            onchange="window.toggleDarkMode(this.checked)">
                        <div
                            class="w-9 h-5 bg-slate-200 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-4 after:w-4 after:transition-all peer-checked:bg-primary">
                        </div>
                    </label>
                </div>
            </div>

            <div class="mt-6 pt-4 border-t border-slate-100 dark:border-slate-700 space-y-3">
                <button onclick="window.migrateAncientData()" id="btn-migrate-data"
                    class="w-full py-3 bg-indigo-50 hover:bg-indigo-100 text-indigo-600 dark:bg-indigo-900/20 dark:hover:bg-indigo-900/40 dark:text-indigo-300 rounded-xl font-bold flex items-center justify-center gap-2 transition-colors">
                    <i class="fa-solid fa-cloud-arrow-up"></i> Migrar Dados Antigos
                </button>
                <button onclick="window.handleLogout()"
                    class="w-full py-3 bg-red-50 hover:bg-red-100 text-red-500 dark:bg-red-900/20 dark:hover:bg-red-900/40 dark:text-red-400 rounded-xl font-bold flex items-center justify-center gap-2 transition-colors">
                    <i class="fa-solid fa-right-from-bracket"></i> Sair da Conta
                </button>
                <div class="text-center pt-2">
                    <p class="text-[10px] text-slate-400">Preferências locais salvas no navegador</p>
                </div>
            </div>
        </div>
    </div> <!-- Close settings-modal here -->
    <div id="login-overlay"
        class="fixed inset-0 bg-slate-900 z-[200] flex flex-col items-center justify-center transition-opacity duration-500">
        <div class="text-center slide-in-bottom">
            <div
                class="w-24 h-24 bg-white rounded-2xl flex items-center justify-center shadow-2xl shadow-blue-500/20 mx-auto mb-8 overflow-hidden">
                <img src="logo.png" alt="Logo" class="w-full h-full object-cover">
            </div>
            <h1 class="text-3xl font-bold text-white mb-2">Meus Investimentos</h1>
            <p class="text-slate-400 mb-12">Seu portfólio inteligente em qualquer lugar.</p>

            <button onclick="window.handleGoogleLogin()"
                class="group relative bg-white hover:bg-slate-50 text-slate-800 font-bold py-3.5 px-8 rounded-xl shadow-xl hover:shadow-2xl hover:shadow-blue-500/20 transition-all flex items-center gap-3 mx-auto transform active:scale-95">
                <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" class="w-5 h-5">
                <span>Entrar com Google</span>
                <div
                    class="absolute inset-0 rounded-xl ring-2 ring-white/50 group-hover:ring-4 group-hover:ring-blue-500/30 transition-all">
                </div>
            </button>
            <p class="text-xs text-slate-600 mt-8">Protegido pelo Google Firebase</p>
        </div>
    </div>
    <script>
        // Separate function to be accessible globally
        window.handleGoogleLogin = () => {
            if (window.loginWithGoogle) window.loginWithGoogle();
        }
    </script>
</body>

<script>
    // --- Restored UI Functions ---
    window.navigateTo = (viewId) => {
        document.querySelectorAll('[id^="view-"]').forEach(el => el.classList.add('hidden'));
        const target = document.getElementById('view-' + viewId);
        if (target) target.classList.remove('hidden');

        document.querySelectorAll('.sidebar-link').forEach(el => {
            el.classList.remove('active', 'bg-slate-50', 'text-primary');
            el.classList.add('text-slate-500');
        });
        const activeLink = document.getElementById('nav-' + viewId);
        if (activeLink) {
            activeLink.classList.add('active', 'bg-slate-50', 'text-primary');
            activeLink.classList.remove('text-slate-500');
        }

        // Update Context Global
        if (typeof currentContext !== 'undefined') currentContext = viewId;

        // Mobile Sidebar handling
        const sidebarOverlay = document.getElementById('sidebar-overlay');
        const sidebar = document.getElementById('main-sidebar');
        if (sidebarOverlay) sidebarOverlay.classList.add('hidden');
        if (sidebar) {
            sidebar.classList.add('hidden');
            sidebar.classList.remove('flex');
        }

        // Render Triggers
        if (viewId === 'dashboard' && window.renderDashboard) renderDashboard();
        if (viewId === 'renda-variavel' && window.renderRendaVariavel) renderRendaVariavel();
        if (viewId === 'rebalanceamento' && window.renderRebalanceamento) renderRebalanceamento();
        if (viewId === 'historico' && window.renderHistorico) renderHistorico();
        if (viewId === 'proventos' && window.renderProventos) renderProventos();
        if (viewId === 'reserva' && window.renderReserva) renderReserva();
        if (viewId === 'renda-fixa' && window.renderRendaFixa) renderRendaFixa();
        if (viewId === 'tesouro' && window.renderTesouro) renderTesouro();
    };

    window.toggleSidebar = () => {
        const overlay = document.getElementById('sidebar-overlay');
        const sidebar = document.getElementById('main-sidebar');
        if (sidebar.classList.contains('hidden')) {
            sidebar.classList.remove('hidden');
            sidebar.classList.add('flex');
            overlay.classList.remove('hidden');
        } else {
            sidebar.classList.add('hidden');
            sidebar.classList.remove('flex');
            overlay.classList.add('hidden');
        }
    };

    window.openSettingsModal = () => {
        const modal = document.getElementById('settings-modal');
        if (modal) {
            modal.classList.remove('hidden');
            setTimeout(() => {
                modal.classList.remove('opacity-0');
                const content = document.getElementById('settings-modal-content');
                if (content) content.classList.remove('opacity-0', 'scale-95');
            }, 10);
        }
    };

    window.closeSettingsModal = () => {
        const modal = document.getElementById('settings-modal');
        if (modal) {
            const content = document.getElementById('settings-modal-content');
            if (content) content.classList.add('opacity-0', 'scale-95');
            modal.classList.add('opacity-0');
            setTimeout(() => modal.classList.add('hidden'), 300);
        }
    };

    window.toggleValidationSetting = (checked) => {
        window.enableValidation = checked;
    };

    // --- Dark Mode Logic ---
    window.toggleDarkMode = (enabled) => {
        const html = document.documentElement;
        if (enabled) {
            html.classList.add('dark');
            localStorage.setItem('theme', 'dark');
        } else {
            html.classList.remove('dark');
            localStorage.setItem('theme', 'light');
        }
        // Update charts if present (optional, but good for dynamic switches)
        if (window.renderBondLadder) window.renderBondLadder();
        if (window.renderIndexerChart) window.renderIndexerChart();
        if (window.renderProventosCharts) window.renderProventosCharts();
    };

    // Initialize Theme
    (function () {
        const theme = localStorage.getItem('theme');
        const isDark = theme === 'dark';

        if (isDark) {
            document.documentElement.classList.add('dark');
        } else {
            document.documentElement.classList.remove('dark');
        }

        const chk = document.getElementById('setting-dark-mode-check');
        if (chk) chk.checked = isDark;
    })();
</script>

</html>